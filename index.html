<<<<<<< HEAD
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=980">
  <title>Funferp MVP Demo</title>
  <style>
  /* Reset + fonte */
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:"Segoe UI", Roboto, Arial, sans-serif;
    background:#f9fafb; color:#1f2937; line-height:1.55;
    padding:24px;
  }

  /* Layout geral */
  main{max-width:1100px;margin:0 auto}
  header{max-width:1100px;margin:0 auto 18px}
  header h1{font-size:28px;font-weight:700;margin-bottom:6px}
  header .muted{color:#6b7280;font-size:14px}

  /* Navega√ß√£o (abas) */
  nav{
    display:flex; flex-wrap:wrap; gap:10px;
    max-width:1100px; margin:14px auto 22px;
  }
  nav button{
    border:0; border-radius:10px; padding:10px 14px;
    background:#e5e7eb; color:#111827; font-weight:600;
    box-shadow:0 1px 0 rgba(0,0,0,.04);
    cursor:pointer; transition:transform .04s ease, background .15s ease;
  }
  nav button:hover{transform:translateY(-1px)}
  nav button.active{background:#2563eb;color:#fff}

  /* Cart√µes */
  .card{
    background:#fff; border-radius:12px; padding:16px;
    box-shadow:0 1px 3px rgba(0,0,0,.08);
    margin-bottom:18px;
  }
  .card h3{margin-bottom:10px;color:#111827}

  /* Tipografia de se√ß√µes */
  section.tab h2{margin:6px 0 12px;font-size:22px}
  .muted{color:#9ca3af}
  .hide{display:none}

  /* Forms */
  label{display:block;margin:8px 0 4px;font-weight:600;color:#374151}
  input[type="text"], input[type="number"], input[type="date"], select, input[placeholder]{
    width:100%; max-width:360px;
    border:1px solid #d1d5db; border-radius:8px; padding:8px 10px;
    background:#fff; color:#111827;
  }
  input::placeholder{color:#9ca3af}
  input[type="checkbox"]{transform:scale(1.1);margin-right:6px}

  /* Bot√µes */
  button{
    border:0; border-radius:8px; padding:8px 12px; font-weight:600;
    background:#2563eb; color:#fff; cursor:pointer; margin-right:6px; margin-top:8px;
  }
  button.secondary{background:#6b7280}
  button.warning{background:#f59e0b}
  button:disabled{opacity:.6;cursor:not-allowed}

  /* Tabelas */
  table{width:100%; border-collapse:collapse; margin-top:10px}
  thead{background:#f3f4f6}
  th,td{padding:8px 10px; border:1px solid #e5e7eb; text-align:left; font-size:14px}
  tbody tr:hover{background:#fafafa}

  /* Mensagens */
  .msg{margin-top:8px;font-size:14px}
  .msg.ok{color:#059669}
  .msg.err{color:#dc2626}

  /* Footer */
  footer{max-width:1100px;margin:26px auto 0;text-align:center;color:#6b7280;font-size:13px}

  /* √çcones/emojis ficam do mesmo tamanho do texto */
  nav button, li{display:inline-flex; align-items:center; gap:6px}
</style>

</head>
<body>

<header>
  <h1>Funferp ERP - Modo Demo</h1>
  <p class="muted">üí° Este √© um ambiente de demonstra√ß√£o. Os dados s√£o tempor√°rios e ser√£o apagados ao atualizar a p√°gina (F5).</p>
</header>

<nav>
  <button data-tab="home">üè† In√≠cio</button>
  <button data-tab="cadastros">üì¶ Cadastros</button>
  <button data-tab="estoque">üìä Estoque</button>
  <button data-tab="financeiro">üí∞ Financeiro</button>
  <button data-tab="relatorios">üìà Relat√≥rios</button>
</nav>

<main id="appArea">

  
  <section id="home" class="tab">
    <h2>Bem-vindo(a) ao Demo!</h2>
    <p>Neste modo, voc√™ pode testar todas as funcionalidades: cadastrar, vender, pagar, gerar relat√≥rios, etc. Os dados n√£o s√£o salvos em banco.</p>
    <ul>
      <li>üìù Cadastre fornecedores, contas e produtos</li>
      <li>üí∏ Registre pagamentos e vendas</li>
      <li>üìë Gere relat√≥rios completos</li>
      <li>‚ôªÔ∏è Ao atualizar a p√°gina, os dados voltam ao estado inicial</li>
    </ul>
  </section>

  
  <section id="cadastros" class="tab hide">
    <h2>Cadastros</h2>

    <div class="card">
      <h3>Insumos</h3>
      <label>Nome: <input id="iNome" placeholder="Ex: Queijo Mussarela"></label>
      <label>Unidade: 
        <select id="iUni">
          <option value="">Selecione...</option>
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="un">un</option>
          <option value="ml">ml</option>
          <option value="l">l</option>
        </select>
      </label>
      <label><input type="checkbox" id="iVend"> Vend√≠vel</label>
      <button id="btnAddInsumo">Salvar</button>
      <button id="btnListInsumo">Listar</button>
      <div id="msgInsumo" class="msg"></div>
      <table id="tblInsumos">
        <thead><tr><th>ID</th><th>Nome</th><th>Unidade</th><th>Vend√≠vel</th></tr></thead>
        <tbody><tr><td colspan="4" class="muted">(vazio)</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Produtos</h3>
      <label>Nome: <input id="pNome" placeholder="Ex: X-Burger"></label>
      <label>√â preparado? 
        <select id="pPrep">
          <option value="">Selecione...</option>
          <option value="true">Sim</option>
          <option value="false">N√£o</option>
        </select>
      </label>
      <div id="inline-ficha" class="hide">
        <p class="muted">Ap√≥s salvar, defina a ficha t√©cnica abaixo.</p>
      </div>
      <button id="btnAddProd">Salvar</button>
      <button id="btnListProd">Listar</button>
      <div id="msgProd" class="msg"></div>
      <table id="tblProdutos">
        <thead><tr><th>ID</th><th>Nome</th><th>Preparado</th></tr></thead>
        <tbody><tr><td colspan="3" class="muted">(vazio)</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Ficha T√©cnica</h3>
      <label>Produto: 
        <select id="fpProd"></select>
      </label>
      <button id="fpBtnVer">Ver Ficha</button>
      <table id="fpTbl">
        <thead><tr><th>ID</th><th>Insumo</th><th>Qtd</th><th>Unidade</th></tr></thead>
        <tbody><tr><td colspan="4" class="muted">(vazio)</td></tr></tbody>
      </table>

      <h4>Adicionar Linha</h4>
      <label>Insumo: <select class="fpLinhaIns"></select></label>
      <label>Qtd: <input class="fpLinhaQtd" type="number" step="0.01"></label>
      <label>Unidade: 
        <select class="fpLinhaUn">
          <option value="">Selecione...</option>
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="un">un</option>
          <option value="ml">ml</option>
          <option value="l">l</option>
        </select>
      </label>
      <button id="fpBtnAddLinha">+ Adicionar linha</button>
      <table id="fpTblLinhas">
        <thead><tr><th>#</th><th>Insumo</th><th>Qtd</th><th>Un</th><th></th></tr></thead>
        <tbody><tr><td colspan="5" class="muted">(vazio)</td></tr></tbody>
      </table>
      <button id="fpBtnSalvar">Salvar Ficha</button>
      <div id="fpMsg" class="msg"></div>
    </div>
  </section>

  
  <section id="estoque" class="tab hide">
    <h2>Estoque</h2>

    <div class="card">
      <h3>Entrada de Estoque</h3>
      <label>Insumo: <select id="eIns"></select></label>
      <label>Qtd: <input id="eQtd" type="number" step="0.01"></label>
      <label>Custo Total: <input id="eCusto" type="number" step="0.01"></label>
      <button id="btnEntrada">Registrar Entrada</button>
      <div id="msgEnt" class="msg"></div>
    </div>

    <div class="card">
      <h3>Ajuste de Estoque</h3>
      <label>Insumo: <select id="aIns"></select></label>
      <label>Qtd (ex: -1): <input id="aQtd" type="number" step="0.01"></label>
      <label>Motivo: <input id="aMot" placeholder="Ex: quebra"></label>
      <label>Custo Unit√°rio (opcional): <input id="aCusto" type="number" step="0.01"></label>
      <button id="btnAjuste">Aplicar Ajuste</button>
      <div id="msgAj" class="msg"></div>
    </div>
    <div class="card">
      <h3>Convers√µes</h3>
      <label>Insumo: <select id="convIns"></select></label>
      <label>De: <input id="convFrom" placeholder="Ex: kg"></label>
      <label>Para: <input id="convTo" placeholder="Ex: g"></label>
      <label>Fator: <input id="convFactor" type="number" step="0.0001" placeholder="Ex: 1000"></label>
      <button id="btnConvAdd">Adicionar Convers√£o</button>
      <button id="btnConvList">Listar</button>
      <div id="msgConv" class="msg"></div>
      <table id="tblConv">
        <thead><tr><th>De</th><th>Para</th><th>Fator</th></tr></thead>
        <tbody><tr><td colspan="3" class="muted">(vazio)</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Saldos</h3>
      <button id="btnSaldos">Atualizar Saldos</button>
      <table id="tblSaldos">
        <thead><tr><th>Insumo</th><th>Unidade</th><th>Saldo</th><th>Custo M√©dio</th></tr></thead>
        <tbody><tr><td colspan="4" class="muted">(vazio)</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Exportar Estoque CSV (BR)</h3>
      <button id="btnEstoqueMediaCSV">Exportar</button>
    </div>

  </section>

  
  <section id="financeiro" class="tab hide">
    <h2>Financeiro</h2>

    <div class="card">
      <h3>Fornecedores</h3>
      <label>Nome: <input id="fForNome" placeholder="Ex: Supermercado Central"></label>
      <label>Documento: <input id="fForDoc" placeholder="CNPJ/CPF"></label>
      <button id="btnAddForn">Salvar</button>
      <button id="btnListForn">Listar</button>
      <div id="msgForn" class="msg"></div>
      <table id="tblForns">
        <thead><tr><th>ID</th><th>Nome</th><th>Documento</th></tr></thead>
        <tbody><tr><td colspan="3" class="muted">(vazio)</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Tipos de Despesa</h3>
      <label>Nome: <input id="fTipoNome" placeholder="Ex: Energia el√©trica"></label>
      <button id="btnAddTipo">Salvar</button>
      <button id="btnListTipo">Listar</button>
      <div id="msgTipo" class="msg"></div>
      <table id="tblTipos">
        <thead><tr><th>ID</th><th>Nome</th></tr></thead>
        <tbody><tr><td colspan="2" class="muted">(vazio)</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Contas</h3>
      <label>Nome: <input id="fContaNome" placeholder="Ex: Caixa Principal"></label>
      <label>Tipo: 
        <select id="fContaTipo">
          <option value="caixa">Caixa</option>
          <option value="banco">Banco</option>
          <option value="cart√£o">Cart√£o</option>
        </select>
      </label>
      <button id="btnAddConta">Salvar</button>
      <button id="btnListConta">Listar</button>
      <div id="msgConta" class="msg"></div>
      <table id="tblContas">
        <thead><tr><th>ID</th><th>Nome</th><th>Tipo</th></tr></thead>
        <tbody><tr><td colspan="3" class="muted">(vazio)</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Pagamentos</h3>
      <label>Fornecedor: <select id="pForn"></select></label>
      <label>Tipo: <select id="pTipo"></select></label>
      <label>Conta: <select id="pConta"></select></label>
      <label>Valor: <input id="pValor" type="number" step="0.01"></label>
      <label>Data: <input id="pData" placeholder="DD/MM/AAAA"></label>
      <label>Observa√ß√£o: <input id="pObs"></label>
      <button id="btnAddPgto">Salvar</button>
      <button id="btnListPgto">Listar</button>
      <div id="msgPgto" class="msg"></div>
      <table id="tblPgto">
        <thead><tr><th>ID</th><th>Data</th><th>Fornecedor</th><th>Tipo</th><th>Conta</th><th>Valor</th><th>Obs</th></tr></thead>
        <tbody><tr><td colspan="7" class="muted">(vazio)</td></tr></tbody>
      </table>
      <button id="btnPagamentosCSV">Exportar CSV-BR</button>
    </div>
  </section>

  
  <section id="relatorios" class="tab hide">
    <h2>Relat√≥rios</h2>

    <div class="card">
      <h3>Relat√≥rio de Estoque</h3>
      <button id="btnRelEst">Gerar</button>
      <table id="tblRelEst">
        <thead><tr><th>Insumo</th><th>Unidade</th><th>Saldo</th><th>Custo M√©dio</th></tr></thead>
        <tbody><tr><td colspan="4" class="muted">(vazio)</td></tr></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Relat√≥rio de Vendas</h3>
      <label>Data inicial: <input id="rvIni" placeholder="DD/MM/AAAA"></label>
      <label>Data final: <input id="rvFim" placeholder="DD/MM/AAAA"></label>
      <button id="btnRelV">Gerar</button>
      <table id="tblVendas">
        <thead>
          <tr>
            <th>ID</th><th>Data</th><th>Produto</th><th>Pre√ßo</th>
            <th>Qtd</th><th>Tipo</th><th>Coment√°rio</th><th>Pgto</th>
            <th>Cancelada</th><th>Consumo</th><th></th>
          </tr>
        </thead>
        <tbody><tr><td colspan="11" class="muted">(vazio)</td></tr></tbody>
      </table>
      <button id="btnVendasCSVBR">Exportar CSV-BR</button>
    </div>

    <div class="card">
      <h3>Relat√≥rio de Movimenta√ß√µes</h3>
      <label>Data inicial: <input id="rmi" placeholder="DD/MM/AAAA"></label>
      <label>Data final: <input id="rmf" placeholder="DD/MM/AAAA"></label>
      <button id="btnRelMov">Gerar</button>
      <table id="tblRelMov">
        <thead>
          <tr>
            <th>ID</th><th>Data</th><th>Insumo</th><th>Qtd</th>
            <th>Un</th><th>Custo</th><th>Origem</th><th>Tipo</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="8" class="muted">(vazio)</td></tr></tbody>
      </table>
    </div>
  </section>

</main>

<footer>
  <p>¬© 2025 Funferp Demo | Dados n√£o persistentes (modo de demonstra√ß√£o)</p>
</footer>

<script>
"use strict";


const ROLE = "admin"; // acesso total
const BACK = null; // sem backend real

// headers e utilit√°rios
function authHeaders(){ return {}; }
function setMsg(el, txt, ok){ el.textContent=txt; el.className=ok?"msg ok":"msg err"; }
function $(sel){ return document.querySelector(sel); }
function $all(sel){ return document.querySelectorAll(sel); }

// convers√µes e formata√ß√µes
function isoToBr(iso){ if(!iso) return ""; const [y,m,d]=iso.split("-"); return `${d}/${m}/${y}`; }
function brToIso(br){ const [d,m,y]=br.split("/"); return `${y}-${m}-${d}`; }
const brMoney=new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"});
const brQty2=new Intl.NumberFormat("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
const brQty3=new Intl.NumberFormat("pt-BR",{minimumFractionDigits:3,maximumFractionDigits:3});

const DB = {
  seq: { insumo:1, produto:1, mov:1 },
  insumos: [],                 // {id,nome,unidade,vendivel}
  produtos: [],                // {id,nome,preparado}
  ficha: {},                   // { [produto_id]: [ {insumo_id,quantidade,unidade} ] }
  estoque: {},                 // { [insumo_id]: { saldo:number, custoMedio:number } }
  _convs: {},                  // { [insumo_id]: [ {de_unidade, para_unidade, fator} ] }
  movs: []                     // {id,dataISO,insumo_id,insumo_nome,quantidade,unidade,custo_total,origem,tipo}
};

function todayISO(){ return new Date().toISOString(); }
function ensureEstoque(id){ return (DB.estoque[id] ||= { saldo:0, custoMedio:0 }); }
function findInsumo(id){ return DB.insumos.find(i => i.id === id) || null; }
function addMov(m){
  m.id = DB.seq.mov++;
  DB.movs.push(m);
}


(function seedDemoMinimo(){
  // Descomente para popular rapidamente
  /*
  addInsumo("Carne Bovina", "kg", false);
  addInsumo("Refrigerante Lata", "un", true);
  addInsumo("Arroz", "kg", false);
  addProduto("Prato Executivo", true);
  */
})();


function addInsumo(nome, unidade, vendivel=false){
  const id = DB.seq.insumo++;
  DB.insumos.push({ id, nome, unidade, vendivel: !!vendivel });
  refreshInsumoSelects();
  return id;
}
function addProduto(nome, preparado=false){
  const id = DB.seq.produto++;
  DB.produtos.push({ id, nome, preparado: !!preparado });
  return id;
}

function refreshInsumoSelects(){
  // Convers√µes
  const opts = [`<option value="">Selecione‚Ä¶</option>`]
    .concat(DB.insumos.map(i => `<option value="${i.id}">${i.id} - ${i.nome} (${i.unidade})</option>`));
  const convIns = $("#convIns");
  if (convIns) convIns.innerHTML = opts.join("");
}


function listConversoes(){
  const insumo_id = parseInt($("#convIns")?.value || "0", 10);
  const tbody = $("#tblConv tbody");
  if (!insumo_id) {
    tbody.innerHTML = `<tr><td colspan="3" class="muted">Selecione um insumo.</td></tr>`;
    return;
  }
  const arr = (DB._convs[insumo_id] || []);
  if (!arr.length) {
    tbody.innerHTML = `<tr><td colspan="3" class="muted">(vazio)</td></tr>`;
    return;
  }
  tbody.innerHTML = arr.map(c =>
    `<tr><td>${c.de_unidade}</td><td>${c.para_unidade}</td><td>${brQty3.format(+c.fator)}</td></tr>`
  ).join("");
}

function saveConversao(){
  const insumo_id = parseInt($("#convIns")?.value || "0", 10);
  const de_unidade = ($("#convFrom")?.value || "").trim();
  const para_unidade = ($("#convTo")?.value || "").trim();
  const fator = parseFloat($("#convFactor")?.value || "0");
  const msg = $("#msgConv");

  if (!insumo_id || !de_unidade || !para_unidade || !(fator > 0)) {
    setMsg(msg, "Preencha insumo, de, para e fator > 0.", false);
    return;
  }

  const arr = (DB._convs[insumo_id] ||= []);
  const ix = arr.findIndex(c => c.de_unidade === de_unidade && c.para_unidade === para_unidade);
  if (ix >= 0) arr[ix].fator = +fator; else arr.push({ de_unidade, para_unidade, fator:+fator });

  setMsg(msg, "Convers√£o salva!", true);
  $("#convFactor").value = "";
  listConversoes();
}

// Bind dos bot√µes de convers√£o
$("#btnConvAdd")?.addEventListener("click", saveConversao);
$("#btnConvList")?.addEventListener("click", listConversoes);


function saldosMedia(){
  
  return DB.insumos.map(ins => {
    const st = DB.estoque[ins.id] || { saldo:0, custoMedio:0 };
    return {
      insumo_id: ins.id,
      insumo_nome: ins.nome,
      unidade: ins.unidade,
      saldo: +st.saldo,
      custo_medio: +st.custoMedio
    };
  });
}

// Render + bot√£o "Atualizar"
function loadSaldos(){
  const data = saldosMedia();
  const tbody = $("#tblSaldos tbody");
  if (!tbody) return;

  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="4" class="muted">(vazio)</td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(x => `
    <tr>
      <td>${x.insumo_nome}</td>
      <td>${x.unidade}</td>
      <td>${brQty3.format(+x.saldo)}</td>
      <td>${brMoney.format(+(x.custo_medio||0))}</td>
    </tr>
  `).join("");
}

$("#btnSaldos")?.addEventListener("click", loadSaldos);



function entradaMedia({ insumo_id, quantidade, custo_total }){
  const e = ensureEstoque(insumo_id);
  const qtd = +quantidade;
  const somaAnt = e.saldo * e.custoMedio;
  e.saldo += qtd;
  e.custoMedio = e.saldo > 0 ? (somaAnt + (+custo_total)) / e.saldo : 0;

  const ins = findInsumo(insumo_id);
  addMov({
    dataISO: todayISO(),
    insumo_id,
    insumo_nome: ins?.nome || "",
    quantidade: +qtd,
    unidade: ins?.unidade || "",
    custo_total: +custo_total,
    origem: "entrada",
    tipo: "entrada-media"
  });
}

function ajusteMedia({ insumo_id, quantidade, motivo, custo_unitario }){
  const e = ensureEstoque(insumo_id);
  const qtd = +quantidade;
  if (typeof custo_unitario === "number" && !Number.isNaN(custo_unitario)) {
    e.custoMedio = +custo_unitario;
  }
  e.saldo += qtd;

  const ins = findInsumo(insumo_id);
  addMov({
    dataISO: todayISO(),
    insumo_id,
    insumo_nome: ins?.nome || "",
    quantidade: +qtd,
    unidade: ins?.unidade || "",
    custo_total: 0,
    origem: motivo || "ajuste",
    tipo: "ajuste-media"
  });
}


document.addEventListener("DOMContentLoaded", () => {
  refreshInsumoSelects(); // popula selects de insumos (convers√µes)
  // se houver dados seed, j√° renderiza
  listConversoes();
  loadSaldos();
});


// Garante campos extras do DB (caso n√£o existam ainda)
DB.vendas       ||= [];   // {venda_id,data,produto_nome,preco_venda,quantidade,tipo,comentario,forma_pagamento,cancelada,consumos:[...]}
DB.seq.venda    ||= 1;
DB.formas       ||= ["dinheiro","pix","debito","credito","voucher","outro"];

DB.fornecedores ||= [];  // {id,nome,documento}
DB.tipos        ||= [];  // {id,nome}
DB.contas       ||= [];  // {id,nome,tipo}
DB.pagamentos   ||= [];  // {id,dataISO,fornecedor_id,tipo_id,conta_id,valor,observacao}
DB.seq.forn     ||= 1;
DB.seq.tipo     ||= 1;
DB.seq.conta    ||= 1;
DB.seq.pgto     ||= 1;

// ----------------------- Relat√≥rios locais (consulta de dados) -----------------------
function relVendasLocal({ start, end } = {}){
  const ini = start ? new Date(start+"T00:00:00") : null;
  const fim = end   ? new Date(end+"T23:59:59")  : null;
  const out = [];
  for (const v of DB.vendas) {
    const d = new Date(v.data);
    if (ini && d < ini) continue;
    if (fim && d > fim) continue;

    if (!v.consumos || !v.consumos.length) {
      out.push({
        venda_id: v.venda_id, data: v.data, produto_nome: v.produto_nome,
        preco_venda: v.preco_venda, quantidade: v.quantidade, tipo: v.tipo,
        comentario: v.comentario, forma_pagamento: v.forma_pagamento, cancelada: v.cancelada,
        insumo_nome: "", consumo_base: "", unidade_base: ""
      });
    } else {
      for (const c of v.consumos) {
        out.push({
          venda_id: v.venda_id, data: v.data, produto_nome: v.produto_nome,
          preco_venda: v.preco_venda, quantidade: v.quantidade, tipo: v.tipo,
          comentario: v.comentario, forma_pagamento: v.forma_pagamento, cancelada: v.cancelada,
          insumo_nome: c.insumo_nome, consumo_base: c.consumo_base, unidade_base: c.unidade_base
        });
      }
    }
  }
  return out;
}

function listPgtosLocal({ start, end } = {}){
  const ini = start ? new Date(start+"T00:00:00") : null;
  const fim = end   ? new Date(end+"T23:59:59")  : null;
  return DB.pagamentos.filter(p=>{
    const d = new Date(p.dataISO);
    return (!ini || d>=ini) && (!fim || d<=fim);
  }).map(p=>({
    id: p.id,
    data: p.dataISO,
    fornecedor_nome: (DB.fornecedores.find(f=>f.id===p.fornecedor_id)?.nome) || "",
    tipo_nome: (DB.tipos.find(t=>t.id===p.tipo_id)?.nome) || "",
    conta_nome: (DB.contas.find(c=>c.id===p.conta_id)?.nome) || "",
    valor: p.valor,
    observacao: p.observacao || ""
  }));
}

function relPgtosLocal({ start, end } = {}){
  const base = listPgtosLocal({ start, end });
  return base.map(p=>({
    id: p.id,
    data: p.data,
    fornecedor: p.fornecedor_nome,
    tipo: p.tipo_nome,
    conta: p.conta_nome,
    valor: p.valor,
    observacao: p.observacao
  }));
}

// ----------------------- CSV helpers -----------------------
function csvEscapeBR(v){
  const s = String(v ?? "");
  return /[\";\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
}
function downloadCSV(filename, csvText){
  const blob = new Blob([csvText], { type: "text/csv;charset=utf-8" });
  const url  = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// ----------------------- CSV: Estoque (custo m√©dio ‚Äì BR) -----------------------
async function exportEstoqueBR(){
  const data = saldosMedia() || [];
  const headers = ["insumo_id","insumo_nome","unidade","saldo","custo_medio"];
  const sep = ";";
  const rows = data.map(x => [
    x.insumo_id ?? "",
    (x.insumo_nome ?? ""),
    x.unidade ?? "",
    x.saldo ?? 0,
    x.custo_medio ?? 0
  ]);

  const csv = [
    headers.join(sep),
    ...rows.map(rw => rw.map(csvEscapeBR).join(sep))
  ].join("\n");

  downloadCSV("estoque_custo_medio.csv", csv);
}
document.getElementById("btnEstoqueMediaCSV")?.addEventListener("click", exportEstoqueBR);
document.getElementById("btnEstoqueMediaCSV2")?.addEventListener("click", exportEstoqueBR);

// ----------------------- CSV: Vendas (BR) -----------------------
async function exportVendasBR(){
  // Captura per√≠odo de qualquer uma das telas (relat√≥rios ou vendas)
  const viBR = (document.getElementById("rvi")?.value || document.getElementById("rvIni")?.value || "").trim();
  const vfBR = (document.getElementById("rvf")?.value || document.getElementById("rvFim")?.value || "").trim();
  const vi = brToIso(viBR);
  const vf = brToIso(vfBR);

  const data = relVendasLocal({ start: vi || undefined, end: vf || undefined }) || [];
  const headers = ["id","data","produto","preco","quantidade","tipo","comentario","pagamento","cancelada","consumo_insumo","consumo_qtd","consumo_un"];
  const sep = ";";

  const rows = data.map(v => [
    v.venda_id ?? "",
    isoToBr((v.data||"").toString().slice(0,10)),
    (v.produto_nome||""),
    v.preco_venda ?? 0,
    v.quantidade ?? 0,
    v.tipo ?? "",
    (v.comentario||""),
    v.forma_pagamento ?? "",
    v.cancelada ? "SIM" : "N√ÉO",
    v.insumo_nome ?? "",
    v.consumo_base ?? "",
    v.unidade_base ?? ""
  ]);

  const csv = [
    headers.join(sep),
    ...rows.map(rw => rw.map(csvEscapeBR).join(sep))
  ].join("\n");

  downloadCSV("vendas.csv", csv);
}
document.getElementById("btnVendasCSVBR")?.addEventListener("click", exportVendasBR);

// ----------------------- CSV: Pagamentos (BR) -----------------------
async function exportPagamentosBR(){
  const viBR = (document.getElementById("rpi")?.value || document.getElementById("rpIni")?.value || "").trim();
  const vfBR = (document.getElementById("rpf")?.value || document.getElementById("rpFim")?.value || "").trim();
  const vi = brToIso(viBR);
  const vf = brToIso(vfBR);

  const data = relPgtosLocal({ start: vi || undefined, end: vf || undefined }) || [];
  const headers = ["id","data","fornecedor","tipo","conta","valor","observacao"];
  const sep = ";";

  const rows = data.map(p => [
    p.id ?? "",
    isoToBr((p.data||"").toString().slice(0,10)),
    (p.fornecedor||""),
    (p.tipo||""),
    (p.conta||""),
    p.valor ?? 0,
    (p.observacao||"")
  ]);

  const csv = [
    headers.join(sep),
    ...rows.map(rw => rw.map(csvEscapeBR).join(sep))
  ].join("\n");

  downloadCSV("pagamentos.csv", csv);
}
document.getElementById("btnPagamentosCSV")?.addEventListener("click", exportPagamentosBR);
document.getElementById("btnPagamentosCSV2")?.addEventListener("click", exportPagamentosBR);

// ----------------------- Render r√°pido de tabelas de relat√≥rio (opcional) -----------------------
document.getElementById("btnRelEst")?.addEventListener("click", loadSaldos);

document.getElementById("btnRelV")?.addEventListener("click", () => {
  const vi = brToIso((document.getElementById("rvi")?.value||"").trim());
  const vf = brToIso((document.getElementById("rvf")?.value||"").trim());
  const data = relVendasLocal({ start: vi || undefined, end: vf || undefined });
  const tb = document.querySelector("#tblVendas tbody");
  if (!tb) return;
  tb.innerHTML = data.length
    ? data.map(v=>`<tr>
        <td>${v.venda_id}</td>
        <td>${isoToBr((v.data||"").toString().slice(0,10))}</td>
        <td>${(v.produto_nome||"")}</td>
        <td>${brMoney.format(+v.preco_venda||0)}</td>
        <td>${v.forma_pagamento||""}</td>
      </tr>`).join("")
    : `<tr><td colspan="5" class="muted">(vazio)</td></tr>`;
});

document.getElementById("btnRelFinanceiro")?.addEventListener("click", () => {
  const vi = brToIso((document.getElementById("rpi")?.value||"").trim());
  const vf = brToIso((document.getElementById("rpf")?.value||"").trim());
  const data = relPgtosLocal({ start: vi || undefined, end: vf || undefined });
  const tb = document.querySelector("#tblRelPag tbody");
  if (!tb) return;
  tb.innerHTML = data.length
    ? data.map(p=>`<tr>
        <td>${p.id}</td>
        <td>${isoToBr((p.data||"").toString().slice(0,10))}</td>
        <td>${p.fornecedor||""}</td>
        <td>${p.tipo||""}</td>
        <td>${p.conta||""}</td>
        <td>${brMoney.format(+p.valor||0)}</td>
        <td>${p.observacao||""}</td>
      </tr>`).join("")
    : `<tr><td colspan="7" class="muted">(vazio)</td></tr>`;
});


// Garantias de estrutura
DB.fornecedores ||= []; DB.seq.forn  ||= 1;
DB.tipos        ||= []; DB.seq.tipo  ||= 1;
DB.contas       ||= []; DB.seq.conta ||= 1;
DB.pagamentos   ||= []; DB.seq.pgto  ||= 1;

// ---------- Helpers de tabela/select ----------
async function finLoadForns(){
  const data = DB.fornecedores || [];
  const tb   = document.querySelector("#tblForns tbody");
  if (tb) {
    tb.innerHTML = data.length
      ? data.map(f=>`<tr><td>${f.id}</td><td>${f.nome}</td><td>${f.documento||""}</td></tr>`).join("")
      : `<tr><td colspan="3" class="muted">(vazio)</td></tr>`;
  }
  const sel = document.getElementById("pForn");
  if (sel) {
    sel.innerHTML = `<option value="">Selecione‚Ä¶</option>` + data.map(f=>`<option value="${f.id}">${f.id} - ${f.nome}</option>`).join("");
  }
}

async function finLoadTipos(){
  const data = DB.tipos || [];
  const tb   = document.querySelector("#tblTipos tbody");
  if (tb) {
    tb.innerHTML = data.length
      ? data.map(t=>`<tr><td>${t.id}</td><td>${t.nome}</td></tr>`).join("")
      : `<tr><td colspan="2" class="muted">(vazio)</td></tr>`;
  }
  const sel = document.getElementById("pTipo");
  if (sel) {
    sel.innerHTML = `<option value="">Selecione‚Ä¶</option>` + data.map(t=>`<option value="${t.id}">${t.id} - ${t.nome}</option>`).join("");
  }
}

async function finLoadContas(){
  const data = DB.contas || [];
  const tb   = document.querySelector("#tblContas tbody");
  if (tb) {
    tb.innerHTML = data.length
      ? data.map(c=>`<tr><td>${c.id}</td><td>${c.nome}</td><td>${c.tipo}</td></tr>`).join("")
      : `<tr><td colspan="3" class="muted">(vazio)</td></tr>`;
  }
  const sel = document.getElementById("pConta");
  if (sel) {
    sel.innerHTML = `<option value="">Selecione‚Ä¶</option>` + data.map(c=>`<option value="${c.id}">${c.id} - ${c.nome} (${c.tipo})</option>`).join("");
  }
}

async function finPopulateSelectors(){
  await Promise.all([finLoadForns(), finLoadTipos(), finLoadContas()]);
}

// ---------- Bot√µes: cadastros financeiros ----------
document.getElementById('btnAddForn')?.addEventListener('click', async () => {
  const nome = (document.getElementById("fForNome")?.value || '').trim();
  const documento = (document.getElementById("fForDoc")?.value || '').trim();
  if (!nome) { setMsg(document.getElementById("msgForn"), "Informe o nome do fornecedor.", false); document.getElementById("fForNome")?.focus(); return; }
  const id = DB.seq.forn++;
  DB.fornecedores.push({ id, nome, documento: documento || null });
  setMsg(document.getElementById("msgForn"), "Fornecedor salvo!", true);
  document.getElementById("fForNome").value = ""; document.getElementById("fForDoc").value = "";
  await finLoadForns();
});

document.getElementById('btnListForn')?.addEventListener('click', () => { finLoadForns(); });

document.getElementById('btnAddTipo')?.addEventListener('click', async () => {
  const nome = (document.getElementById("fTipoNome")?.value || '').trim();
  if (!nome) { setMsg(document.getElementById("msgTipo"), "Informe o nome do tipo.", false); document.getElementById("fTipoNome")?.focus(); return; }
  const id = DB.seq.tipo++;
  DB.tipos.push({ id, nome });
  setMsg(document.getElementById("msgTipo"), "Tipo salvo!", true);
  document.getElementById("fTipoNome").value = "";
  await finLoadTipos();
});

document.getElementById('btnListTipo')?.addEventListener('click', () => { finLoadTipos(); });

document.getElementById('btnAddConta')?.addEventListener('click', async () => {
  const nome = (document.getElementById("fContaNome")?.value || '').trim();
  const tipo = (document.getElementById("fContaTipo")?.value || '').trim();
  if (!nome || !tipo) { setMsg(document.getElementById("msgConta"), "Preencha nome e tipo.", false); document.getElementById("fContaNome")?.focus(); return; }
  const id = DB.seq.conta++;
  DB.contas.push({ id, nome, tipo });
  setMsg(document.getElementById("msgConta"), "Conta salva!", true);
  document.getElementById("fContaNome").value = ""; document.getElementById("fContaTipo").value = "caixa";
  await finLoadContas();
});

document.getElementById('btnListConta')?.addEventListener('click', () => { finLoadContas(); });

// ---------- Pagamentos ‚Äì salvar / listar / relat√≥rio ----------
document.getElementById("btnAddPgto")?.addEventListener("click", async ()=> {
  const fornecedor_id = parseInt((document.getElementById("pForn")?.value||"0"),10);
  const tipo_id       = parseInt((document.getElementById("pTipo")?.value||"0"),10);
  const conta_id      = parseInt((document.getElementById("pConta")?.value||"0"),10);
  const valor         = parseFloat((document.getElementById("pValor")?.value||"0"));
  const dataBr        = (document.getElementById("pData")?.value||"").trim();
  const dataIso       = brToIso(dataBr);
  const observacao    = (document.getElementById("pObs")?.value||"").trim() || null;

  if(!fornecedor_id || !tipo_id || !conta_id || !(valor>0)){
    setMsg(document.getElementById("msgPgto"), "Preencha fornecedor, tipo, conta e valor > 0.", false);
    return;
  }

  const id = DB.seq.pgto++;
  const dataISO = dataIso ? new Date(`${dataIso}T00:00:00`).toISOString() : new Date().toISOString();
  DB.pagamentos.push({ id, fornecedor_id, tipo_id, conta_id, valor:+valor, observacao, dataISO });

  setMsg(document.getElementById("msgPgto"), "Pagamento salvo!", true);
  document.getElementById("pValor").value = "";
  document.getElementById("pData").value  = "";
  document.getElementById("pObs").value   = "";

  await finListPagamentos();
  await finRelPagamentos();
});

document.getElementById("btnListPgto")?.addEventListener("click", finListPagamentos);
async function finListPagamentos(){
  const vi = brToIso((document.getElementById("rpIni")?.value||"").trim());
  const vf = brToIso((document.getElementById("rpFim")?.value||"").trim());
  const tb = document.querySelector("#tblPgto tbody");
  if (!tb) return;

  const data = (DB.pagamentos||[]).filter(p=>{
    const d = new Date(p.dataISO);
    const ini = vi ? new Date(vi+"T00:00:00") : null;
    const fim = vf ? new Date(vf+"T23:59:59") : null;
    return (!ini || d>=ini) && (!fim || d<=fim);
  }).map(p=>({
    id:p.id,
    data:p.dataISO,
    fornecedor_nome:(DB.fornecedores.find(f=>f.id===p.fornecedor_id)?.nome)||"",
    tipo_nome:(DB.tipos.find(t=>t.id===p.tipo_id)?.nome)||"",
    conta_nome:(DB.contas.find(c=>c.id===p.conta_id)?.nome)||"",
    valor:p.valor,
    observacao:p.observacao||""
  }));

  tb.innerHTML = data.length
    ? data.map(p=>`<tr>
        <td>${p.id}</td>
        <td>${isoToBr((p.data||"").toString().slice(0,10))}</td>
        <td>${p.fornecedor_nome||""}</td>
        <td>${p.tipo_nome||""}</td>
        <td>${p.conta_nome||""}</td>
        <td>${brMoney.format(+p.valor||0)}</td>
        <td>${p.observacao||""}</td>
      </tr>`).join("")
    : `<tr><td colspan="7" class="muted">(vazio)</td></tr>`;
}

document.getElementById("btnRelFinanceiro")?.addEventListener("click", finRelPagamentos);
async function finRelPagamentos(){
  const vi = brToIso((document.getElementById("rpi")?.value || "").trim());
  const vf = brToIso((document.getElementById("rpf")?.value || "").trim());
  const tb = document.querySelector("#tblRelPag tbody");
  if (!tb) return;

  const ini = vi ? new Date(vi+"T00:00:00") : null;
  const fim = vf ? new Date(vf+"T23:59:59") : null;

  const data = (DB.pagamentos||[]).filter(p=>{
    const d = new Date(p.dataISO);
    return (!ini || d>=ini) && (!fim || d<=fim);
  }).map(p=>({
    id:p.id,
    data:p.dataISO,
    fornecedor:(DB.fornecedores.find(f=>f.id===p.fornecedor_id)?.nome)||"",
    tipo:(DB.tipos.find(t=>t.id===p.tipo_id)?.nome)||"",
    conta:(DB.contas.find(c=>c.id===p.conta_id)?.nome)||"",
    valor:p.valor,
    observacao:p.observacao||""
  }));

  tb.innerHTML = data.length
    ? data.map(p=>`<tr>
        <td>${p.id}</td>
        <td>${isoToBr((p.data||"").toString().slice(0,10))}</td>
        <td>${p.fornecedor||""}</td>
        <td>${p.tipo||""}</td>
        <td>${p.conta||""}</td>
        <td>${brMoney.format(+p.valor||0)}</td>
        <td>${p.observacao||""}</td>
      </tr>`).join("")
    : `<tr><td colspan="7" class="muted">(vazio)</td></tr>`;
}


// (Opcional) popular selects ao carregar este bloco
finPopulateSelectors?.();

</script>

<script>
 //Navega√ß√£o por abas (usa seu <nav> e as <section class="tab">)
document.querySelectorAll('nav button[data-tab]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const t = btn.getAttribute('data-tab');
    document.querySelectorAll('main .tab').forEach(sec=>sec.classList.add('hide'));
    document.getElementById(t)?.classList.remove('hide');
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});

document.addEventListener("DOMContentLoaded", () => {
  // Deixa "In√≠cio" vis√≠vel ao carregar
  document.querySelector('nav button[data-tab="home"]')?.click();

  // Preenche selects, listas e saldos j√° existentes no seu c√≥digo
  // (essas fun√ß√µes j√° est√£o definidas nos blocos anteriores)
  try { refreshInsumoSelects?.(); } catch {}
  try { listConversoes?.(); } catch {}
  try { loadSaldos?.(); } catch {}
  try { finPopulateSelectors?.(); } catch {}
});
</script>
=======
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=980" />
  <title>Funferp ERP - Demo</title>
  <style>
    /* Reset + fonte */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background:#f9fafb; color:#1f2937; line-height:1.55;
      padding:24px;
    }

    /* Layout geral */
    main{max-width:1100px;margin:0 auto}
    header{max-width:1100px;margin:0 auto 18px}
    header h1{font-size:28px;font-weight:700;margin-bottom:6px}
    header .muted{color:#6b7280;font-size:14px}

    /* Navega√ß√£o (abas) */
    nav{
      display:flex; flex-wrap:wrap; gap:10px;
      max-width:1100px; margin:14px auto 22px;
    }
    nav button{
      border:0; border-radius:10px; padding:10px 14px;
      background:#e5e7eb; color:#111827; font-weight:600;
      box-shadow:0 1px 0 rgba(0,0,0,.04);
      cursor:pointer; transition:transform .04s ease, background .15s ease;
    }
    nav button:hover{transform:translateY(-1px)}
    nav button.active{background:#2563eb;color:#fff}

    /* Cart√µes */
    .card{
      background:#fff; border-radius:12px; padding:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.08);
      margin-bottom:18px;
    }
    .card h3{margin-bottom:10px;color:#111827}

    /* Tipografia de se√ß√µes */
    section.tab h2{margin:6px 0 12px;font-size:22px}
    .muted{color:#9ca3af}
    .hide{display:none}

    /* Forms */
    label{display:block;margin:8px 0 4px;font-weight:600;color:#374151}
    input[type="text"], input[type="number"], input[type="date"], select, input[placeholder]{
      width:100%; max-width:360px;
      border:1px solid #d1d5db; border-radius:8px; padding:8px 10px;
      background:#fff; color:#111827;
    }
    input::placeholder{color:#9ca3af}
    input[type="checkbox"]{transform:scale(1.1);margin-right:6px}

    /* Bot√µes padr√£o */
    button{
      border:0; border-radius:8px; padding:8px 12px; font-weight:600;
      background:#2563eb; color:#fff; cursor:pointer; margin-right:6px; margin-top:8px;
    }
    button.secondary{background:#6b7280}
    button.warning{background:#f59e0b}
    button:disabled{opacity:.6;cursor:not-allowed}

    /* Tabelas */
    table{width:100%; border-collapse:collapse; margin-top:10px}
    thead{background:#f3f4f6}
    th,td{padding:8px 10px; border:1px solid #e5e7eb; text-align:left; font-size:14px}
    tbody tr:hover{background:#fafafa}

    /* Mensagens */
    .msg{margin-top:8px;font-size:14px}
    .msg.ok{color:#059669}
    .msg.err{color:#dc2626}

    /* Footer */
    footer{max-width:1100px;margin:26px auto 0;text-align:center;color:#6b7280;font-size:13px}
  </style>
</head>
<body>

<header>
  <h1>Funferp ERP - Modo Demo</h1>
  <p class="muted">Este √© um ambiente de demonstra√ß√£o. Os dados s√£o tempor√°rios e ser√£o apagados ao atualizar a p√°gina (F5).</p>
</header>

<nav>
  <button data-tab="home" class="active">In√≠cio</button>
  <button data-tab="cadastros">Cadastros</button>
  <button data-tab="estoque">Estoque</button>
  <button data-tab="financeiro">Financeiro</button>
  <button data-tab="relatorios">Relat√≥rios</button>
</nav>

<main id="appArea">
  <!-- Aba: In√≠cio -->
  <section id="home" class="tab">
    <h2>Bem-vindo(a) ao Demo!</h2>
    <p>Neste modo, voc√™ pode testar cadastros, estoque, financeiro e relat√≥rios. Os dados n√£o s√£o persistidos (mem√≥ria vol√°til em JS).</p>
    <ul style="margin-top:10px; padding-left:18px;">
      <li>Cadastre insumos, tipos, contas e fornecedores</li>
      <li>Fa√ßa entradas/ajustes de estoque</li>
      <li>Registre pagamentos</li>
      <li>Gere e exporte relat√≥rios (CSV BR)</li>
    </ul>
  </section>
  <!-- Aba: Cadastros -->
  <section id="cadastros" class="tab hide">
    <h2>Cadastros</h2>

    <div class="card">
      <h3>Insumos</h3>
      <label>Nome:
        <input id="iNome" placeholder="Ex: Queijo Mussarela" />
      </label>
      <label>Unidade:
        <select id="iUni">
          <option value="">Selecione...</option>
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="un">un</option>
          <option value="ml">ml</option>
          <option value="l">l</option>
        </select>
      </label>
      <label>
        <input type="checkbox" id="iVend" /> Vend√≠vel
      </label>
      <button id="btnAddInsumo">Salvar</button>
      <button id="btnListInsumo" class="secondary">Listar</button>
      <div id="msgInsumo" class="msg"></div>

      <table id="tblInsumos">
        <thead>
          <tr><th>ID</th><th>Nome</th><th>Unidade</th><th>Vend√≠vel</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="4" class="muted">(vazio)</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3>Produtos</h3>
      <label>Nome:
        <input id="pNome" placeholder="Ex: X-Burger" />
      </label>
      <label>√â preparado?
        <select id="pPrep">
          <option value="">Selecione...</option>
          <option value="true">Sim</option>
          <option value="false">N√£o</option>
        </select>
      </label>

      <div id="inline-ficha" class="hide">
        <p class="muted">Ap√≥s salvar, defina a ficha t√©cnica abaixo.</p>
      </div>

      <button id="btnAddProd">Salvar</button>
      <button id="btnListProd" class="secondary">Listar</button>
      <div id="msgProd" class="msg"></div>

      <table id="tblProdutos">
        <thead>
          <tr><th>ID</th><th>Nome</th><th>Preparado</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="3" class="muted">(vazio)</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3>Ficha T√©cnica</h3>
      <label>Produto:
        <select id="fpProd"></select>
      </label>
      <button id="fpBtnVer">Ver Ficha</button>

      <table id="fpTbl" style="margin-top:10px;">
        <thead>
          <tr><th>ID</th><th>Insumo</th><th>Qtd</th><th>Unidade</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="4" class="muted">(vazio)</td></tr>
        </tbody>
      </table>

      <h4 style="margin-top:14px;">Adicionar Linha</h4>
      <label>Insumo:
        <select class="fpLinhaIns"></select>
      </label>
      <label>Qtd:
        <input class="fpLinhaQtd" type="number" step="0.01" />
      </label>
      <label>Unidade:
        <select class="fpLinhaUn">
          <option value="">Selecione...</option>
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="un">un</option>
          <option value="ml">ml</option>
          <option value="l">l</option>
        </select>
      </label>
      <button id="fpBtnAddLinha" class="secondary">+ Adicionar linha</button>

      <table id="fpTblLinhas" style="margin-top:10px;">
        <thead>
          <tr><th>#</th><th>Insumo</th><th>Qtd</th><th>Un</th><th></th></tr>
        </thead>
        <tbody>
          <tr><td colspan="5" class="muted">(vazio)</td></tr>
        </tbody>
      </table>

      <button id="fpBtnSalvar">Salvar Ficha</button>
      <div id="fpMsg" class="msg"></div>
    </div>
  </section>
  <!-- Aba: Estoque -->
  <section id="estoque" class="tab hide">
    <h2>Estoque</h2>

    <div class="card">
      <h3>Entrada de Estoque</h3>
      <label>Insumo:
        <select id="eIns"></select>
      </label>
      <label>Qtd:
        <input id="eQtd" type="number" step="0.01" />
      </label>
      <label>Custo Total:
        <input id="eCusto" type="number" step="0.01" />
      </label>
      <button id="btnEntrada">Registrar Entrada</button>
      <div id="msgEnt" class="msg"></div>
    </div>

    <div class="card">
      <h3>Ajuste de Estoque</h3>
      <label>Insumo:
        <select id="aIns"></select>
      </label>
      <label>Qtd (ex: -1):
        <input id="aQtd" type="number" step="0.01" />
      </label>
      <label>Motivo:
        <input id="aMot" placeholder="Ex: quebra" />
      </label>
      <label>Custo Unit√°rio (opcional):
        <input id="aCusto" type="number" step="0.01" />
      </label>
      <button id="btnAjuste" class="warning">Aplicar Ajuste</button>
      <div id="msgAj" class="msg"></div>
    </div>

    <div class="card">
      <h3>Convers√µes</h3>
      <label>Insumo:
        <select id="convIns"></select>
      </label>
      <label>De:
        <input id="convFrom" placeholder="Ex: kg" />
      </label>
      <label>Para:
        <input id="convTo" placeholder="Ex: g" />
      </label>
      <label>Fator:
        <input id="convFactor" type="number" step="0.0001" placeholder="Ex: 1000" />
      </label>
      <button id="btnConvAdd">Adicionar Convers√£o</button>
      <button id="btnConvList" class="secondary">Listar</button>
      <div id="msgConv" class="msg"></div>

      <table id="tblConv">
        <thead>
          <tr><th>De</th><th>Para</th><th>Fator</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="3" class="muted">(vazio)</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3>Saldos</h3>
      <button id="btnSaldos">Atualizar Saldos</button>
      <table id="tblSaldos">
        <thead>
          <tr><th>Insumo</th><th>Unidade</th><th>Saldo</th><th>Custo M√©dio</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="4" class="muted">(vazio)</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3>Exportar Estoque CSV (BR)</h3>
      <button id="btnEstoqueMediaCSV">Exportar</button>
    </div>
  </section>
  <!-- Aba: Financeiro -->
  <section id="financeiro" class="tab hide">
    <h2>Financeiro</h2>

    <!-- Fornecedores -->
    <div class="card">
      <h3>Fornecedores</h3>
      <label>Nome:
        <input id="fForNome" placeholder="Ex: Supermercado Central" />
      </label>
      <label>Documento:
        <input id="fForDoc" placeholder="CNPJ/CPF" />
      </label>
      <button id="btnAddForn">Salvar</button>
      <button id="btnListForn" class="secondary">Listar</button>
      <div id="msgForn" class="msg"></div>

      <table id="tblForns">
        <thead>
          <tr><th>ID</th><th>Nome</th><th>Documento</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="3" class="muted">(vazio)</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Tipos de Despesa -->
    <div class="card">
      <h3>Tipos de Despesa</h3>
      <label>Nome:
        <input id="fTipoNome" placeholder="Ex: Energia el√©trica" />
      </label>
      <button id="btnAddTipo">Salvar</button>
      <button id="btnListTipo" class="secondary">Listar</button>
      <div id="msgTipo" class="msg"></div>

      <table id="tblTipos">
        <thead>
          <tr><th>ID</th><th>Nome</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="2" class="muted">(vazio)</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Contas -->
    <div class="card">
      <h3>Contas</h3>
      <label>Nome:
        <input id="fContaNome" placeholder="Ex: Caixa Principal" />
      </label>
      <label>Tipo:
        <select id="fContaTipo">
          <option value="caixa">Caixa</option>
          <option value="banco">Banco</option>
          <option value="cart√£o">Cart√£o</option>
        </select>
      </label>
      <button id="btnAddConta">Salvar</button>
      <button id="btnListConta" class="secondary">Listar</button>
      <div id="msgConta" class="msg"></div>

      <table id="tblContas">
        <thead>
          <tr><th>ID</th><th>Nome</th><th>Tipo</th></tr>
        </thead>
        <tbody>
          <tr><td colspan="3" class="muted">(vazio)</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Pagamentos -->
    <div class="card">
      <h3>Pagamentos</h3>
      <label>Fornecedor:
        <select id="pForn"></select>
      </label>
      <label>Tipo:
        <select id="pTipo"></select>
      </label>
      <label>Conta:
        <select id="pConta"></select>
      </label>
      <label>Valor:
        <input id="pValor" type="number" step="0.01" />
      </label>
      <label>Data:
        <input id="pData" placeholder="DD/MM/AAAA" />
      </label>
      <label>Observa√ß√£o:
        <input id="pObs" />
      </label>
      <button id="btnAddPgto">Salvar</button>
      <button id="btnListPgto" class="secondary">Listar</button>
      <div id="msgPgto" class="msg"></div>

      <table id="tblPgto">
        <thead>
          <tr>
            <th>ID</th><th>Data</th><th>Fornecedor</th><th>Tipo</th>
            <th>Conta</th><th>Valor</th><th>Obs</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7" class="muted">(vazio)</td></tr>
        </tbody>
      </table>

      <button id="btnPagamentosCSV">Exportar CSV-BR</button>
    </div>
  </section>
  <!-- Aba: Relat√≥rios -->
  <section id="relatorios" class="tab hide">
    <h2>Relat√≥rios</h2>

    <!-- Relat√≥rio de Estoque -->
    <div class="card">
      <h3>Relat√≥rio de Estoque</h3>
      <button id="btnRelEst">Gerar</button>
      <table id="tblRelEst">
        <thead>
          <tr>
            <th>Insumo</th><th>Unidade</th><th>Saldo</th><th>Custo M√©dio</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="4" class="muted">(vazio)</td></tr>
        </tbody>
      </table>
      <button id="btnEstoqueMediaCSV">Exportar CSV-BR</button>
    </div>

    <!-- Relat√≥rio de Vendas -->
    <div class="card">
      <h3>Relat√≥rio de Vendas</h3>
      <label>Data inicial:
        <input id="rvIni" placeholder="DD/MM/AAAA" />
      </label>
      <label>Data final:
        <input id="rvFim" placeholder="DD/MM/AAAA" />
      </label>
      <button id="btnRelV">Gerar</button>

      <table id="tblVendas">
        <thead>
          <tr>
            <th>ID</th><th>Data</th><th>Produto</th><th>Pre√ßo</th>
            <th>Qtd</th><th>Tipo</th><th>Coment√°rio</th><th>Pgto</th>
            <th>Cancelada</th><th>Consumo</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="10" class="muted">(vazio)</td></tr>
        </tbody>
      </table>

      <button id="btnVendasCSVBR">Exportar CSV-BR</button>
    </div>

    <!-- Relat√≥rio de Movimenta√ß√µes -->
    <div class="card">
      <h3>Relat√≥rio de Movimenta√ß√µes</h3>
      <label>Data inicial:
        <input id="rmi" placeholder="DD/MM/AAAA" />
      </label>
      <label>Data final:
        <input id="rmf" placeholder="DD/MM/AAAA" />
      </label>
      <button id="btnRelMov">Gerar</button>

      <table id="tblRelMov">
        <thead>
          <tr>
            <th>ID</th><th>Data</th><th>Insumo</th><th>Qtd</th>
            <th>Un</th><th>Custo</th><th>Origem</th><th>Tipo</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="8" class="muted">(vazio)</td></tr>
        </tbody>
      </table>
    </div>
  </section>
<footer>
  <p>¬© 2025 Funferp Demo | Dados n√£o persistentes (modo de demonstra√ß√£o)</p>
</footer>

<script>
"use strict";

/* ===== Utilit√°rios b√°sicos ===== */
const ROLE = "admin";   // acesso total (demo)
const BACK = null;      // sem backend real

function $(sel){ return document.querySelector(sel); }
function $all(sel){ return document.querySelectorAll(sel); }
function setMsg(el, txt, ok){ if(!el) return; el.textContent = txt; el.className = ok ? "msg ok" : "msg err"; }

function isoToBr(iso){
  if(!iso) return "";
  const d = typeof iso === "string" ? iso.slice(0,10) : "";
  if(!d) return "";
  const [y,m,da] = d.split("-");
  return `${da}/${m}/${y}`;
}
function brToIso(br){
  const v = (br||"").trim();
  if(!v) return "";
  const [d,m,y] = v.split("/");
  if(!(d && m && y)) return "";
  return `${y}-${m}-${d}`;
}

const brMoney = new Intl.NumberFormat("pt-BR",{ style:"currency", currency:"BRL" });
const brQty2  = new Intl.NumberFormat("pt-BR",{ minimumFractionDigits:2, maximumFractionDigits:2 });
const brQty3  = new Intl.NumberFormat("pt-BR",{ minimumFractionDigits:3, maximumFractionDigits:3 });

/* ===== ‚ÄúBanco‚Äù em mem√≥ria (demo) ===== */
const DB = {
  seq: { insumo:1, produto:1, mov:1, venda:1, forn:1, tipo:1, conta:1, pgto:1 },
  insumos: [],                 // {id,nome,unidade,vendivel}
  produtos: [],                // {id,nome,preparado}
  ficha: {},                   // { [produto_id]: [ {insumo_id,quantidade,unidade} ] }
  estoque: {},                 // { [insumo_id]: { saldo:number, custoMedio:number } }
  _convs: {},                  // { [insumo_id]: [ {de_unidade, para_unidade, fator} ] }
  movs: [],                    // {id,dataISO,insumo_id,insumo_nome,quantidade,unidade,custo_total,origem,tipo}
  vendas: [],                  // ver relVendasLocal
  formas: ["dinheiro","pix","debito","credito","voucher","outro"],

  fornecedores: [],            // {id,nome,documento}
  tipos: [],                   // {id,nome}
  contas: [],                  // {id,nome,tipo}
  pagamentos: []               // {id,dataISO,fornecedor_id,tipo_id,conta_id,valor,observacao}
};

function todayISO(){ return new Date().toISOString(); }
function ensureEstoque(id){ return (DB.estoque[id] ||= { saldo:0, custoMedio:0 }); }
function findInsumo(id){ return DB.insumos.find(i => i.id === id) || null; }
function addMov(m){ m.id = DB.seq.mov++; DB.movs.push(m); }

/* ===== Cadastros b√°sicos ===== */
function addInsumo(nome, unidade, vendivel=false){
  const id = DB.seq.insumo++;
  DB.insumos.push({ id, nome, unidade, vendivel: !!vendivel });
  refreshInsumoSelects();
  return id;
}
function addProduto(nome, preparado=false){
  const id = DB.seq.produto++;
  DB.produtos.push({ id, nome, preparado: !!preparado });
  return id;
}

/* ===== Selects e tabelas auxiliares ===== */
function refreshInsumoSelects(){
  const opts = [`<option value="">Selecione‚Ä¶</option>`]
    .concat(DB.insumos.map(i => `<option value="${i.id}">${i.id} - ${i.nome} (${i.unidade})</option>`));

  // estoque / convers√µes
  const convIns = $("#convIns");
  if (convIns) convIns.innerHTML = opts.join("");

  // entrada/ajuste
  const eSel = $("#eIns");
  if (eSel) eSel.innerHTML = opts.join("");
  const aSel = $("#aIns");
  if (aSel) aSel.innerHTML = opts.join("");

  // ficha t√©cnica ‚Äì linhas
  const linhaIns = $all(".fpLinhaIns");
  linhaIns.forEach(sel => sel.innerHTML = opts.join(""));
}

/* ===== Convers√µes (por insumo) ===== */
function listConversoes(){
  const insumo_id = parseInt($("#convIns")?.value || "0", 10);
  const tbody = $("#tblConv tbody");
  if (!tbody) return;

  if (!insumo_id) {
    tbody.innerHTML = `<tr><td colspan="3" class="muted">Selecione um insumo.</td></tr>`;
    return;
  }
  const arr = (DB._convs[insumo_id] || []);
  if (!arr.length) {
    tbody.innerHTML = `<tr><td colspan="3" class="muted">(vazio)</td></tr>`;
    return;
  }
  tbody.innerHTML = arr.map(c =>
    `<tr><td>${c.de_unidade}</td><td>${c.para_unidade}</td><td>${brQty3.format(+c.fator)}</td></tr>`
  ).join("");
}

function saveConversao(){
  const insumo_id = parseInt($("#convIns")?.value || "0", 10);
  const de_unidade = ($("#convFrom")?.value || "").trim();
  const para_unidade = ($("#convTo")?.value || "").trim();
  const fator = parseFloat($("#convFactor")?.value || "0");
  const msg = $("#msgConv");

  if (!insumo_id || !de_unidade || !para_unidade || !(fator > 0)) {
    setMsg(msg, "Preencha insumo, de, para e fator > 0.", false);
    return;
  }

  const arr = (DB._convs[insumo_id] ||= []);
  const ix = arr.findIndex(c => c.de_unidade === de_unidade && c.para_unidade === para_unidade);
  if (ix >= 0) arr[ix].fator = +fator; else arr.push({ de_unidade, para_unidade, fator:+fator });

  setMsg(msg, "Convers√£o salva!", true);
  const ff = $("#convFactor"); if (ff) ff.value = "";
  listConversoes();
}

/* ===== Estoque ‚Äì custo m√©dio ===== */
function saldosMedia(){
  return DB.insumos.map(ins => {
    const st = DB.estoque[ins.id] || { saldo:0, custoMedio:0 };
    return {
      insumo_id: ins.id,
      insumo_nome: ins.nome,
      unidade: ins.unidade,
      saldo: +st.saldo,
      custo_medio: +st.custoMedio
    };
  });
}

function loadSaldos(){
  const data = saldosMedia();
  const tbody = $("#tblSaldos tbody") || $("#tblRelEst tbody");
  if (!tbody) return;

  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="4" class="muted">(vazio)</td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(x => `
    <tr>
      <td>${x.insumo_nome}</td>
      <td>${x.unidade}</td>
      <td>${brQty3.format(+x.saldo)}</td>
      <td>${brMoney.format(+(x.custo_medio||0))}</td>
    </tr>
  `).join("");
}

function entradaMedia({ insumo_id, quantidade, custo_total }){
  const e = ensureEstoque(insumo_id);
  const qtd = +quantidade;
  const somaAnt = e.saldo * e.custoMedio;
  e.saldo += qtd;
  e.custoMedio = e.saldo > 0 ? (somaAnt + (+custo_total)) / e.saldo : 0;

  const ins = findInsumo(insumo_id);
  addMov({
    dataISO: todayISO(),
    insumo_id,
    insumo_nome: ins?.nome || "",
    quantidade: +qtd,
    unidade: ins?.unidade || "",
    custo_total: +custo_total,
    origem: "entrada",
    tipo: "entrada-media"
  });
}

function ajusteMedia({ insumo_id, quantidade, motivo, custo_unitario }){
  const e = ensureEstoque(insumo_id);
  const qtd = +quantidade;
  if (typeof custo_unitario === "number" && !Number.isNaN(custo_unitario)) {
    e.custoMedio = +custo_unitario;
  }
  e.saldo += qtd;

  const ins = findInsumo(insumo_id);
  addMov({
    dataISO: todayISO(),
    insumo_id,
    insumo_nome: ins?.nome || "",
    quantidade: +qtd,
    unidade: ins?.unidade || "",
    custo_total: 0,
    origem: motivo || "ajuste",
    tipo: "ajuste-media"
  });
}

/* ===== Relat√≥rios locais ===== */
function relVendasLocal({ start, end } = {}){
  const ini = start ? new Date(start+"T00:00:00") : null;
  const fim = end   ? new Date(end+"T23:59:59")  : null;
  const out = [];
  for (const v of DB.vendas) {
    const d = new Date(v.data);
    if (ini && d < ini) continue;
    if (fim && d > fim) continue;

    if (!v.consumos || !v.consumos.length) {
      out.push({
        venda_id: v.venda_id, data: v.data, produto_nome: v.produto_nome,
        preco_venda: v.preco_venda, quantidade: v.quantidade, tipo: v.tipo,
        comentario: v.comentario, forma_pagamento: v.forma_pagamento, cancelada: v.cancelada,
        insumo_nome: "", consumo_base: "", unidade_base: ""
      });
    } else {
      for (const c of v.consumos) {
        out.push({
          venda_id: v.venda_id, data: v.data, produto_nome: v.produto_nome,
          preco_venda: v.preco_venda, quantidade: v.quantidade, tipo: v.tipo,
          comentario: v.comentario, forma_pagamento: v.forma_pagamento, cancelada: v.cancelada,
          insumo_nome: c.insumo_nome, consumo_base: c.consumo_base, unidade_base: c.unidade_base
        });
      }
    }
  }
  return out;
}

function listPgtosLocal({ start, end } = {}){
  const ini = start ? new Date(start+"T00:00:00") : null;
  const fim = end   ? new Date(end+"T23:59:59")  : null;
  return DB.pagamentos.filter(p=>{
    const d = new Date(p.dataISO);
    return (!ini || d>=ini) && (!fim || d<=fim);
  }).map(p=>({
    id: p.id,
    data: p.dataISO,
    fornecedor_nome: (DB.fornecedores.find(f=>f.id===p.fornecedor_id)?.nome) || "",
    tipo_nome: (DB.tipos.find(t=>t.id===p.tipo_id)?.nome) || "",
    conta_nome: (DB.contas.find(c=>c.id===p.conta_id)?.nome) || "",
    valor: p.valor,
    observacao: p.observacao || ""
  }));
}

function relPgtosLocal({ start, end } = {}){
  const base = listPgtosLocal({ start, end });
  return base.map(p=>({
    id: p.id,
    data: p.data,
    fornecedor: p.fornecedor_nome,
    tipo: p.tipo_nome,
    conta: p.conta_nome,
    valor: p.valor,
    observacao: p.observacao
  }));
}

/* ===== CSV helpers ===== */
function csvEscapeBR(v){
  const s = String(v ?? "");
  return /[\";\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
}
function downloadCSV(filename, csvText){
  const blob = new Blob([csvText], { type: "text/csv;charset=utf-8" });
  const url  = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===== Exporta√ß√µes CSV ===== */
function exportEstoqueBR(){
  const data = saldosMedia() || [];
  const headers = ["insumo_id","insumo_nome","unidade","saldo","custo_medio"];
  const sep = ";";
  const rows = data.map(x => [
    x.insumo_id ?? "",
    (x.insumo_nome ?? ""),
    x.unidade ?? "",
    x.saldo ?? 0,
    x.custo_medio ?? 0
  ]);

  const csv = [
    headers.join(sep),
    ...rows.map(rw => rw.map(csvEscapeBR).join(sep))
  ].join("\n");
  downloadCSV("estoque_custo_medio.csv", csv);
}

function exportVendasBR(){
  const viBR = ($("#rvIni")?.value || "").trim();
  const vfBR = ($("#rvFim")?.value || "").trim();
  const vi = brToIso(viBR);
  const vf = brToIso(vfBR);

  const data = relVendasLocal({ start: vi || undefined, end: vf || undefined }) || [];
  const headers = ["id","data","produto","preco","quantidade","tipo","comentario","pagamento","cancelada","consumo_insumo","consumo_qtd","consumo_un"];
  const sep = ";";

  const rows = data.map(v => [
    v.venda_id ?? "",
    isoToBr((v.data||"").toString().slice(0,10)),
    (v.produto_nome||""),
    v.preco_venda ?? 0,
    v.quantidade ?? 0,
    v.tipo ?? "",
    (v.comentario||""),
    v.forma_pagamento ?? "",
    v.cancelada ? "SIM" : "N√ÉO",
    v.insumo_nome ?? "",
    v.consumo_base ?? "",
    v.unidade_base ?? ""
  ]);

  const csv = [
    headers.join(sep),
    ...rows.map(rw => rw.map(csvEscapeBR).join(sep))
  ].join("\n");
  downloadCSV("vendas.csv", csv);
}

function exportPagamentosBR(){
  const viBR = ($("#rpIni")?.value || "").trim();
  const vfBR = ($("#rpFim")?.value || "").trim();
  const vi = brToIso(viBR);
  const vf = brToIso(vfBR);

  const data = relPgtosLocal({ start: vi || undefined, end: vf || undefined }) || [];
  const headers = ["id","data","fornecedor","tipo","conta","valor","observacao"];
  const sep = ";";

  const rows = data.map(p => [
    p.id ?? "",
    isoToBr((p.data||"").toString().slice(0,10)),
    (p.fornecedor||""),
    (p.tipo||""),
    (p.conta||""),
    p.valor ?? 0,
    (p.observacao||"")
  ]);

  const csv = [
    headers.join(sep),
    ...rows.map(rw => rw.map(csvEscapeBR).join(sep))
  ].join("\n");
  downloadCSV("pagamentos.csv", csv);
}
</script>
<script>
/* ============================
   BLOCO 7/7 ‚Äî WIRES & BOOT
   ============================ */

/* ---------- Render helpers (Cadastros) ---------- */
function renderInsumos(){
  const tb = $("#tblInsumos tbody");
  if(!tb) return;
  const data = DB.insumos;
  tb.innerHTML = data.length
    ? data.map(i=>`<tr><td>${i.id}</td><td>${i.nome}</td><td>${i.unidade}</td><td>${i.vendivel?"Sim":"N√£o"}</td></tr>`).join("")
    : `<tr><td colspan="4" class="muted">(vazio)</td></tr>`;
}

function renderProdutos(){
  const tb = $("#tblProdutos tbody");
  if(!tb) return;
  const data = DB.produtos;
  tb.innerHTML = data.length
    ? data.map(p=>`<tr><td>${p.id}</td><td>${p.nome}</td><td>${p.preparado?"Sim":"N√£o"}</td></tr>`).join("")
    : `<tr><td colspan="3" class="muted">(vazio)</td></tr>`;

  // povoar select da ficha (produto)
  const sel = $("#fpProd");
  if(sel){
    sel.innerHTML = `<option value="">Selecione‚Ä¶</option>` +
      data.map(p=>`<option value="${p.id}">${p.id} - ${p.nome}</option>`).join("");
  }
}

/* ---------- Ficha t√©cnica (UI) ---------- */
let _fichaTemp = []; // linhas tempor√°rias antes de salvar

function renderFichaTabela(prodId){
  const tb = $("#fpTbl tbody");
  if(!tb) return;
  const list = DB.ficha[prodId] || [];
  tb.innerHTML = list.length
    ? list.map((l,ix)=>`<tr><td>${ix+1}</td><td>${(findInsumo(l.insumo_id)?.nome)||""}</td><td>${l.quantidade}</td><td>${l.unidade}</td></tr>`).join("")
    : `<tr><td colspan="4" class="muted">(vazio)</td></tr>`;
}

function renderFichaLinhasTemp(){
  const tb = $("#fpTblLinhas tbody");
  if(!tb) return;
  tb.innerHTML = _fichaTemp.length
    ? _fichaTemp.map((l,ix)=>`
      <tr>
        <td>${ix+1}</td>
        <td>${(findInsumo(+l.insumo_id)?.nome)||""}</td>
        <td>${l.quantidade}</td>
        <td>${l.unidade}</td>
        <td><button class="secondary" data-remove-line="${ix}">Remover</button></td>
      </tr>`).join("")
    : `<tr><td colspan="5" class="muted">(vazio)</td></tr>`;

  // bind remove
  $all('[data-remove-line]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const ix = +btn.getAttribute('data-remove-line');
      _fichaTemp.splice(ix,1);
      renderFichaLinhasTemp();
    });
  });
}

/* ---------- LISTENERS: Cadastros ---------- */
// Insumos
$("#btnAddInsumo")?.addEventListener("click", ()=>{
  const nome = $("#iNome")?.value.trim();
  const unidade = $("#iUni")?.value.trim();
  const vend = $("#iVend")?.checked || false;
  const msg = $("#msgInsumo");
  if(!nome || !unidade){ setMsg(msg,"Preencha nome e unidade.",false); return; }
  addInsumo(nome, unidade, vend);
  setMsg(msg,"Insumo salvo!",true);
  $("#iNome").value=""; $("#iUni").value=""; $("#iVend").checked=false;
  renderInsumos(); refreshInsumoSelects();
});
$("#btnListInsumo")?.addEventListener("click", renderInsumos);

// Produtos
$("#btnAddProd")?.addEventListener("click", ()=>{
  const nome = $("#pNome")?.value.trim();
  const prepVal = $("#pPrep")?.value;
  const msg = $("#msgProd");
  if(!nome || (prepVal!=="true" && prepVal!=="false")){
    setMsg(msg,"Preencha nome e se √© preparado.",false); return;
  }
  addProduto(nome, prepVal==="true");
  setMsg(msg,"Produto salvo!",true);
  $("#pNome").value=""; $("#pPrep").value="";
  renderProdutos();
});
$("#btnListProd")?.addEventListener("click", renderProdutos);

// Ficha t√©cnica
$("#fpBtnVer")?.addEventListener("click", ()=>{
  const pid = parseInt($("#fpProd")?.value||"0",10);
  if(!pid){ setMsg($("#fpMsg"),"Selecione um produto.",false); return; }
  renderFichaTabela(pid);
});

$("#fpBtnAddLinha")?.addEventListener("click", ()=>{
  const $ins = $(".fpLinhaIns"), $q = $(".fpLinhaQtd"), $u = $(".fpLinhaUn");
  const insumo_id = parseInt(($ins?.value||"0"),10);
  const quantidade = parseFloat(($q?.value||"0"));
  const unidade = ($u?.value||"").trim();
  if(!insumo_id || !(quantidade>0) || !unidade){
    setMsg($("#fpMsg"),"Preencha insumo, quantidade > 0 e unidade.",false); return;
  }
  _fichaTemp.push({ insumo_id, quantidade:+quantidade, unidade });
  renderFichaLinhasTemp();
  if($q) $q.value=""; if($u) $u.value="";
});

$("#fpBtnSalvar")?.addEventListener("click", ()=>{
  const pid = parseInt($("#fpProd")?.value||"0",10);
  if(!pid){ setMsg($("#fpMsg"),"Selecione um produto.",false); return; }
  DB.ficha[pid] = (_fichaTemp||[]).map(l=>({...l, insumo_id:+l.insumo_id, quantidade:+l.quantidade}));
  _fichaTemp = [];
  renderFichaLinhasTemp();
  renderFichaTabela(pid);
  setMsg($("#fpMsg"),"Ficha t√©cnica salva!",true);
});

/* ---------- LISTENERS: Estoque ---------- */
$("#btnEntrada")?.addEventListener("click", ()=>{
  const insumo_id = parseInt($("#eIns")?.value||"0",10);
  const quantidade = parseFloat($("#eQtd")?.value||"0");
  const custo_total = parseFloat($("#eCusto")?.value||"0");
  if(!insumo_id || !(quantidade>0) || !(custo_total>=0)){
    setMsg($("#msgEnt"),"Preencha insumo, quantidade > 0 e custo.",false); return;
  }
  entradaMedia({ insumo_id, quantidade, custo_total });
  setMsg($("#msgEnt"),"Entrada registrada!",true);
  $("#eQtd").value=""; $("#eCusto").value="";
  loadSaldos();
});

$("#btnAjuste")?.addEventListener("click", ()=>{
  const insumo_id = parseInt($("#aIns")?.value||"0",10);
  const quantidade = parseFloat($("#aQtd")?.value||"0");
  const motivo = ($("#aMot")?.value||"").trim();
  const custo_unitario = parseFloat($("#aCusto")?.value||"");
  if(!insumo_id || !quantidade){
    setMsg($("#msgAj"),"Preencha insumo e quantidade (pode ser negativa).",false); return;
  }
  ajusteMedia({ insumo_id, quantidade, motivo, custo_unitario: Number.isNaN(custo_unitario)?undefined:custo_unitario });
  setMsg($("#msgAj"),"Ajuste aplicado!",true);
  $("#aQtd").value=""; $("#aMot").value=""; $("#aCusto").value="";
  loadSaldos();
});

// Convers√µes
$("#btnConvAdd")?.addEventListener("click", saveConversao);
$("#btnConvList")?.addEventListener("click", listConversoes);

// Saldos
$("#btnSaldos")?.addEventListener("click", loadSaldos);

/* ---------- LISTENERS: Financeiro ---------- */
async function finLoadForns(){
  const tb = $("#tblForns tbody");
  const data = DB.fornecedores || [];
  if (tb){
    tb.innerHTML = data.length
      ? data.map(f=>`<tr><td>${f.id}</td><td>${f.nome}</td><td>${f.documento||""}</td></tr>`).join("")
      : `<tr><td colspan="3" class="muted">(vazio)</td></tr>`;
  }
  const sel = $("#pForn");
  if (sel){
    sel.innerHTML = `<option value="">Selecione‚Ä¶</option>` + data.map(f=>`<option value="${f.id}">${f.id} - ${f.nome}</option>`).join("");
  }
}
async function finLoadTipos(){
  const tb = $("#tblTipos tbody");
  const data = DB.tipos || [];
  if (tb){
    tb.innerHTML = data.length
      ? data.map(t=>`<tr><td>${t.id}</td><td>${t.nome}</td></tr>`).join("")
      : `<tr><td colspan="2" class="muted">(vazio)</td></tr>`;
  }
  const sel = $("#pTipo");
  if (sel){
    sel.innerHTML = `<option value="">Selecione‚Ä¶</option>` + data.map(t=>`<option value="${t.id}">${t.id} - ${t.nome}</option>`).join("");
  }
}
async function finLoadContas(){
  const tb = $("#tblContas tbody");
  const data = DB.contas || [];
  if (tb){
    tb.innerHTML = data.length
      ? data.map(c=>`<tr><td>${c.id}</td><td>${c.nome}</td><td>${c.tipo}</td></tr>`).join("")
      : `<tr><td colspan="3" class="muted">(vazio)</td></tr>`;
  }
  const sel = $("#pConta");
  if (sel){
    sel.innerHTML = `<option value="">Selecione‚Ä¶</option>` + data.map(c=>`<option value="${c.id}">${c.id} - ${c.nome} (${c.tipo})</option>`).join("");
  }
}
async function finPopulateSelectors(){ await Promise.all([finLoadForns(), finLoadTipos(), finLoadContas()]); }

$("#btnAddForn")?.addEventListener("click", async ()=>{
  const nome = $("#fForNome")?.value.trim();
  const documento = $("#fForDoc")?.value.trim();
  if(!nome){ setMsg($("#msgForn"),"Informe o nome do fornecedor.",false); return; }
  const id = DB.seq.forn++; DB.fornecedores.push({ id, nome, documento: documento||null });
  setMsg($("#msgForn"),"Fornecedor salvo!",true);
  $("#fForNome").value=""; $("#fForDoc").value="";
  await finLoadForns();
});
$("#btnListForn")?.addEventListener("click", finLoadForns);

$("#btnAddTipo")?.addEventListener("click", async ()=>{
  const nome = $("#fTipoNome")?.value.trim();
  if(!nome){ setMsg($("#msgTipo"),"Informe o nome do tipo.",false); return; }
  const id = DB.seq.tipo++; DB.tipos.push({ id, nome });
  setMsg($("#msgTipo"),"Tipo salvo!",true);
  $("#fTipoNome").value="";
  await finLoadTipos();
});
$("#btnListTipo")?.addEventListener("click", finLoadTipos);

$("#btnAddConta")?.addEventListener("click", async ()=>{
  const nome = $("#fContaNome")?.value.trim();
  const tipo = $("#fContaTipo")?.value.trim();
  if(!nome || !tipo){ setMsg($("#msgConta"),"Preencha nome e tipo.",false); return; }
  const id = DB.seq.conta++; DB.contas.push({ id, nome, tipo });
  setMsg($("#msgConta"),"Conta salva!",true);
  $("#fContaNome").value=""; $("#fContaTipo").value="caixa";
  await finLoadContas();
});
$("#btnListConta")?.addEventListener("click", finLoadContas);

async function finListPagamentos(){
  const vi = brToIso(($("#rpIni")?.value||"").trim());
  const vf = brToIso(($("#rpFim")?.value||"").trim());
  const tb = $("#tblPgto tbody");
  if (!tb) return;

  const data = (DB.pagamentos||[]).filter(p=>{
    const d = new Date(p.dataISO);
    const ini = vi ? new Date(vi+"T00:00:00") : null;
    const fim = vf ? new Date(vf+"T23:59:59") : null;
    return (!ini || d>=ini) && (!fim || d<=fim);
  }).map(p=>({
    id:p.id,
    data:p.dataISO,
    fornecedor_nome:(DB.fornecedores.find(f=>f.id===p.fornecedor_id)?.nome)||"",
    tipo_nome:(DB.tipos.find(t=>t.id===p.tipo_id)?.nome)||"",
    conta_nome:(DB.contas.find(c=>c.id===p.conta_id)?.nome)||"",
    valor:p.valor,
    observacao:p.observacao||""
  }));

  tb.innerHTML = data.length
    ? data.map(p=>`<tr>
        <td>${p.id}</td>
        <td>${isoToBr((p.data||"").toString().slice(0,10))}</td>
        <td>${p.fornecedor_nome||""}</td>
        <td>${p.tipo_nome||""}</td>
        <td>${p.conta_nome||""}</td>
        <td>${brMoney.format(+p.valor||0)}</td>
        <td>${p.observacao||""}</td>
      </tr>`).join("")
    : `<tr><td colspan="7" class="muted">(vazio)</td></tr>`;
}

async function finRelPagamentos(){
  const vi = brToIso(($("#rpi")?.value || "").trim());
  const vf = brToIso(($("#rpf")?.value || "").trim());
  const tb = $("#tblRelPag tbody");
  if (!tb) return;

  const ini = vi ? new Date(vi+"T00:00:00") : null;
  const fim = vf ? new Date(vf+"T23:59:59") : null;

  const data = (DB.pagamentos||[]).filter(p=>{
    const d = new Date(p.dataISO);
    return (!ini || d>=ini) && (!fim || d<=fim);
  }).map(p=>({
    id:p.id,
    data:p.dataISO,
    fornecedor:(DB.fornecedores.find(f=>f.id===p.fornecedor_id)?.nome)||"",
    tipo:(DB.tipos.find(t=>t.id===p.tipo_id)?.nome)||"",
    conta:(DB.contas.find(c=>c.id===p.conta_id)?.nome)||"",
    valor:p.valor,
    observacao:p.observacao||""
  }));

  tb.innerHTML = data.length
    ? data.map(p=>`<tr>
        <td>${p.id}</td>
        <td>${isoToBr((p.data||"").toString().slice(0,10))}</td>
        <td>${p.fornecedor||""}</td>
        <td>${p.tipo||""}</td>
        <td>${p.conta||""}</td>
        <td>${brMoney.format(+p.valor||0)}</td>
        <td>${p.observacao||""}</td>
      </tr>`).join("")
    : `<tr><td colspan="7" class="muted">(vazio)</td></tr>`;
}

$("#btnAddPgto")?.addEventListener("click", async ()=>{
  const fornecedor_id = parseInt($("#pForn")?.value||"0",10);
  const tipo_id       = parseInt($("#pTipo")?.value||"0",10);
  const conta_id      = parseInt($("#pConta")?.value||"0",10);
  const valor         = parseFloat($("#pValor")?.value||"0");
  const dataBr        = ($("#pData")?.value||"").trim();
  const dataIso       = brToIso(dataBr);
  const observacao    = ($("#pObs")?.value||"").trim() || null;

  if(!fornecedor_id || !tipo_id || !conta_id || !(valor>0)){
    setMsg($("#msgPgto"), "Preencha fornecedor, tipo, conta e valor > 0.", false);
    return;
  }

  const id = DB.seq.pgto++;
  const dataISO = dataIso ? new Date(`${dataIso}T00:00:00`).toISOString() : new Date().toISOString();
  DB.pagamentos.push({ id, fornecedor_id, tipo_id, conta_id, valor:+valor, observacao, dataISO });

  setMsg($("#msgPgto"), "Pagamento salvo!", true);
  $("#pValor").value = ""; $("#pData").value = ""; $("#pObs").value = "";

  await finListPagamentos();
  await finRelPagamentos();
});

$("#btnListPgto")?.addEventListener("click", finListPagamentos);
$("#btnRelFinanceiro")?.addEventListener("click", finRelPagamentos);

/* ---------- LISTENERS: Relat√≥rios + CSV ---------- */
$("#btnRelEst")?.addEventListener("click", loadSaldos);

$("#btnRelV")?.addEventListener("click", ()=>{
  const vi = brToIso(($("#rvIni")?.value||"").trim());
  const vf = brToIso(($("#rvFim")?.value||"").trim());
  const data = relVendasLocal({ start: vi || undefined, end: vf || undefined });
  const tb = $("#tblVendas tbody");
  if (!tb) return;
  tb.innerHTML = data.length
    ? data.map(v=>`<tr>
        <td>${v.venda_id}</td>
        <td>${isoToBr((v.data||"").toString().slice(0,10))}</td>
        <td>${(v.produto_nome||"")}</td>
        <td>${brMoney.format(+v.preco_venda||0)}</td>
        <td>${v.quantidade ?? ""}</td>
        <td>${v.tipo||""}</td>
        <td>${v.comentario||""}</td>
        <td>${v.forma_pagamento||""}</td>
        <td>${v.cancelada?"SIM":"N√ÉO"}</td>
        <td>${v.insumo_nome||""} ${v.consumo_base||""} ${v.unidade_base||""}</td>
        <td></td>
      </tr>`).join("")
    : `<tr><td colspan="11" class="muted">(vazio)</td></tr>`;
});

$("#btnVendasCSVBR")?.addEventListener("click", exportVendasBR);
$("#btnPagamentosCSV")?.addEventListener("click", exportPagamentosBR);
$("#btnEstoqueMediaCSV")?.addEventListener("click", exportEstoqueBR);

/* ---------- Navega√ß√£o por abas ---------- */
$all('nav button[data-tab]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const t = btn.getAttribute('data-tab');
    $all('main .tab').forEach(sec=>sec.classList.add('hide'));
    $("#"+t)?.classList.remove('hide');
    $all('nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});

/* ---------- Boot do App ---------- */
document.addEventListener("DOMContentLoaded", ()=>{
  // home como padr√£o
  document.querySelector('nav button[data-tab="home"]')?.click();

  // iniciar lists/render
  renderInsumos();
  renderProdutos();
  refreshInsumoSelects();
  loadSaldos();
  finPopulateSelectors();

  // se quiser dados seed r√°pidos, descomente:
  // addInsumo("Carne Bovina","kg",false);
  // addInsumo("Refrigerante Lata","un",true);
  // addProduto("Prato Executivo",true);
});
</script>
>>>>>>> 5586e73 (Atualiza p√°gina demo (CSS/JS inline e abas funcionando))
