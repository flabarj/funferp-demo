<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=980" />
  <title>Funferp ERP - Demo</title>
  <style>
    /* Reset + fonte */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background:#f9fafb; color:#1f2937; line-height:1.55;
      padding:24px;
    }

    /* Layout geral */
    main{max-width:1100px;margin:0 auto}
    header{max-width:1100px;margin:0 auto 18px}
    header h1{font-size:28px;font-weight:700;margin-bottom:6px}
    header .muted{color:#6b7280;font-size:14px}

    /* Navegação (abas) */
    nav{
      display:flex; flex-wrap:wrap; gap:10px;
      max-width:1100px; margin:14px auto 22px;
    }
    nav button{
      border:0; border-radius:10px; padding:10px 14px;
      background:#e5e7eb; color:#111827; font-weight:600;
      box-shadow:0 1px 0 rgba(0,0,0,.04);
      cursor:pointer; transition:transform .04s ease, background .15s ease;
    }
    nav button:hover{transform:translateY(-1px)}
    nav button.active{background:#2563eb;color:#fff}

    /* Submenu (subtelas inline) */
    .subnav{display:flex; gap:8px; margin:10px 0 14px}
    .subnav button{
      background:#eef2f7; border-radius:8px; padding:6px 10px;
      border:0; font-weight:600; cursor:pointer;
    }
    .subnav button.active{background:#2563eb;color:#fff}

    /* Cartões */
    .card{
      background:#fff; border-radius:12px; padding:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.08);
      margin-bottom:18px;
    }
    .card h3{margin-bottom:10px;color:#111827}

    /* Tipografia de seções */
    section.tab h2{margin:6px 0 12px;font-size:22px}
    .muted{color:#9ca3af}
    .hide{display:none}

    /* Forms */
    label{display:block;margin:8px 0 4px;font-weight:600;color:#374151}
    input[type="text"], input[type="number"], input[type="date"], select, input[placeholder]{
      width:100%; max-width:360px;
      border:1px solid #d1d5db; border-radius:8px; padding:8px 10px;
      background:#fff; color:#111827;
    }
    input::placeholder{color:#9ca3af}
    input[type="checkbox"]{transform:scale(1.1);margin-right:6px}

    /* Botões padrão */
    button{
      border:0; border-radius:8px; padding:8px 12px; font-weight:600;
      background:#2563eb; color:#fff; cursor:pointer; margin-right:6px; margin-top:8px;
    }
    button.secondary{background:#6b7280}
    button.warning{background:#f59e0b}
    button:disabled{opacity:.6;cursor:not-allowed}

    /* Tabelas */
    table{width:100%; border-collapse:collapse; margin-top:10px}
    thead{background:#f3f4f6}
    th,td{padding:8px 10px; border:1px solid #e5e7eb; text-align:left; font-size:14px}
    tbody tr:hover{background:#fafafa}

    /* Mensagens */
    .msg{margin-top:8px;font-size:14px}
    .msg.ok{color:#059669}
    .msg.err{color:#dc2626}

    /* Footer */
    footer{max-width:1100px;margin:26px auto 0;text-align:center;color:#6b7280;font-size:13px}
  </style>
</head>
<body>

<header>
  <h1>Funferp ERP - Modo Demo</h1>
  <p class="muted">Este é um ambiente de demonstração. Os dados são temporários e serão apagados ao atualizar a página (F5).</p>
</header>

<nav>
  <button data-tab="home" class="active">Início</button>
  <button data-tab="cadastros">Cadastros</button>
  <button data-tab="estoque">Estoque</button>
  <button data-tab="financeiro">Financeiro</button>
  <button data-tab="relatorios">Relatórios</button>
  <button data-tab="vendas">Vendas</button>
</nav>

<main id="appArea">
  <!-- Aba: Início -->
  <section id="home" class="tab">
    <h2>Bem-vindo(a) ao Demo!</h2>
    <p>Neste modo, você pode testar cadastros, estoque, financeiro, vendas e relatórios. Os dados não são persistidos (memória local em JavaScript, apenas para demonstração).</p>
    <ul style="margin-top:10px; padding-left:18px;">
      <li>Cadastre insumos, produtos, fornecedores, tipos e contas</li>
      <li>Faça entradas/ajustes de estoque e conversões</li>
      <li>Registre pagamentos e vendas (com consumo por ficha técnica)</li>
      <li>Gere e exporte relatórios (CSV em padrão BR)</li>
    </ul>
  </section>

  <!-- Aba: Cadastros -->
  <section id="cadastros" class="tab hide">
    <h2>Cadastros</h2>

    <div class="subnav" data-subnav="cad">
      <button data-subtab="cad-insumos" class="active">Insumos</button>
      <button data-subtab="cad-produtos">Produtos</button>
      <button data-subtab="cad-ficha">Ficha Técnica</button>
    </div>

    <div id="cad-insumos" class="subtab">
      <div class="card">
        <h3>Insumos</h3>
        <label>Nome:
          <input id="iNome" placeholder="Ex: Queijo Mussarela" />
        </label>
        <label>Unidade:
          <select id="iUni">
            <option value="">Selecione...</option>
            <option value="kg">kg</option>
            <option value="g">g</option>
            <option value="un">un</option>
            <option value="ml">ml</option>
            <option value="l">l</option>
          </select>
        </label>
        <label><input type="checkbox" id="iVend" /> Vendível</label>

        <button id="btnAddInsumo">Salvar</button>
        <button id="btnListInsumo" class="secondary">Listar</button>
        <div id="msgInsumo" class="msg"></div>

        <table id="tblInsumos">
          <thead>
            <tr><th>ID</th><th>Nome</th><th>Unidade</th><th>Vendível</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="4" class="muted">(vazio)</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="cad-produtos" class="subtab hide">
      <div class="card">
        <h3>Produtos</h3>
        <label>Nome:
          <input id="pNome" placeholder="Ex: X-Burger" />
        </label>
        <label>É preparado?
          <select id="pPrep">
            <option value="">Selecione...</option>
            <option value="true">Sim</option>
            <option value="false">Não</option>
          </select>
        </label>

        <div id="inline-ficha" class="hide">
          <p class="muted">Após salvar, defina a ficha técnica na aba ao lado.</p>
        </div>

        <button id="btnAddProd">Salvar</button>
        <button id="btnListProd" class="secondary">Listar</button>
        <div id="msgProd" class="msg"></div>

        <table id="tblProdutos">
          <thead>
            <tr><th>ID</th><th>Nome</th><th>Preparado</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="3" class="muted">(vazio)</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="cad-ficha" class="subtab hide">
      <div class="card">
        <h3>Ficha Técnica</h3>

        <label>Produto:
          <select id="fpProd"></select>
        </label>
        <button id="fpBtnVer">Ver Ficha</button>

        <table id="fpTbl" style="margin-top:10px;">
          <thead>
            <tr><th>#</th><th>Insumo</th><th>Qtd</th><th>Unidade</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="4" class="muted">(vazio)</td></tr>
          </tbody>
        </table>

        <h4 style="margin-top:14px;">Adicionar Linha</h4>
        <label>Insumo:
          <select class="fpLinhaIns"></select>
        </label>
        <label>Qtd:
          <input class="fpLinhaQtd" type="number" step="0.01" />
        </label>
        <label>Unidade:
          <select class="fpLinhaUn">
            <option value="">Selecione...</option>
            <option value="kg">kg</option>
            <option value="g">g</option>
            <option value="un">un</option>
            <option value="ml">ml</option>
            <option value="l">l</option>
          </select>
        </label>
        <button id="fpBtnAddLinha" class="secondary">+ Adicionar linha</button>

        <table id="fpTblLinhas" style="margin-top:10px;">
          <thead>
            <tr><th>#</th><th>Insumo</th><th>Qtd</th><th>Un</th><th></th></tr>
          </thead>
          <tbody>
            <tr><td colspan="5" class="muted">(vazio)</td></tr>
          </tbody>
        </table>

        <button id="fpBtnSalvar">Salvar Ficha</button>
        <div id="fpMsg" class="msg"></div>
      </div>
    </div>
  </section>

  <!-- Aba: Estoque -->
  <section id="estoque" class="tab hide">
    <h2>Estoque</h2>

    <div class="subnav" data-subnav="est">
      <button data-subtab="est-entrada" class="active">Entrada</button>
      <button data-subtab="est-ajuste">Ajuste</button>
      <button data-subtab="est-conversoes">Conversões</button>
      <button data-subtab="est-saldos">Saldos</button>
    </div>

    <div id="est-entrada" class="subtab">
      <div class="card">
        <h3>Registrar Entrada</h3>
        <label>Insumo:
          <select id="eIns"></select>
        </label>
        <label>Qtd:
          <input id="eQtd" type="number" step="0.01" />
        </label>
        <label>Custo Total:
          <input id="eCusto" type="number" step="0.01" />
        </label>
        <button id="btnEntrada">Registrar Entrada</button>
        <div id="msgEnt" class="msg"></div>
      </div>
    </div>

    <div id="est-ajuste" class="subtab hide">
      <div class="card">
        <h3>Ajuste de Estoque</h3>
        <label>Insumo:
          <select id="aIns"></select>
        </label>
        <label>Qtd (ex: -1):
          <input id="aQtd" type="number" step="0.01" />
        </label>
        <label>Motivo:
          <input id="aMot" placeholder="Ex: quebra" />
        </label>
        <label>Custo Unitário (opcional):
          <input id="aCusto" type="number" step="0.01" />
        </label>
        <button id="btnAjuste" class="warning">Aplicar Ajuste</button>
        <div id="msgAj" class="msg"></div>
      </div>
    </div>

    <div id="est-conversoes" class="subtab hide">
      <div class="card">
        <h3>Conversões</h3>
        <label>Insumo:
          <select id="convIns"></select>
        </label>
        <label>De:
          <input id="convFrom" placeholder="Ex: kg" />
        </label>
        <label>Para:
          <input id="convTo" placeholder="Ex: g" />
        </label>
        <label>Fator:
          <input id="convFactor" type="number" step="0.0001" placeholder="Ex: 1000" />
        </label>
        <button id="btnConvAdd">Adicionar Conversão</button>
        <button id="btnConvList" class="secondary">Listar</button>
        <div id="msgConv" class="msg"></div>

        <table id="tblConv">
          <thead>
            <tr><th>De</th><th>Para</th><th>Fator</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="3" class="muted">(vazio)</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="est-saldos" class="subtab hide">
      <div class="card">
        <h3>Saldos</h3>
        <button id="btnSaldos">Atualizar Saldos</button>
        <table id="tblSaldos">
          <thead>
            <tr><th>Insumo</th><th>Unidade</th><th>Saldo</th><th>Custo Médio</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="4" class="muted">(vazio)</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <h3>Exportar Estoque CSV (BR)</h3>
        <button id="btnEstoqueMediaCSV">Exportar</button>
      </div>
    </div>
  </section>

  <!-- Aba: Financeiro -->
  <section id="financeiro" class="tab hide">
    <h2>Financeiro</h2>

    <div class="subnav" data-subnav="fin">
      <button data-subtab="fin-fornecedores" class="active">Fornecedores</button>
      <button data-subtab="fin-tipos">Tipos de Despesa</button>
      <button data-subtab="fin-contas">Contas</button>
      <button data-subtab="fin-pagamentos">Pagamentos</button>
    </div>

    <div id="fin-fornecedores" class="subtab">
      <div class="card">
        <h3>Fornecedores</h3>
        <label>Nome:
          <input id="fForNome" placeholder="Ex: Supermercado Central" />
        </label>
        <label>Documento:
          <input id="fForDoc" placeholder="CNPJ/CPF" />
        </label>
        <button id="btnAddForn">Salvar</button>
        <button id="btnListForn" class="secondary">Listar</button>
        <div id="msgForn" class="msg"></div>

        <table id="tblForns">
          <thead>
            <tr><th>ID</th><th>Nome</th><th>Documento</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="3" class="muted">(vazio)</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="fin-tipos" class="subtab hide">
      <div class="card">
        <h3>Tipos de Despesa</h3>
        <label>Nome:
          <input id="fTipoNome" placeholder="Ex: Energia elétrica" />
        </label>
        <button id="btnAddTipo">Salvar</button>
        <button id="btnListTipo" class="secondary">Listar</button>
        <div id="msgTipo" class="msg"></div>

        <table id="tblTipos">
          <thead>
            <tr><th>ID</th><th>Nome</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="2" class="muted">(vazio)</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="fin-contas" class="subtab hide">
      <div class="card">
        <h3>Contas</h3>
        <label>Nome:
          <input id="fContaNome" placeholder="Ex: Caixa Principal" />
        </label>
        <label>Tipo:
          <select id="fContaTipo">
            <option value="caixa">Caixa</option>
            <option value="banco">Banco</option>
            <option value="cartão">Cartão</option>
          </select>
        </label>
        <button id="btnAddConta">Salvar</button>
        <button id="btnListConta" class="secondary">Listar</button>
        <div id="msgConta" class="msg"></div>

        <table id="tblContas">
          <thead>
            <tr><th>ID</th><th>Nome</th><th>Tipo</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="3" class="muted">(vazio)</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="fin-pagamentos" class="subtab hide">
      <div class="card">
        <h3>Pagamentos</h3>
        <label>Fornecedor:
          <select id="pForn"></select>
        </label>
        <label>Tipo:
          <select id="pTipo"></select>
        </label>
        <label>Conta:
          <select id="pConta"></select>
        </label>
        <label>Valor:
          <input id="pValor" type="number" step="0.01" />
        </label>
        <label>Data:
          <input id="pData" placeholder="DD/MM/AAAA" />
        </label>
        <label>Observação:
          <input id="pObs" />
        </label>
        <button id="btnAddPgto">Salvar</button>
        <button id="btnListPgto" class="secondary">Listar</button>
        <div id="msgPgto" class="msg"></div>

        <table id="tblPgto">
          <thead>
            <tr>
              <th>ID</th><th>Data</th><th>Fornecedor</th><th>Tipo</th>
              <th>Conta</th><th>Valor</th><th>Obs</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7" class="muted">(vazio)</td></tr>
          </tbody>
        </table>

        <button id="btnPagamentosCSV">Exportar CSV-BR</button>
      </div>
    </div>
  </section>

  <!-- Aba: Relatórios -->
  <section id="relatorios" class="tab hide">
    <h2>Relatórios</h2>

    <div class="subnav" data-subnav="rel">
      <button data-subtab="rel-estoque" class="active">Estoque</button>
      <button data-subtab="rel-vendas">Vendas</button>
      <button data-subtab="rel-mov">Movimentações</button>
    </div>

    <div id="rel-estoque" class="subtab">
      <div class="card">
        <h3>Relatório de Estoque</h3>
        <p class="muted">Mostra saldo e custo médio por insumo.</p>
        <button id="btnRelEst">Gerar</button>
        <button id="btnRelEstoqueCSV" class="secondary">Exportar CSV-BR</button>


        <table id="tblRelEst" style="margin-top:10px;">
          <thead>
            <tr>
              <th>Insumo</th><th>Unidade</th><th>Saldo</th><th>Custo Médio</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="4" class="muted">(vazio)</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="rel-vendas" class="subtab hide">
      <div class="card">
        <h3>Relatório de Vendas</h3>
        <div style="display:flex; flex-wrap:wrap; gap:16px;">
          <label style="min-width:220px;">Data inicial:
            <input id="rvIni" placeholder="DD/MM/AAAA" />
          </label>
          <label style="min-width:220px;">Data final:
            <input id="rvFim" placeholder="DD/MM/AAAA" />
          </label>
        </div>
        <button id="btnRelV">Gerar</button>
        <button id="btnVendasCSVBR" class="secondary">Exportar CSV-BR</button>

        <table id="tblVendas" style="margin-top:10px;">
          <thead>
            <tr>
              <th>ID</th><th>Data</th><th>Produto</th><th>Preço</th>
              <th>Qtd</th><th>Tipo</th><th>Comentário</th><th>Pgto</th>
              <th>Cancelada</th><th>Consumo</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="10" class="muted">(vazio)</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="rel-mov" class="subtab hide">
      <div class="card">
        <h3>Relatório de Movimentações</h3>
        <div style="display:flex; flex-wrap:wrap; gap:16px;">
          <label style="min-width:220px;">Data inicial:
            <input id="rmi" placeholder="DD/MM/AAAA" />
          </label>
          <label style="min-width:220px;">Data final:
            <input id="rmf" placeholder="DD/MM/AAAA" />
          </label>
        </div>
        <button id="btnRelMov">Gerar</button>

        <table id="tblRelMov" style="margin-top:10px;">
          <thead>
            <tr>
              <th>ID</th><th>Data</th><th>Insumo</th><th>Qtd</th>
              <th>Un</th><th>Custo</th><th>Origem</th><th>Tipo</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="8" class="muted">(vazio)</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Aba: Vendas -->
  <section id="vendas" class="tab hide">
    <h2>Vendas</h2>
    <div class="card">
      <p class="muted">A lógica de vendas será adicionada nas próximas partes.</p>
    </div>
  </section>
</main>

<footer>
  <p class="muted">Demo 100% front-end. Ao atualizar a página (F5), os dados são apagados.</p>
</footer>

<script>
/* ===========================================
   PARTE 1 — Base + Navegação (Demo 100% front)
   =========================================== */

/* 1) Estado volátil (nada persiste, F5 apaga) */
window.DB = {
  // cadastros
  insumos: [], produtos: [], ficha: {}, _convs: {},
  // estoque + movimentos
  estoque: {}, movs: [],
  // financeiro
  fornecedores: [], tipos: [], contas: [], pagamentos: [],
  // vendas
  vendas: []
};

/* 2) Helpers básicos (sem backend) */
window.setMsg = function(el, text, ok){
  if(!el) return;
  el.className = "msg " + (ok ? "ok" : "err");
  el.textContent = text || "";
};
window.isoToBr = function(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if (isNaN(d)) return "";
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
};
window.brToIso = function(br){
  if(!br) return "";
  const m = br.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(!m) return "";
  const [_, dd, mm, yy] = m;
  return `${yy}-${mm}-${dd}`;
};
// formatadores úteis em PT-BR
window.brMoney = new Intl.NumberFormat("pt-BR",{ style:"currency", currency:"BRL" });
window.brQty3  = new Intl.NumberFormat("pt-BR",{ minimumFractionDigits:3, maximumFractionDigits:3 });

/* 3) Navegação — conserta abas principais e sub-abas */
(function setupTabs(){
  // Abas principais (nav)
  const mainButtons = document.querySelectorAll('nav button[data-tab]');
  const sections    = document.querySelectorAll('main .tab');

  function showMainTab(id){
    sections.forEach(sec => sec.classList.add('hide'));
    document.getElementById(id)?.classList.remove('hide');
    mainButtons.forEach(b => b.classList.remove('active'));
    const btn = document.querySelector(`nav button[data-tab="${id}"]`);
    btn?.classList.add('active');
    // Ao abrir uma aba principal, ativa a primeira sub-aba (se houver)
    const sect = document.getElementById(id);
    const subnav = sect?.querySelector('.subnav[data-subnav]');
    if (subnav){
      const first = subnav.querySelector('button[data-subtab].active') || subnav.querySelector('button[data-subtab]');
      first && first.click();
    }
  }

  mainButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-tab');
      showMainTab(id);
    });
  });

  // Sub-abas (cada .subnav controla as .subtab dentro da MESMA section)
  document.querySelectorAll('.subnav[data-subnav]').forEach(subnav=>{
    const parentSection = subnav.closest('section.tab');
    const subButtons = subnav.querySelectorAll('button[data-subtab]');
    subButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        const targetId = b.getAttribute('data-subtab');
        // alterna active no submenu
        subButtons.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        // esconde todas as subtelas da seção e mostra a selecionada
        parentSection.querySelectorAll('.subtab').forEach(div=>div.classList.add('hide'));
        parentSection.querySelector('#'+targetId)?.classList.remove('hide');
      });
    });
  });

  // Boot inicial: abre "home"
  showMainTab('home');
})();




/* --- Utils específicos de cadastros --- */
function nextId(arr){ return (arr && arr.length) ? Math.max(...arr.map(x=>+x.id||0))+1 : 1; }
function findInsumo(id){ return (DB.insumos||[]).find(x=>+x.id===+id) || null; }
function findProduto(id){ return (DB.produtos||[]).find(x=>+x.id===+id) || null; }

/* --- Renderizadores de tabela --- */
function renderInsumos(){
  const tb = document.querySelector("#tblInsumos tbody");
  if(!tb) return;
  const data = DB.insumos || [];
  tb.innerHTML = data.length
    ? data.map(i=>`<tr>
        <td>${i.id}</td>
        <td>${i.nome}</td>
        <td>${i.unidade}</td>
        <td>${i.vendivel ? "Sim" : "Não"}</td>
      </tr>`).join("")
    : `<tr><td colspan="4" class="muted">(vazio)</td></tr>`;
}

function renderProdutos(){
  const tb = document.querySelector("#tblProdutos tbody");
  if(!tb) return;
  const data = DB.produtos || [];
  tb.innerHTML = data.length
    ? data.map(p=>`<tr>
        <td>${p.id}</td>
        <td>${p.nome}</td>
        <td>${p.preparado ? "Sim" : "Não"}</td>
      </tr>`).join("")
    : `<tr><td colspan="3" class="muted">(vazio)</td></tr>`;

  // Atualiza select de produto na Ficha Técnica
  const sel = document.getElementById("fpProd");
  if(sel){
    sel.innerHTML = `<option value="">Selecione…</option>` +
      data.map(p=>`<option value="${p.id}">${p.id} - ${p.nome}</option>`).join("");
  }
}

/* --- Selects de Insumos (usados também por outras abas depois) --- */
function refreshInsumoSelects(){
  const data = DB.insumos || [];
  const opts = [`<option value="">Selecione…</option>`]
    .concat(data.map(i => `<option value="${i.id}">${i.id} - ${i.nome} (${i.unidade})</option>`))
    .join("");

  // Estes aparecem em outras abas, mas não tem problema atualizar já
  ["convIns","eIns","aIns"].forEach(id=>{
    const sel = document.getElementById(id);
    if(sel) sel.innerHTML = opts;
  });

  // Ficha técnica - linhas temporárias
  document.querySelectorAll(".fpLinhaIns").forEach(sel => sel.innerHTML = opts);
}

/* --- Ações de cadastro --- */
function addInsumo(nome, unidade, vendivel){
  DB.insumos ||= [];
  const row = { id: nextId(DB.insumos), nome: String(nome).trim(), unidade: String(unidade).trim(), vendivel: !!vendivel };
  DB.insumos.push(row);
  // estoque base zerado para novo insumo
  DB.estoque[row.id] = { saldo:0, custoMedio:0 };
  return row;
}

function addProduto(nome, preparado){
  DB.produtos ||= [];
  const row = { id: nextId(DB.produtos), nome: String(nome).trim(), preparado: !!(String(preparado)==="true" || preparado===true) };
  DB.produtos.push(row);
  // ficha vazia
  DB.ficha[row.id] ||= [];
  return row;
}

/* --- Ficha Técnica --- */
let _fichaTemp = []; // linhas temporárias antes de salvar

function renderFichaTabela(prodId){
  const tb = document.querySelector("#fpTbl tbody");
  if(!tb) return;
  const list = DB.ficha[prodId] || [];
  tb.innerHTML = list.length
    ? list.map((l,ix)=>`<tr>
        <td>${ix+1}</td>
        <td>${(findInsumo(l.insumo_id)?.nome) || ""}</td>
        <td>${l.quantidade}</td>
        <td>${l.unidade}</td>
      </tr>`).join("")
    : `<tr><td colspan="4" class="muted">(vazio)</td></tr>`;
}

function renderFichaLinhasTemp(){
  const tb = document.querySelector("#fpTblLinhas tbody");
  if(!tb) return;
  tb.innerHTML = _fichaTemp.length
    ? _fichaTemp.map((l,ix)=>`
      <tr>
        <td>${ix+1}</td>
        <td>${(findInsumo(+l.insumo_id)?.nome)||""}</td>
        <td>${l.quantidade}</td>
        <td>${l.unidade}</td>
        <td><button class="secondary" data-remove-line="${ix}">Remover</button></td>
      </tr>`).join("")
    : `<tr><td colspan="5" class="muted">(vazio)</td></tr>`;

  // Remover linha temporária
  document.querySelectorAll('[data-remove-line]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const ix = +btn.getAttribute('data-remove-line');
      _fichaTemp.splice(ix,1);
      renderFichaLinhasTemp();
    });
  });
}

/* --- Bindings de UI (Cadastros) --- */
// Insumos
document.getElementById("btnAddInsumo")?.addEventListener("click", ()=>{
  const nome = document.getElementById("iNome")?.value.trim();
  const unidade = document.getElementById("iUni")?.value.trim();
  const vend = document.getElementById("iVend")?.checked || false;
  const msg = document.getElementById("msgInsumo");
  if(!nome || !unidade){ setMsg(msg,"Preencha nome e unidade.",false); return; }
  addInsumo(nome, unidade, vend);
  setMsg(msg,"Insumo salvo!",true);
  document.getElementById("iNome").value="";
  document.getElementById("iUni").value="";
  document.getElementById("iVend").checked=false;
  renderInsumos();
  refreshInsumoSelects();
});
document.getElementById("btnListInsumo")?.addEventListener("click", renderInsumos);

// Produtos
document.getElementById("btnAddProd")?.addEventListener("click", ()=>{
  const nome = document.getElementById("pNome")?.value.trim();
  const prepVal = document.getElementById("pPrep")?.value;
  const msg = document.getElementById("msgProd");
  if(!nome || (prepVal!=="true" && prepVal!=="false")){
    setMsg(msg,"Preencha nome e se é preparado.",false); return;
  }
  const p = addProduto(nome, prepVal==="true");
  setMsg(msg, p.preparado
    ? "Produto salvo! Defina a ficha técnica na aba ao lado."
    : "Produto salvo!", true);
  // dica visual
  const inline = document.getElementById("inline-ficha");
  if(inline) inline.classList.toggle("hide", prepVal!=="true");

  document.getElementById("pNome").value="";
  document.getElementById("pPrep").value="";
  renderProdutos();
});
document.getElementById("btnListProd")?.addEventListener("click", renderProdutos);

// Ficha técnica
document.getElementById("fpBtnVer")?.addEventListener("click", ()=>{
  const pid = parseInt(document.getElementById("fpProd")?.value||"0",10);
  if(!pid){ setMsg(document.getElementById("fpMsg"),"Selecione um produto.",false); return; }
  renderFichaTabela(pid);
  setMsg(document.getElementById("fpMsg"),"",true);
});

document.getElementById("fpBtnAddLinha")?.addEventListener("click", ()=>{
  const $ins = document.querySelector(".fpLinhaIns"),
        $q   = document.querySelector(".fpLinhaQtd"),
        $u   = document.querySelector(".fpLinhaUn");
  const insumo_id = parseInt(($ins?.value||"0"),10);
  const quantidade = parseFloat(($q?.value||"0"));
  const unidade = ($u?.value||"").trim();
  if(!insumo_id || !(quantidade>0) || !unidade){
    setMsg(document.getElementById("fpMsg"),"Preencha insumo, quantidade > 0 e unidade.",false); return;
  }
  _fichaTemp.push({ insumo_id, quantidade:+quantidade, unidade });
  renderFichaLinhasTemp();
  if($q) $q.value=""; if($u) $u.value="";
  setMsg(document.getElementById("fpMsg"),"Linha adicionada (temporária).",true);
});

document.getElementById("fpBtnSalvar")?.addEventListener("click", ()=>{
  const pid = parseInt(document.getElementById("fpProd")?.value||"0",10);
  if(!pid){ setMsg(document.getElementById("fpMsg"),"Selecione um produto.",false); return; }
  DB.ficha[pid] = (_fichaTemp||[]).map(l=>({...l, insumo_id:+l.insumo_id, quantidade:+l.quantidade}));
  _fichaTemp = [];
  renderFichaLinhasTemp();
  renderFichaTabela(pid);
  setMsg(document.getElementById("fpMsg"),"Ficha técnica salva!",true);
});

/* --- Seed opcional do demo (para testar rápido) --- */
document.addEventListener("DOMContentLoaded", ()=>{
  if ((DB.insumos||[]).length===0 && (DB.produtos||[]).length===0){
    addInsumo("Queijo Mussarela","kg",false);
    addInsumo("Refrigerante Lata","un",true);
    addProduto("X-Burger",true);
  }
  renderInsumos();
  renderProdutos();
  refreshInsumoSelects();
});




/* --- Helpers base de estoque/movimentação --- */
function ensureEstoque(insumo_id){
  DB.estoque ||= {};
  return (DB.estoque[insumo_id] ||= { saldo:0, custoMedio:0 });
}
function nextMovId(){ 
  return (DB.movs && DB.movs.length) ? Math.max(...DB.movs.map(x=>+x.id||0))+1 : 1; 
}
function addMov(m){
  const row = {
    id: nextMovId(),
    dataISO: m.dataISO || new Date().toISOString(),
    insumo_id: +m.insumo_id,
    insumo_nome: String(m.insumo_nome||""),
    quantidade: +m.quantidade,
    unidade: String(m.unidade||""),
    custo_total: +m.custo_total||0,
    origem: String(m.origem||""),
    tipo: String(m.tipo||"")
  };
  DB.movs.push(row);
  return row;
}



/* --- Conversões --- */
const BUILTIN_FACTORS = {
  "kg|g":  1000.0,
  "g|kg":  0.001,
  "l|ml":  1000.0,
  "ml|l":  0.001
};
function normUnit(u){ return String(u||"").trim().toLowerCase(); }
function getConvFactor(insumo_id, de_un, para_un){
  const de = normUnit(de_un), para = normUnit(para_un);
  if(!de || !para) return null;
  if(de===para) return 1.0;

  // 1) específica do insumo
  const arr = (DB._convs?.[insumo_id] || []);
  const row = arr.find(c => normUnit(c.de_unidade)===de && normUnit(c.para_unidade)===para);
  if(row && +row.fator>0) return +row.fator;

  // 2) built-in
  return BUILTIN_FACTORS[`${de}|${para}`] ?? null;
}
function toBaseQty(insumo, qtd, un_origem){
  const base = normUnit(insumo?.unidade);
  const from = normUnit(un_origem);
  if(!base) return null;
  if(base===from) return +qtd;
  const f = getConvFactor(insumo.id, from, base);
  if(f==null) return null;
  return +qtd * +f;
}

/* --- UI: Conversões (lista/salvar) --- */
function listConversoes(){
  const insumo_id = parseInt(document.getElementById("convIns")?.value || "0", 10);
  const tbody = document.querySelector("#tblConv tbody");
  if (!tbody) return;

  if (!insumo_id) {
    tbody.innerHTML = `<tr><td colspan="3" class="muted">Selecione um insumo.</td></tr>`;
    return;
  }
  const arr = (DB._convs[insumo_id] || []);
  tbody.innerHTML = arr.length
    ? arr.map(c => `<tr><td>${c.de_unidade}</td><td>${c.para_unidade}</td><td>${brQty3.format(+c.fator)}</td></tr>`).join("")
    : `<tr><td colspan="3" class="muted">(vazio)</td></tr>`;
}
function saveConversao(){
  const insumo_id = parseInt(document.getElementById("convIns")?.value || "0", 10);
  const de_unidade = (document.getElementById("convFrom")?.value || "").trim();
  const para_unidade = (document.getElementById("convTo")?.value || "").trim();
  const fator = parseFloat(document.getElementById("convFactor")?.value || "0");
  const msg = document.getElementById("msgConv");

  if (!insumo_id || !de_unidade || !para_unidade || !(fator > 0)) {
    setMsg(msg, "Preencha insumo, de, para e fator > 0.", false);
    return;
  }

  const arr = (DB._convs[insumo_id] ||= []);
  const ix = arr.findIndex(c => normUnit(c.de_unidade)===normUnit(de_unidade) && normUnit(c.para_unidade)===normUnit(para_unidade));
  if (ix >= 0) arr[ix].fator = +fator; else arr.push({ de_unidade, para_unidade, fator:+fator });

  setMsg(msg, "Conversão salva!", true);
  const ff = document.getElementById("convFactor"); if (ff) ff.value = "";
  listConversoes();
}
document.getElementById("btnConvAdd")?.addEventListener("click", saveConversao);
document.getElementById("btnConvList")?.addEventListener("click", listConversoes);

/* --- ESTOQUE: Entrada (custo médio) --- */
function entradaMedia({ insumo_id, quantidade, custo_total }){
  const e = ensureEstoque(insumo_id);
  const qtd = +quantidade;
  const custo = +custo_total;
  const somaAnt = e.saldo * e.custoMedio;
  e.saldo += qtd;
  e.custoMedio = e.saldo > 0 ? (somaAnt + custo) / e.saldo : 0;

  const ins = findInsumo(insumo_id);
  addMov({
    dataISO: new Date().toISOString(),
    insumo_id,
    insumo_nome: ins?.nome || "",
    quantidade: +qtd,
    unidade: ins?.unidade || "",
    custo_total: +custo,
    origem: "entrada",
    tipo: "entrada-media"
  });
}

/* --- ESTOQUE: Ajuste (perda / reprecificação / ajuste simples) --- */
function ajusteMedia({ insumo_id, quantidade, motivo, custo_unitario }){
  const e = ensureEstoque(insumo_id);
  const qtd = +quantidade;
  const ins = findInsumo(insumo_id);
  const un  = ins?.unidade || "";

  // Regras:
  // - Se custo_unitario é número válido e qtd == 0 => reprecificação
  // - Se qtd < 0 e motivo contém perda/quebra/vencimento => baixa sem custo e zera custoMedio se saldo zerar
  // - Caso geral: saldo += qtd; se saldo <= 0 => zera custoMedio
  const lowMot = String(motivo||"").toLowerCase();
  const isPerda = (qtd < 0) && (lowMot.includes("perd") || lowMot.includes("quebr") || lowMot.includes("venci"));

  let origem = "ajuste";
  let custo_reg = 0;

  if (!Number.isNaN(+custo_unitario) && custo_unitario!==undefined && custo_unitario!==null && String(custo_unitario)!==""){
    const cu = +custo_unitario;
    if (Math.abs(qtd) < 1e-12) {
      // reprecificação
      origem = "reprecificacao";
      if(e.saldo > 0) e.custoMedio = cu; else e.custoMedio = 0;
    } else if (qtd > 0) {
      // ajuste com custo => recalcula custo médio com esta "entrada técnica"
      origem = "ajuste";
      const somaAnt = e.saldo * e.custoMedio;
      const custo = cu * qtd;
      const saldoNovo = e.saldo + qtd;
      e.custoMedio = saldoNovo > 0 ? (somaAnt + custo) / saldoNovo : 0;
      e.saldo = saldoNovo;
      custo_reg = custo;
    } else {
      // qtd < 0 com custo_unitario informado: vamos apenas abater saldo, custoMedio permanece
      e.saldo = Math.max(e.saldo + qtd, 0);
      if (e.saldo <= 0) e.custoMedio = 0;
    }
  } else if (isPerda) {
    origem = "perda";
    e.saldo = Math.max(e.saldo + qtd, 0);
    if (e.saldo <= 0) e.custoMedio = 0;
  } else {
    origem = "ajuste";
    e.saldo = Math.max(e.saldo + qtd, 0);
    if (e.saldo <= 0) e.custoMedio = 0;
  }

  addMov({
    dataISO: new Date().toISOString(),
    insumo_id,
    insumo_nome: ins?.nome || "",
    quantidade: +qtd,
    unidade: un,
    custo_total: +custo_reg,
    origem,
    tipo: (origem==="reprecificacao" ? "reprecificacao" : "ajuste-media")
  });
}

/* --- SALDOS (render para grid) --- */
function saldosMedia(){
  return (DB.insumos||[]).map(ins => {
    const st = DB.estoque[ins.id] || { saldo:0, custoMedio:0 };
    return { insumo_id:ins.id, insumo_nome:ins.nome, unidade:ins.unidade, saldo:+st.saldo, custo_medio:+st.custoMedio };
  });
}
function loadSaldos(){
  const data = saldosMedia();
  // tenta na tela Estoque; senão no relatório de estoque
  const tbody = document.querySelector("#tblSaldos tbody") || document.querySelector("#tblRelEst tbody");
  if (!tbody) return;

  tbody.innerHTML = data.length
    ? data.map(x=>`
      <tr>
        <td>${x.insumo_nome}</td>
        <td>${x.unidade}</td>
        <td>${brQty3.format(+x.saldo)}</td>
        <td>${brMoney.format(+(x.custo_medio||0))}</td>
      </tr>
    `).join("")
    : `<tr><td colspan="4" class="muted">(vazio)</td></tr>`;
}

/* --- Export CSV (BR) — Estoque --- */
function exportEstoqueBR(){
  const rows = saldosMedia();
  const header = ["insumo","unidade","saldo","custo_medio"];
  const lines = [header.join(";")].concat(
    rows.map(r=>[
      `"${(r.insumo_nome||"").replace(/"/g,'""')}"`,
      `"${(r.unidade||"")}"`,
      String(r.saldo).replace(".", ","),              // número BR
      brMoney.format(+r.custo_medio||0).replace(/\s/g,"")
    ].join(";"))
  );
  const csv = lines.join("\r\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "estoque.csv";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* --- Binds dos botões de Estoque --- */
document.getElementById("btnEntrada")?.addEventListener("click", ()=>{
  const insumo_id = parseInt(document.getElementById("eIns")?.value||"0",10);
  const quantidade = parseFloat(document.getElementById("eQtd")?.value||"0");
  const custo_total = parseFloat(document.getElementById("eCusto")?.value||"0");
  if(!insumo_id || !(quantidade>0) || !(custo_total>=0)){
    setMsg(document.getElementById("msgEnt"),"Preencha insumo, quantidade > 0 e custo.",false); return;
  }
  entradaMedia({ insumo_id, quantidade, custo_total });
  setMsg(document.getElementById("msgEnt"),"Entrada registrada!",true);
  document.getElementById("eQtd").value=""; document.getElementById("eCusto").value="";
  loadSaldos();
});

document.getElementById("btnAjuste")?.addEventListener("click", ()=>{
  const insumo_id = parseInt(document.getElementById("aIns")?.value||"0",10);
  const quantidade = parseFloat(document.getElementById("aQtd")?.value||"0");
  const motivo = (document.getElementById("aMot")?.value||"").trim();
  const custo_unitario = parseFloat(document.getElementById("aCusto")?.value||"");
  if(!insumo_id || !quantidade){
    setMsg(document.getElementById("msgAj"),"Preencha insumo e quantidade (pode ser negativa).",false); return;
  }
  ajusteMedia({
    insumo_id,
    quantidade,
    motivo,
    custo_unitario: Number.isNaN(custo_unitario) ? undefined : custo_unitario
  });
  setMsg(document.getElementById("msgAj"),"Ajuste aplicado!",true);
  document.getElementById("aQtd").value=""; document.getElementById("aMot").value=""; document.getElementById("aCusto").value="";
  loadSaldos();
});

document.getElementById("btnSaldos")?.addEventListener("click", loadSaldos);
document.getElementById("btnEstoqueMediaCSV")?.addEventListener("click", exportEstoqueBR);

/* --- Boot parcial (quando a aba carregar) --- */
document.addEventListener("DOMContentLoaded", ()=>{
  // se tiver dados seed da Parte 2, apenas atualiza
  loadSaldos();
});




/* === VENDAS === */
function nextVendaId(){ return (DB.vendas && DB.vendas.length) ? Math.max(...DB.vendas.map(v=>+v.venda_id||0))+1 : 1; }

function _pushVenda(v){
  DB.vendas ||= [];
  const row = {
    venda_id: v.venda_id ?? nextVendaId(),
    data: v.data || new Date().toISOString(),
    produto_id: v.produto_id ?? null,
    produto_nome: v.produto_nome ?? null,
    insumo_id: v.insumo_id ?? null,           // quando venda direta
    insumo_nome: v.insumo_nome ?? null,       // (não usado nos relatórios principais)
    preco_venda: +v.preco_venda || 0,
    quantidade: +v.quantidade || 1,
    tipo: v.tipo || "normal",                 // normal|cortesia|consumo
    comentario: v.comentario || "",
    forma_pagamento: v.forma_pagamento || "",
    cancelada: !!v.cancelada,
    consumos: Array.isArray(v.consumos) ? v.consumos.slice() : [], // [{insumo_id, insumo_nome, consumo_base, unidade_base}]
    avisos: Array.isArray(v.avisos) ? v.avisos.slice() : []
  };
  DB.vendas.push(row);
  return row;
}

/**
 * registraVenda({
 *   // caso A: venda direta de insumo
 *   insumo_id, quantidade, preco_venda, tipo?, comentario?, forma_pagamento?
 *
 *   // caso B: produto preparado
 *   produto_id, quantidade, preco_venda, tipo?, comentario?, forma_pagamento?
 * })
 */
function registraVenda(payload){
  const produto_id = +((payload.produto_id||0));
  const insumo_id  = +((payload.insumo_id||0));
  const quantidade = +(payload.quantidade||0);
  const preco_venda = +(payload.preco_venda||0);
  const tipo = (payload.tipo||"normal").trim();
  const comentario = (payload.comentario||"").trim();
  const forma_pagamento = (payload.forma_pagamento||"").trim() || "";

  if ((produto_id<=0) === (insumo_id<=0)) {
    throw new Error("Informe exatamente UM: produto_id OU insumo_id.");
  }
  if (!(quantidade>0)) throw new Error("Campo 'quantidade' deve ser > 0.");
  if (preco_venda < 0) throw new Error("Preço inválido.");
  if (!["normal","cortesia","consumo"].includes(tipo)) throw new Error("Tipo inválido.");
  if (["cortesia","consumo"].includes(tipo) && !comentario) throw new Error("Comentário obrigatório em cortesia/consumo.");

  const avisos = [];
  const consumos = [];

  // ----------------------
  // Caso A: venda direta de INSUMO
  // ----------------------
  if (insumo_id > 0){
    const ins = findInsumo(insumo_id);
    if(!ins) throw new Error("Insumo não encontrado.");
    if(!ins.vendivel) throw new Error("Este insumo não está marcado como vendível direto.");

    const e = ensureEstoque(insumo_id);
    let consumir = quantidade; // já na unidade base do insumo (demo não tem unidade de venda diferente)
    if (e.saldo < consumir - 1e-9){
      avisos.push(`Estoque insuficiente de ${ins.nome}: faltaram ${brQty3.format(consumir - e.saldo)} ${ins.unidade}`);
      consumir = Math.max(Math.min(e.saldo, consumir), 0);
    }

    e.saldo = Math.max(e.saldo - consumir, 0);
    if (e.saldo <= 1e-12) e.custoMedio = 0;

    addMov({
      insumo_id: ins.id,
      insumo_nome: ins.nome,
      quantidade: -consumir,
      unidade: ins.unidade,
      origem: "venda",
      tipo: "venda"
    });

    consumos.push({ insumo_id: ins.id, insumo_nome: ins.nome, consumo_base: +consumir, unidade_base: ins.unidade });

    return _pushVenda({
      produto_id: null, produto_nome: null,
      insumo_id: ins.id, insumo_nome: ins.nome,
      preco_venda: (tipo==="normal" ? preco_venda : 0),
      quantidade, tipo, comentario, forma_pagamento,
      consumos, avisos
    });
  }

  // ----------------------
  // Caso B: venda de PRODUTO PREPARADO
  // ----------------------
  const prod = findProduto(produto_id);
  if(!prod) throw new Error("Produto não encontrado.");
  if(!prod.preparado) throw new Error("Produto não é 'preparado'. Para itens simples, venda pelo insumo.");

  const itens = DB.ficha[produto_id] || [];
  if(!itens.length) throw new Error("Produto preparado sem ficha técnica.");

  // Para cada item da ficha: consome (quantidade * item.quantidade) convertido à unidade base do insumo
  itens.forEach(it=>{
    const ins = findInsumo(it.insumo_id);
    if(!ins){
      avisos.push(`Insumo ${it.insumo_id} não encontrado na ficha`);
      return;
    }
    const qtd_total_item = (+it.quantidade||0) * quantidade;
    const qtd_total_base = toBaseQty(ins, qtd_total_item, it.unidade);
    if (qtd_total_base==null){
      avisos.push(`Sem conversão cadastrada de '${it.unidade}' para '${ins.unidade}' para o insumo '${ins.nome}'.`);
      return;
    }

    const e = ensureEstoque(ins.id);
    let consumir = +qtd_total_base;
    if (e.saldo < consumir - 1e-9){
      avisos.push(`Estoque insuficiente de ${ins.nome}: faltaram ${brQty3.format(consumir - e.saldo)} ${ins.unidade}`);
      consumir = Math.max(Math.min(e.saldo, consumir), 0);
    }
    e.saldo = Math.max(e.saldo - consumir, 0);
    if (e.saldo <= 1e-12) e.custoMedio = 0;

    addMov({
      insumo_id: ins.id,
      insumo_nome: ins.nome,
      quantidade: -consumir,
      unidade: ins.unidade,
      origem: "venda",
      tipo: "venda"
    });

    consumos.push({ insumo_id: ins.id, insumo_nome: ins.nome, consumo_base: +consumir, unidade_base: ins.unidade });
  });

  return _pushVenda({
    produto_id, produto_nome: prod.nome,
    insumo_id: null, insumo_nome: null,
    preco_venda: (tipo==="normal" ? preco_venda : 0),
    quantidade, tipo, comentario, forma_pagamento,
    consumos, avisos
  });
}

/* Cancelamento de venda (estorna consumos para o estoque) */
function cancelarVenda(venda_id, motivo=""){
  const v = (DB.vendas||[]).find(x=>+x.venda_id===+venda_id);
  if(!v) throw new Error("Venda não encontrada.");
  if(v.cancelada) throw new Error("Venda já cancelada.");

  v.cancelada = true;
  v.cancel_motivo = motivo || "cancelamento";
  v.cancel_data = new Date().toISOString();

  (v.consumos||[]).forEach(c=>{
    const ins = findInsumo(c.insumo_id);
    const e = ensureEstoque(c.insumo_id);
    e.saldo += (+c.consumo_base||0);
    if (e.saldo <= 1e-12) e.custoMedio = 0; // sem custo se saldo zerar

    addMov({
      insumo_id: c.insumo_id,
      insumo_nome: ins?.nome || "",
      quantidade: +(c.consumo_base||0),
      unidade: ins?.unidade || "",
      origem: "cancelamento",
      tipo: "cancelamento"
    });
  });

  return { ok:true, venda_id: v.venda_id, cancelada:true, motivo: v.cancel_motivo, data: v.cancel_data };
}

/* === CSV BR de Vendas (relatório usa esta função) === */
function exportVendasBR(){
  const rows = [];
  (DB.vendas||[]).forEach(v=>{
    if(!v.consumos || !v.consumos.length){
      rows.push({
        venda_id:v.venda_id,
        data:v.data,
        produto_nome:v.produto_nome||"",
        preco_venda:(+v.preco_venda||0),
        quantidade:+(v.quantidade||0),
        tipo:v.tipo||"",
        comentario:v.comentario||"",
        forma_pagamento:v.forma_pagamento||"",
        cancelada: v.cancelada ? "SIM" : "NAO",
        insumo_nome:"", consumo_base:"", unidade_base:""
      });
    } else {
      v.consumos.forEach(c=>{
        rows.push({
          venda_id:v.venda_id,
          data:v.data,
          produto_nome:v.produto_nome||"",
          preco_venda:(+v.preco_venda||0),
          quantidade:+(v.quantidade||0),
          tipo:v.tipo||"",
          comentario:v.comentario||"",
          forma_pagamento:v.forma_pagamento||"",
          cancelada: v.cancelada ? "SIM" : "NAO",
          insumo_nome:c.insumo_nome||"",
          consumo_base:(+c.consumo_base||0),
          unidade_base:c.unidade_base||""
        });
      });
    }
  });

  const header = ["venda_id","data","produto","preco_venda","quantidade","tipo","comentario","forma_pagamento","cancelada","insumo_nome","consumo_base","unidade_base"];
  const lines = [header.join(";")].concat(
    rows.map(r=>[
      r.venda_id,
      `"${(r.data||"").toString().slice(0,10)}"`,
      `"${(r.produto_nome||"").replace(/"/g,'""')}"`,
      String((+r.preco_venda||0).toFixed(2)).replace(".",","),
      String(+r.quantidade||0).replace(".",","),
      `"${(r.tipo||"")}"`,
      `"${(r.comentario||"").replace(/"/g,'""')}"`,
      `"${(r.forma_pagamento||"")}"`,
      r.cancelada,
      `"${(r.insumo_nome||"").replace(/"/g,'""')}"`,
      String(r.consumo_base!==""?+r.consumo_base:"").replace(".",","),
      `"${(r.unidade_base||"")}"`
    ].join(";"))
  );
  const csv = lines.join("\r\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "vendas.csv";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}


/* ==========================================================
   FORNECEDORES
   ========================================================== */
function addFornecedor(nome, documento){
  const id = nextId(DB.fornecedores);
  DB.fornecedores.push({ id, nome:String(nome||"").trim(), documento:String(documento||"").trim() });
  return id;
}
function renderFornecedores(){
  const tb = document.querySelector("#tblForns tbody");
  if(!tb) return;
  const rows = DB.fornecedores;
  tb.innerHTML = rows.length
    ? rows.map(f=>`<tr><td>${f.id}</td><td>${f.nome}</td><td>${f.documento||""}</td></tr>`).join("")
    : `<tr><td colspan="3" class="muted">(vazio)</td></tr>`;
}

/* ==========================================================
   TIPOS DE DESPESA
   ========================================================== */
function addTipoDespesa(nome){
  const id = nextId(DB.tipos);
  DB.tipos.push({ id, nome:String(nome||"").trim() });
  return id;
}
function renderTipos(){
  const tb = document.querySelector("#tblTipos tbody");
  if(!tb) return;
  const rows = DB.tipos;
  tb.innerHTML = rows.length
    ? rows.map(t=>`<tr><td>${t.id}</td><td>${t.nome}</td></tr>`).join("")
    : `<tr><td colspan="2" class="muted">(vazio)</td></tr>`;
}

/* ==========================================================
   CONTAS
   ========================================================== */
function addConta(nome, tipo){
  const id = nextId(DB.contas);
  DB.contas.push({ id, nome:String(nome||"").trim(), tipo:String(tipo||"caixa").trim() });
  return id;
}
function renderContas(){
  const tb = document.querySelector("#tblContas tbody");
  if(!tb) return;
  const rows = DB.contas;
  tb.innerHTML = rows.length
    ? rows.map(c=>`<tr><td>${c.id}</td><td>${c.nome}</td><td>${c.tipo}</td></tr>`).join("")
    : `<tr><td colspan="3" class="muted">(vazio)</td></tr>`;
}

/* ==========================================================
   SELECTS (Fornecedor/Tipo/Conta) — usados na tela Pagamentos
   ========================================================== */
function finPopulateSelectors(){
  const $f = document.getElementById("pForn");
  const $t = document.getElementById("pTipo");
  const $c = document.getElementById("pConta");
  if ($f){
    $f.innerHTML = `<option value="">Selecione…</option>` + DB.fornecedores.map(x=>`<option value="${x.id}">${x.id} - ${x.nome}</option>`).join("");
  }
  if ($t){
    $t.innerHTML = `<option value="">Selecione…</option>` + DB.tipos.map(x=>`<option value="${x.id}">${x.id} - ${x.nome}</option>`).join("");
  }
  if ($c){
    $c.innerHTML = `<option value="">Selecione…</option>` + DB.contas.map(x=>`<option value="${x.id}">${x.id} - ${x.nome} (${x.tipo})</option>`).join("");
  }
}

/* ==========================================================
   PAGAMENTOS
   ========================================================== */
function addPagamento({ fornecedor_id, tipo_id, conta_id, valor, dataBR, observacao }){
  const fid = +fornecedor_id, tid = +tipo_id, cid = +conta_id;
  if(!(fid>0) || !(tid>0) || !(cid>0)) throw new Error("Fornecedor/Tipo/Conta obrigatórios.");
  const v = +valor;
  if(!(v>0)) throw new Error("Valor deve ser > 0.");
  const iso = brToIso(String(dataBR||"").trim()) || (new Date().toISOString().slice(0,10));
  const id = nextId(DB.pagamentos);
  DB.pagamentos.push({
    id, dataISO: iso,
    fornecedor_id: fid, tipo_id: tid, conta_id: cid,
    valor: v,
    observacao: String(observacao||"").trim()
  });
  return id;
}
function renderPagamentos(){
  const tb = document.querySelector("#tblPgto tbody");
  if(!tb) return;
  if(!DB.pagamentos.length){
    tb.innerHTML = `<tr><td colspan="7" class="muted">(vazio)</td></tr>`;
    return;
  }
  const byId = (arr, id) => (arr||[]).find(x=>+x.id===+id) || null;
  tb.innerHTML = DB.pagamentos.map(p=>{
    const forn = byId(DB.fornecedores, p.fornecedor_id);
    const tip  = byId(DB.tipos, p.tipo_id);
    const cta  = byId(DB.contas, p.conta_id);
    return `
      <tr>
        <td>${p.id}</td>
        <td>${isoToBr(p.dataISO)}</td>
        <td>${forn?.nome||""}</td>
        <td>${tip?.nome||""}</td>
        <td>${cta?.nome||""}</td>
        <td>${brMoney.format(+p.valor||0)}</td>
        <td>${(p.observacao||"")}</td>
      </tr>
    `;
  }).join("");
}

/* ==========================================================
   CSV-BR de Pagamentos (1 arquivo, colunas separadas por ;)
   ========================================================== */
function exportPagamentosBR(){
  const header = ["id","data","fornecedor","tipo","conta","valor","observacao"];
  const lines = [header.join(";")];

  const byId = (arr, id) => (arr||[]).find(x=>+x.id===+id) || null;

  DB.pagamentos.forEach(p=>{
    const forn = byId(DB.fornecedores, p.fornecedor_id);
    const tip  = byId(DB.tipos, p.tipo_id);
    const cta  = byId(DB.contas, p.conta_id);
    const row = [
      p.id,
      `"${isoToBr(p.dataISO)}"`,
      `"${(forn?.nome||"").replace(/"/g,'""')}"`,
      `"${(tip?.nome||"").replace(/"/g,'""')}"`,
      `"${(cta?.nome||"").replace(/"/g,'""')}"`,
      String((+p.valor||0).toFixed(2)).replace(".",","),   // moeda BR com vírgula
      `"${(p.observacao||"").replace(/"/g,'""')}"`
    ].join(";");
    lines.push(row);
  });

  const csv = lines.join("\r\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "pagamentos.csv";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* ==========================================================
   BINDS — Botões da UI
   ========================================================== */
/* Fornecedores */
document.getElementById("btnAddForn")?.addEventListener("click", ()=>{
  const nome = document.getElementById("fForNome")?.value.trim();
  const doc  = document.getElementById("fForDoc")?.value.trim();
  const msg = document.getElementById("msgForn");
  if(!nome){ setMsg(msg,"Informe o nome.",false); return; }
  addFornecedor(nome, doc);
  setMsg(msg,"Fornecedor salvo!",true);
  document.getElementById("fForNome").value=""; document.getElementById("fForDoc").value="";
  renderFornecedores(); finPopulateSelectors();
});
document.getElementById("btnListForn")?.addEventListener("click", renderFornecedores);

/* Tipos de despesa */
document.getElementById("btnAddTipo")?.addEventListener("click", ()=>{
  const nome = document.getElementById("fTipoNome")?.value.trim();
  const msg = document.getElementById("msgTipo");
  if(!nome){ setMsg(msg,"Informe o nome.",false); return; }
  addTipoDespesa(nome);
  setMsg(msg,"Tipo salvo!",true);
  document.getElementById("fTipoNome").value="";
  renderTipos(); finPopulateSelectors();
});
document.getElementById("btnListTipo")?.addEventListener("click", renderTipos);

/* Contas */
document.getElementById("btnAddConta")?.addEventListener("click", ()=>{
  const nome = document.getElementById("fContaNome")?.value.trim();
  const tipo = document.getElementById("fContaTipo")?.value.trim() || "caixa";
  const msg = document.getElementById("msgConta");
  if(!nome){ setMsg(msg,"Informe o nome.",false); return; }
  addConta(nome, tipo);
  setMsg(msg,"Conta salva!",true);
  document.getElementById("fContaNome").value="";
  renderContas(); finPopulateSelectors();
});
document.getElementById("btnListConta")?.addEventListener("click", renderContas);

/* Pagamentos */
document.getElementById("btnAddPgto")?.addEventListener("click", ()=>{
  const fornecedor_id = parseInt(document.getElementById("pForn")?.value||"0",10);
  const tipo_id       = parseInt(document.getElementById("pTipo")?.value||"0",10);
  const conta_id      = parseInt(document.getElementById("pConta")?.value||"0",10);
  const valor         = parseFloat(document.getElementById("pValor")?.value||"0");
  const dataBR        = (document.getElementById("pData")?.value||"").trim();
  const observacao    = (document.getElementById("pObs")?.value||"").trim();
  const msg = document.getElementById("msgPgto");

  try{
    addPagamento({ fornecedor_id, tipo_id, conta_id, valor, dataBR, observacao });
    setMsg(msg,"Pagamento salvo!",true);
    // limpa
    document.getElementById("pValor").value="";
    document.getElementById("pData").value="";
    document.getElementById("pObs").value="";
    renderPagamentos();
  }catch(e){
    setMsg(msg, String(e?.message||e||"Erro ao salvar pagamento."), false);
  }
});
document.getElementById("btnListPgto")?.addEventListener("click", renderPagamentos);
document.getElementById("btnPagamentosCSV")?.addEventListener("click", exportPagamentosBR);

/* ==========================================================
   BOOT FINANCEIRO — seeds leves (opcionais)
   ========================================================== */
document.addEventListener("DOMContentLoaded", ()=>{
  // Renderizações iniciais
  renderFornecedores();
  renderTipos();
  renderContas();
  renderPagamentos();

  // Seeds só se estiver vazio (opcionais)
  if (!DB.fornecedores.length) addFornecedor("Supermercado Central","12.345.678/0001-90");
  if (!DB.tipos.length) addTipoDespesa("Energia elétrica");
  if (!DB.contas.length) addConta("Caixa Principal","caixa");
  finPopulateSelectors();
});




/* --------- RELATÓRIO: ESTOQUE --------- */
function relEstRows(){
  return (DB.insumos||[]).map(ins=>{
    const st = DB.estoque[ins.id] || { saldo:0, custoMedio:0 };
    return { insumo_nome:ins.nome, unidade:ins.unidade, saldo:+st.saldo, custo_medio:+st.custoMedio };
  });
}
function renderRelEstoque(){
  const tbody = document.querySelector('#tblRelEst tbody');
  if (!tbody) return;
  const data = relEstRows();
  tbody.innerHTML = data.length
    ? data.map(x=>`
      <tr>
        <td>${x.insumo_nome}</td>
        <td>${x.unidade}</td>
        <td>${brQty3.format(+x.saldo)}</td>
        <td>${brMoney.format(+x.custo_medio||0)}</td>
      </tr>
    `).join("")
    : `<tr><td colspan="4" class="muted">(vazio)</td></tr>`;
}


/* --------- RELATÓRIO: VENDAS --------- */
function relVendasRows({ iniISO, fimISO }){
  const ini = iniISO ? new Date(iniISO+"T00:00:00") : null;
  const fim = fimISO ? new Date(fimISO+"T23:59:59") : null;
  const out = [];
  for (const v of (DB.vendas||[])) {
    const d = new Date(v.data);
    if (ini && d < ini) continue;
    if (fim && d > fim) continue;

    if (!v.consumos || !v.consumos.length) {
      out.push({
        venda_id:v.venda_id, data:v.data, produto_nome:v.produto_nome,
        preco_venda:v.preco_venda, quantidade:v.quantidade, tipo:v.tipo,
        comentario:v.comentario, forma_pagamento:v.forma_pagamento, cancelada:v.cancelada,
        insumo_nome:"", consumo_base:"", unidade_base:""
      });
    } else {
      for (const c of v.consumos) {
        out.push({
          venda_id:v.venda_id, data:v.data, produto_nome:v.produto_nome,
          preco_venda:v.preco_venda, quantidade:v.quantidade, tipo:v.tipo,
          comentario:v.comentario, forma_pagamento:v.forma_pagamento, cancelada:v.cancelada,
          insumo_nome:c.insumo_nome, consumo_base:c.consumo_base, unidade_base:c.unidade_base
        });
      }
    }
  }
  return out;
}
function renderRelVendas(){
  const viBr = (document.getElementById('rvIni')?.value||"").trim();
  const vfBr = (document.getElementById('rvFim')?.value||"").trim();
  const rows = relVendasRows({ iniISO: brToIso(viBr) || undefined, fimISO: brToIso(vfBr) || undefined });
  const tb = document.querySelector('#tblVendas tbody');
  if (!tb) return;

  tb.innerHTML = rows.length
    ? rows.map(v=>`
      <tr>
        <td>${v.venda_id}</td>
        <td>${isoToBr((v.data||"").toString().slice(0,10))}</td>
        <td>${v.produto_nome||""}</td>
        <td>${brMoney.format(+v.preco_venda||0)}</td>
        <td>${v.quantidade ?? ""}</td>
        <td>${v.tipo||""}</td>
        <td>${v.comentario||""}</td>
        <td>${v.forma_pagamento||""}</td>
        <td>${v.cancelada ? "SIM":"NÃO"}</td>
        <td>${[v.insumo_nome, v.consumo_base, v.unidade_base].filter(Boolean).join(" ")}</td>
      </tr>
    `).join("")
    : `<tr><td colspan="10" class="muted">(vazio)</td></tr>`;
}
// Export de vendas já existe na Parte 4 como exportVendasBR(); reaproveitamos
// Se por algum motivo não existir, criamos um fallback:
if (typeof window.exportVendasBR !== "function") {
  window.exportVendasBR = function(){
    const data = relVendasRows({}); // tudo
    const header = ["venda_id","data","produto","preco_venda","quantidade","tipo","comentario","forma_pagamento","cancelada","insumo_nome","consumo_base","unidade_base"];
    const lines = [header.join(";")].concat(
      data.map(r=>[
        r.venda_id,
        `"${(r.data||"").toString().slice(0,10)}"`,
        `"${(r.produto_nome||"").replace(/"/g,'""')}"`,
        String((+r.preco_venda||0).toFixed(2)).replace(".",","),
        String(+r.quantidade||0).replace(".",","),
        `"${(r.tipo||"")}"`,
        `"${(r.comentario||"").replace(/"/g,'""')}"`,
        `"${(r.forma_pagamento||"")}"`,
        r.cancelada ? "SIM" : "NAO",
        `"${(r.insumo_nome||"").replace(/"/g,'""')}"`,
        (r.consumo_base==="" ? "" : String(+r.consumo_base).replace(".",",")),
        `"${(r.unidade_base||"")}"`,
      ].join(";"))
    );
    const csv = lines.join("\r\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "vendas.csv";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
}

/* --------- RELATÓRIO: MOVIMENTAÇÕES --------- */
function relMovLocal({ start, end } = {}){
  const ini = start ? new Date(start+"T00:00:00") : null;
  const fim = end   ? new Date(end+"T23:59:59")  : null;
  return (DB.movs||[]).filter(m=>{
    const d = new Date(m.dataISO);
    return (!ini || d>=ini) && (!fim || d<=fim);
  });
}
function renderRelMov(){
  const iBr = (document.getElementById('rmi')?.value||"").trim();
  const fBr = (document.getElementById('rmf')?.value||"").trim();
  const rows = relMovLocal({ start: brToIso(iBr) || undefined, end: brToIso(fBr) || undefined });
  const tb = document.querySelector('#tblRelMov tbody');
  if(!tb) return;

  tb.innerHTML = rows.length
    ? rows.map(m=>`
      <tr>
        <td>${m.id}</td>
        <td>${isoToBr((m.dataISO||"").toString().slice(0,10))}</td>
        <td>${m.insumo_nome||""}</td>
        <td>${m.quantidade ?? ""}</td>
        <td>${m.unidade||""}</td>
        <td>${brMoney.format(+m.custo_total||0)}</td>
        <td>${m.origem||""}</td>
        <td>${m.tipo||""}</td>
      </tr>
    `).join("")
    : `<tr><td colspan="8" class="muted">(vazio)</td></tr>`;
}

/* --------- BINDS --------- */
document.getElementById('btnRelEst')?.addEventListener('click', renderRelEstoque);
document.getElementById('btnRelV')?.addEventListener('click', renderRelVendas);
document.getElementById('btnRelMov')?.addEventListener('click', renderRelMov);

// Export Estoque (Relatórios)
document.getElementById('btnRelEstoqueCSV')?.addEventListener('click', exportEstoqueBR);


// Export Vendas (já existente no HTML)
document.getElementById('btnVendasCSVBR')?.addEventListener('click', window.exportVendasBR);

/* --------- BOOT INICIAL: gera tabelas vazias (ou com dados se já houver) --------- */
document.addEventListener("DOMContentLoaded", ()=>{
  // Render inicial dos 3 relatórios (útil se já houver seeds)
  renderRelEstoque();
  renderRelVendas();
  renderRelMov();
});


(function setupVendasUI(){
  const $vendas = document.getElementById("vendas");
  if(!$vendas) return;

  // Desenha a UI da aba (sem mexer no HTML original via edição manual)
  $vendas.innerHTML = `
    <h2>Vendas</h2>

    <div class="card">
      <h3>Registrar Venda</h3>

      <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end;">
        <div>
          <label>Modo:</label>
          <div style="display:flex; gap:10px; margin-top:4px;">
            <label style="font-weight:600;"><input type="radio" name="vModo" value="produto" checked /> Produto preparado</label>
            <label style="font-weight:600;"><input type="radio" name="vModo" value="insumo" /> Insumo direto</label>
          </div>
        </div>

        <div id="boxProduto">
          <label>Produto preparado:
            <select id="vProd"></select>
          </label>
        </div>

        <div id="boxInsumo" class="hide">
          <label>Insumo (vendível):
            <select id="vIns"></select>
          </label>
        </div>

        <div>
          <label>Quantidade:
            <input id="vQtd" type="number" step="0.01" value="1" />
          </label>
        </div>

        <div>
          <label>Preço de venda:
            <input id="vPreco" type="number" step="0.01" placeholder="Ex: 25.00" />
          </label>
        </div>

        <div>
          <label>Tipo:
            <select id="vTipo">
              <option value="normal">Normal</option>
              <option value="cortesia">Cortesia</option>
              <option value="consumo">Consumo</option>
            </select>
          </label>
        </div>

        <div>
          <label>Forma de pagamento:
            <input id="vPgto" placeholder="Ex: dinheiro, cartão" />
          </label>
        </div>

        <div style="min-width:100%;"></div>

        <div style="flex:1; min-width:320px;">
          <label>Comentário:
            <input id="vComent" placeholder="Obrigatório em cortesia/consumo" />
          </label>
        </div>

        <div>
          <button id="btnRegistrarVenda">Registrar</button>
          <button id="btnListarVendas" class="secondary">Listar</button>
        </div>
      </div>

      <div id="msgVenda" class="msg"></div>
    </div>

    <div class="card">
      <h3>Vendas (Sessão atual)</h3>
      <table id="tblVendasLive">
        <thead>
          <tr>
            <th>ID</th><th>Data</th><th>Item</th><th>Qtd</th>
            <th>Preço</th><th>Tipo</th><th>Pgto</th>
            <th>Cancelada</th><th>Avisos</th><th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="10" class="muted">(vazio)</td></tr>
        </tbody>
      </table>
    </div>
  `;

  /* ---------- helpers UI ---------- */
  function populateProdutoSelect(){
    const $p = document.getElementById("vProd");
    if(!$p) return;
    const list = (DB.produtos||[]).filter(x=>x.preparado);
    $p.innerHTML = `<option value="">Selecione…</option>` +
      list.map(p=>`<option value="${p.id}">${p.id} - ${p.nome}</option>`).join("");
  }
  function populateInsumoSelect(){
    const $i = document.getElementById("vIns");
    if(!$i) return;
    const list = (DB.insumos||[]).filter(x=>x.vendivel);
    $i.innerHTML = `<option value="">Selecione…</option>` +
      list.map(i=>`<option value="${i.id}">${i.id} - ${i.nome} (${i.unidade})</option>`).join("");
  }

  function renderVendasLive(){
    const tb = document.querySelector("#tblVendasLive tbody");
    if(!tb) return;
    const rows = DB.vendas||[];
    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="10" class="muted">(vazio)</td></tr>`;
      return;
    }
    tb.innerHTML = rows.map(v=>{
      const item = v.produto_nome || v.insumo_nome || "";
      const avisos = (v.avisos||[]).length ? v.avisos.join(" | ") : "";
      return `
        <tr>
          <td>${v.venda_id}</td>
          <td>${isoToBr((v.data||"").toString().slice(0,10))}</td>
          <td>${item}</td>
          <td>${v.quantidade ?? ""}</td>
          <td>${brMoney.format(+v.preco_venda||0)}</td>
          <td>${v.tipo||""}</td>
          <td>${v.forma_pagamento||""}</td>
          <td>${v.cancelada ? "SIM" : "NÃO"}</td>
          <td>${avisos}</td>
          <td>
            ${v.cancelada ? "" : `<button class="warning" data-cancel="${v.venda_id}">Cancelar</button>`}
          </td>
        </tr>
      `;
    }).join("");

    // Bind de cancelamento
    document.querySelectorAll('[data-cancel]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = +btn.getAttribute('data-cancel');
        const motivo = prompt("Motivo do cancelamento:", "cliente desistiu");
        try{
          const res = window.cancelarVenda ? cancelarVenda(id, motivo||"") : { ok:false };
          if(res && res.ok) {
            renderVendasLive();
            setMsg(document.getElementById("msgVenda"), `Venda ${id} cancelada.`, true);
          } else {
            setMsg(document.getElementById("msgVenda"), `Não foi possível cancelar a venda ${id}.`, false);
          }
        }catch(e){
          setMsg(document.getElementById("msgVenda"), String(e?.message||e), false);
        }
      });
    });
  }

  function toggleModoUI(){
    const modo = (document.querySelector('input[name="vModo"]:checked')?.value)||"produto";
    document.getElementById("boxProduto")?.classList.toggle("hide", modo!=="produto");
    document.getElementById("boxInsumo")?.classList.toggle("hide", modo!=="insumo");
  }

  /* ---------- binds ---------- */
  document.querySelectorAll('input[name="vModo"]').forEach(r=>{
    r.addEventListener('change', toggleModoUI);
  });

  document.getElementById("btnRegistrarVenda")?.addEventListener("click", ()=>{
    const modo   = (document.querySelector('input[name="vModo"]:checked')?.value)||"produto";
    const prodId = parseInt(document.getElementById("vProd")?.value||"0",10);
    const insId  = parseInt(document.getElementById("vIns")?.value||"0",10);
    const qtd    = parseFloat(document.getElementById("vQtd")?.value||"0");
    const preco  = parseFloat(document.getElementById("vPreco")?.value||"0");
    const tipo   = (document.getElementById("vTipo")?.value||"normal").trim();
    const pgto   = (document.getElementById("vPgto")?.value||"").trim();
    const coment = (document.getElementById("vComent")?.value||"").trim();
    const msg    = document.getElementById("msgVenda");

    try{
      if(modo==="produto"){
        if(!prodId){ setMsg(msg,"Selecione um produto preparado.",false); return; }
        window.registraVenda({
          produto_id: prodId, quantidade: qtd, preco_venda: preco,
          tipo, comentario: coment, forma_pagamento: pgto
        });
      } else {
        if(!insId){ setMsg(msg,"Selecione um insumo vendível.",false); return; }
        window.registraVenda({
          insumo_id: insId, quantidade: qtd, preco_venda: preco,
          tipo, comentario: coment, forma_pagamento: pgto
        });
      }
      setMsg(msg,"Venda registrada!", true);
      // limpa mínimos
      document.getElementById("vQtd").value = "1";
      document.getElementById("vPreco").value = "";
      document.getElementById("vComent").value = "";
      renderVendasLive();
    }catch(e){
      setMsg(msg, String(e?.message||e||"Erro ao registrar venda."), false);
    }
  });

  document.getElementById("btnListarVendas")?.addEventListener("click", renderVendasLive);

  /* ---------- boot ---------- */
  document.addEventListener("DOMContentLoaded", ()=>{
    populateProdutoSelect();
    populateInsumoSelect();
    toggleModoUI();
    renderVendasLive();

    // Atualiza selects sempre que o usuário navegar para a aba Vendas
    const navBtns = document.querySelectorAll('nav button[data-tab]');
    navBtns.forEach(b=>{
      b.addEventListener('click', ()=>{
        if (b.getAttribute('data-tab') === 'vendas'){
          populateProdutoSelect();
          populateInsumoSelect();
          renderVendasLive();
        }
      });
    });
  });

})();



</script>
</body>
</html>
