<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><meta name="viewport" content="width=980"><title>Funferp ERP - Demo</title><style>*{box-sizing:border-box;margin:0;padding:0}body,html{height:100%}body{font-family:"Segoe UI",Roboto,Arial,sans-serif;background:#f9fafb;color:#1f2937;line-height:1.55;padding:24px}main{max-width:1100px;margin:0 auto}header{max-width:1100px;margin:0 auto 18px}header h1{font-size:28px;font-weight:700;margin-bottom:6px}header .muted{color:#6b7280;font-size:14px}nav{display:flex;flex-wrap:wrap;gap:10px;max-width:1100px;margin:14px auto 22px}nav button{border:0;border-radius:10px;padding:10px 14px;background:#e5e7eb;color:#111827;font-weight:600;box-shadow:0 1px 0 rgba(0,0,0,.04);cursor:pointer;transition:transform .04s ease,background .15s ease}nav button:hover{transform:translateY(-1px)}nav button.active{background:#2563eb;color:#fff}.subnav{display:flex;gap:8px;margin:10px 0 14px}.subnav button{background:#eef2f7;border-radius:8px;padding:6px 10px;border:0;font-weight:600;cursor:pointer}.subnav button.active{background:#2563eb;color:#fff}.card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:18px}.card h3{margin-bottom:10px;color:#111827}section.tab h2{margin:6px 0 12px;font-size:22px}.muted{color:#9ca3af}.hide{display:none}label{display:block;margin:8px 0 4px;font-weight:600;color:#374151}input[placeholder],input[type=date],input[type=number],input[type=text],select{width:100%;max-width:360px;border:1px solid #d1d5db;border-radius:8px;padding:8px 10px;background:#fff;color:#111827}input::placeholder{color:#9ca3af}input[type=checkbox]{transform:scale(1.1);margin-right:6px}button{border:0;border-radius:8px;padding:8px 12px;font-weight:600;background:#2563eb;color:#fff;cursor:pointer;margin-right:6px;margin-top:8px}button.secondary{background:#6b7280}button.warning{background:#f59e0b}button:disabled{opacity:.6;cursor:not-allowed}table{width:100%;border-collapse:collapse;margin-top:10px}thead{background:#f3f4f6}td,th{padding:8px 10px;border:1px solid #e5e7eb;text-align:left;font-size:14px}tbody tr:hover{background:#fafafa}.msg{margin-top:8px;font-size:14px}.msg.ok{color:#059669}.msg.err{color:#dc2626}footer{max-width:1100px;margin:26px auto 0;text-align:center;color:#6b7280;font-size:13px}</style></head><body><header><h1>Funferp ERP - Modo Demo</h1><p class="muted">Este é um ambiente de demonstração. Os dados são temporários e serão apagados ao atualizar a página (F5).</p></header><nav><button data-tab="home" class="active">Início</button> <button data-tab="cadastros">Cadastros</button> <button data-tab="estoque">Estoque</button> <button data-tab="financeiro">Financeiro</button> <button data-tab="relatorios">Relatórios</button> <button data-tab="vendas">Vendas</button></nav><main id="appArea"><section id="home" class="tab"><h2>Bem-vindo(a)</h2><p>Neste modo, você pode testar cadastros, estoque, financeiro, vendas e relatórios.</p><ul style="margin-top:10px;padding-left:18px"><li>Cadastre insumos, produtos, fornecedores, tipos e contas</li><li>Faça entradas/ajustes de estoque e conversões</li><li>Registre pagamentos e vendas (com consumo por ficha técnica)</li><li>Gere e exporte relatórios (CSV em padrão BR)</li></ul></section><section id="cadastros" class="tab hide"><h2>Cadastros</h2><div class="subnav" data-subnav="cad"><button data-subtab="cad-insumos" class="active">Insumos</button> <button data-subtab="cad-produtos">Produtos</button> <button data-subtab="cad-ficha">Ficha Técnica</button></div><div id="cad-insumos" class="subtab"><div class="card"><h3>Insumos</h3><label>Nome: <input id="iNome" placeholder="Ex: Queijo Mussarela"></label> <label>Unidade: <select id="iUni"><option value="">Selecione...</option><option value="kg">kg</option><option value="g">g</option><option value="un">un</option><option value="ml">ml</option><option value="l">l</option></select></label> <label><input type="checkbox" id="iVend"> Vendível</label> <button id="btnAddInsumo">Salvar</button> <button id="btnListInsumo" class="secondary">Listar</button><div id="msgInsumo" class="msg"></div><table id="tblInsumos"><thead><tr><th>ID</th><th>Nome</th><th>Unidade</th><th>Vendível</th></tr></thead><tbody><tr><td colspan="4" class="muted">(vazio)</td></tr></tbody></table></div></div><div id="cad-produtos" class="subtab hide"><div class="card"><h3>Produtos</h3><label>Nome: <input id="pNome" placeholder="Ex: X-Burger"></label> <label>É preparado? <select id="pPrep"><option value="">Selecione...</option><option value="true">Sim</option><option value="false">Não</option></select></label><div id="inline-ficha" class="hide"><p class="muted">Após salvar, defina a ficha técnica na aba ao lado.</p></div><button id="btnAddProd">Salvar</button> <button id="btnListProd" class="secondary">Listar</button><div id="msgProd" class="msg"></div><table id="tblProdutos"><thead><tr><th>ID</th><th>Nome</th><th>Preparado</th></tr></thead><tbody><tr><td colspan="3" class="muted">(vazio)</td></tr></tbody></table></div></div><div id="cad-ficha" class="subtab hide"><div class="card"><h3>Ficha Técnica</h3><label>Produto: <select id="fpProd"></select></label> <button id="fpBtnVer">Ver Ficha</button><table id="fpTbl" style="margin-top:10px"><thead><tr><th>#</th><th>Insumo</th><th>Qtd</th><th>Unidade</th></tr></thead><tbody><tr><td colspan="4" class="muted">(vazio)</td></tr></tbody></table><h4 style="margin-top:14px">Adicionar Linha</h4><label>Insumo: <select class="fpLinhaIns"></select></label> <label>Qtd: <input class="fpLinhaQtd" type="number" step="0.01"></label> <label>Unidade: <select class="fpLinhaUn"><option value="">Selecione...</option><option value="kg">kg</option><option value="g">g</option><option value="un">un</option><option value="ml">ml</option><option value="l">l</option></select></label> <button id="fpBtnAddLinha" class="secondary">+ Adicionar linha</button><table id="fpTblLinhas" style="margin-top:10px"><thead><tr><th>#</th><th>Insumo</th><th>Qtd</th><th>Un</th><th></th></tr></thead><tbody><tr><td colspan="5" class="muted">(vazio)</td></tr></tbody></table><button id="fpBtnSalvar">Salvar Ficha</button><div id="fpMsg" class="msg"></div></div></div></section><section id="estoque" class="tab hide"><h2>Estoque</h2><div class="subnav" data-subnav="est"><button data-subtab="est-entrada" class="active">Entrada</button> <button data-subtab="est-ajuste">Ajuste</button> <button data-subtab="est-conversoes">Conversões</button> <button data-subtab="est-saldos">Saldos</button></div><div id="est-entrada" class="subtab"><div class="card"><h3>Registrar Entrada</h3><label>Insumo: <select id="eIns"></select></label> <label>Qtd: <input id="eQtd" type="number" step="0.01"></label> <label>Custo Total: <input id="eCusto" type="number" step="0.01"></label> <button id="btnEntrada">Registrar Entrada</button><div id="msgEnt" class="msg"></div></div></div><div id="est-ajuste" class="subtab hide"><div class="card"><h3>Ajuste de Estoque</h3><label>Insumo: <select id="aIns"></select></label> <label>Qtd (ex: -1): <input id="aQtd" type="number" step="0.01"></label> <label>Motivo: <input id="aMot" placeholder="Ex: quebra"></label> <label>Custo Unitário (opcional): <input id="aCusto" type="number" step="0.01"></label> <button id="btnAjuste" class="warning">Aplicar Ajuste</button><div id="msgAj" class="msg"></div></div></div><div id="est-conversoes" class="subtab hide"><div class="card"><h3>Conversões</h3><label>Insumo: <select id="convIns"></select></label> <label>De: <input id="convFrom" placeholder="Ex: kg"></label> <label>Para: <input id="convTo" placeholder="Ex: g"></label> <label>Fator: <input id="convFactor" type="number" step="0.0001" placeholder="Ex: 1000"></label> <button id="btnConvAdd">Adicionar Conversão</button> <button id="btnConvList" class="secondary">Listar</button><div id="msgConv" class="msg"></div><table id="tblConv"><thead><tr><th>De</th><th>Para</th><th>Fator</th></tr></thead><tbody><tr><td colspan="3" class="muted">(vazio)</td></tr></tbody></table></div></div><div id="est-saldos" class="subtab hide"><div class="card"><h3>Saldos</h3><button id="btnSaldos">Atualizar Saldos</button><table id="tblSaldos"><thead><tr><th>Insumo</th><th>Unidade</th><th>Saldo</th><th>Custo Médio</th></tr></thead><tbody><tr><td colspan="4" class="muted">(vazio)</td></tr></tbody></table></div><div class="card"><h3>Exportar Estoque CSV (BR)</h3><button id="btnEstoqueMediaCSV">Exportar</button></div></div></section><section id="financeiro" class="tab hide"><h2>Financeiro</h2><div class="subnav" data-subnav="fin"><button data-subtab="fin-fornecedores" class="active">Fornecedores</button> <button data-subtab="fin-tipos">Tipos de Despesa</button> <button data-subtab="fin-contas">Contas</button> <button data-subtab="fin-pagamentos">Pagamentos</button></div><div id="fin-fornecedores" class="subtab"><div class="card"><h3>Fornecedores</h3><label>Nome: <input id="fForNome" placeholder="Ex: Supermercado Central"></label> <label>Documento: <input id="fForDoc" placeholder="CNPJ/CPF"></label> <button id="btnAddForn">Salvar</button> <button id="btnListForn" class="secondary">Listar</button><div id="msgForn" class="msg"></div><table id="tblForns"><thead><tr><th>ID</th><th>Nome</th><th>Documento</th></tr></thead><tbody><tr><td colspan="3" class="muted">(vazio)</td></tr></tbody></table></div></div><div id="fin-tipos" class="subtab hide"><div class="card"><h3>Tipos de Despesa</h3><label>Nome: <input id="fTipoNome" placeholder="Ex: Energia elétrica"></label> <button id="btnAddTipo">Salvar</button> <button id="btnListTipo" class="secondary">Listar</button><div id="msgTipo" class="msg"></div><table id="tblTipos"><thead><tr><th>ID</th><th>Nome</th></tr></thead><tbody><tr><td colspan="2" class="muted">(vazio)</td></tr></tbody></table></div></div><div id="fin-contas" class="subtab hide"><div class="card"><h3>Contas</h3><label>Nome: <input id="fContaNome" placeholder="Ex: Caixa Principal"></label> <label>Tipo: <select id="fContaTipo"><option value="caixa">Caixa</option><option value="banco">Banco</option><option value="cartão">Cartão</option></select></label> <button id="btnAddConta">Salvar</button> <button id="btnListConta" class="secondary">Listar</button><div id="msgConta" class="msg"></div><table id="tblContas"><thead><tr><th>ID</th><th>Nome</th><th>Tipo</th></tr></thead><tbody><tr><td colspan="3" class="muted">(vazio)</td></tr></tbody></table></div></div><div id="fin-pagamentos" class="subtab hide"><div class="card"><h3>Pagamentos</h3><label>Fornecedor: <select id="pForn"></select></label> <label>Tipo: <select id="pTipo"></select></label> <label>Conta: <select id="pConta"></select></label> <label>Valor: <input id="pValor" type="number" step="0.01"></label> <label>Data: <input id="pData" placeholder="DD/MM/AAAA"></label> <label>Observação: <input id="pObs"></label> <button id="btnAddPgto">Salvar</button> <button id="btnListPgto" class="secondary">Listar</button><div id="msgPgto" class="msg"></div><table id="tblPgto"><thead><tr><th>ID</th><th>Data</th><th>Fornecedor</th><th>Tipo</th><th>Conta</th><th>Valor</th><th>Obs</th></tr></thead><tbody><tr><td colspan="7" class="muted">(vazio)</td></tr></tbody></table><button id="btnPagamentosCSV">Exportar CSV-BR</button></div></div></section><section id="relatorios" class="tab hide"><h2>Relatórios</h2><div class="subnav" data-subnav="rel"><button data-subtab="rel-estoque" class="active">Estoque</button> <button data-subtab="rel-vendas">Vendas</button> <button data-subtab="rel-mov">Movimentações</button></div><div id="rel-estoque" class="subtab"><div class="card"><h3>Relatório de Estoque</h3><p class="muted">Mostra saldo e custo médio por insumo.</p><button id="btnRelEst">Gerar</button> <button id="btnRelEstoqueCSV" class="secondary">Exportar CSV-BR</button><table id="tblRelEst" style="margin-top:10px"><thead><tr><th>Insumo</th><th>Unidade</th><th>Saldo</th><th>Custo Médio</th></tr></thead><tbody><tr><td colspan="4" class="muted">(vazio)</td></tr></tbody></table></div></div><div id="rel-vendas" class="subtab hide"><div class="card"><h3>Relatório de Vendas</h3><div style="display:flex;flex-wrap:wrap;gap:16px"><label style="min-width:220px">Data inicial: <input id="rvIni" placeholder="DD/MM/AAAA"></label> <label style="min-width:220px">Data final: <input id="rvFim" placeholder="DD/MM/AAAA"></label></div><button id="btnRelV">Gerar</button> <button id="btnVendasCSVBR" class="secondary">Exportar CSV-BR</button><table id="tblVendas" style="margin-top:10px"><thead><tr><th>ID</th><th>Data</th><th>Produto</th><th>Preço</th><th>Qtd</th><th>Tipo</th><th>Comentário</th><th>Pgto</th><th>Cancelada</th><th>Consumo</th></tr></thead><tbody><tr><td colspan="10" class="muted">(vazio)</td></tr></tbody></table></div></div><div id="rel-mov" class="subtab hide"><div class="card"><h3>Relatório de Movimentações</h3><div style="display:flex;flex-wrap:wrap;gap:16px"><label style="min-width:220px">Data inicial: <input id="rmi" placeholder="DD/MM/AAAA"></label> <label style="min-width:220px">Data final: <input id="rmf" placeholder="DD/MM/AAAA"></label></div><button id="btnRelMov">Gerar</button><table id="tblRelMov" style="margin-top:10px"><thead><tr><th>ID</th><th>Data</th><th>Insumo</th><th>Qtd</th><th>Un</th><th>Custo</th><th>Origem</th><th>Tipo</th></tr></thead><tbody><tr><td colspan="8" class="muted">(vazio)</td></tr></tbody></table></div></div></section><section id="vendas" class="tab hide"><h2>Vendas</h2><div class="card"><p class="muted">A lógica de vendas será adicionada nas próximas partes.</p></div></section></main><footer><p class="muted">Ao atualizar a página os dados serão apagados</p></footer><script>function nextId(e){return e&&e.length?Math.max(...e.map(e=>+e.id||0))+1:1}function findInsumo(e){return(DB.insumos||[]).find(t=>+t.id===+e)||null}function findProduto(e){return(DB.produtos||[]).find(t=>+t.id===+e)||null}function renderInsumos(){const e=document.querySelector("#tblInsumos tbody");if(!e)return;const t=DB.insumos||[];e.innerHTML=t.length?t.map(e=>`<tr>\n        <td>${e.id}</td>\n        <td>${e.nome}</td>\n        <td>${e.unidade}</td>\n        <td>${e.vendivel?"Sim":"Não"}</td>\n      </tr>`).join(""):'<tr><td colspan="4" class="muted">(vazio)</td></tr>'}function renderProdutos(){const e=document.querySelector("#tblProdutos tbody");if(!e)return;const t=DB.produtos||[];e.innerHTML=t.length?t.map(e=>`<tr>\n        <td>${e.id}</td>\n        <td>${e.nome}</td>\n        <td>${e.preparado?"Sim":"Não"}</td>\n      </tr>`).join(""):'<tr><td colspan="3" class="muted">(vazio)</td></tr>';const n=document.getElementById("fpProd");n&&(n.innerHTML='<option value="">Selecione…</option>'+t.map(e=>`<option value="${e.id}">${e.id} - ${e.nome}</option>`).join(""))}function refreshInsumoSelects(){const e=DB.insumos||[],t=['<option value="">Selecione…</option>'].concat(e.map(e=>`<option value="${e.id}">${e.id} - ${e.nome} (${e.unidade})</option>`)).join("");["convIns","eIns","aIns"].forEach(e=>{const n=document.getElementById(e);n&&(n.innerHTML=t)}),document.querySelectorAll(".fpLinhaIns").forEach(e=>e.innerHTML=t)}function addInsumo(e,t,n){DB.insumos||=[];const o={id:nextId(DB.insumos),nome:String(e).trim(),unidade:String(t).trim(),vendivel:!!n};return DB.insumos.push(o),DB.estoque[o.id]={saldo:0,custoMedio:0},o}function addProduto(e,t){DB.produtos||=[];const n={id:nextId(DB.produtos),nome:String(e).trim(),preparado:!("true"!==String(t)&&!0!==t)};return DB.produtos.push(n),DB.ficha[n.id]||=[],n}window.DB={insumos:[],produtos:[],ficha:{},_convs:{},estoque:{},movs:[],fornecedores:[],tipos:[],contas:[],pagamentos:[],vendas:[]},window.setMsg=function(e,t,n){e&&(e.className="msg "+(n?"ok":"err"),e.textContent=t||"")},window.isoToBr=function(e){if(!e)return"";const t=new Date(e);if(isNaN(t))return"";return`${String(t.getDate()).padStart(2,"0")}/${String(t.getMonth()+1).padStart(2,"0")}/${t.getFullYear()}`},window.brToIso=function(e){if(!e)return"";const t=e.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);if(!t)return"";const[n,o,d,a]=t;return`${a}-${d}-${o}`},window.brMoney=new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}),window.brQty3=new Intl.NumberFormat("pt-BR",{minimumFractionDigits:3,maximumFractionDigits:3}),function(){const e=document.querySelectorAll("nav button[data-tab]"),t=document.querySelectorAll("main .tab");function n(n){t.forEach(e=>e.classList.add("hide")),document.getElementById(n)?.classList.remove("hide"),e.forEach(e=>e.classList.remove("active"));const o=document.querySelector(`nav button[data-tab="${n}"]`);o?.classList.add("active");const d=document.getElementById(n),a=d?.querySelector(".subnav[data-subnav]");if(a){const e=a.querySelector("button[data-subtab].active")||a.querySelector("button[data-subtab]");e&&e.click()}}e.forEach(e=>{e.addEventListener("click",()=>{n(e.getAttribute("data-tab"))})}),document.querySelectorAll(".subnav[data-subnav]").forEach(e=>{const t=e.closest("section.tab"),n=e.querySelectorAll("button[data-subtab]");n.forEach(e=>{e.addEventListener("click",()=>{const o=e.getAttribute("data-subtab");n.forEach(e=>e.classList.remove("active")),e.classList.add("active"),t.querySelectorAll(".subtab").forEach(e=>e.classList.add("hide")),t.querySelector("#"+o)?.classList.remove("hide")})})}),n("home")}();let _fichaTemp=[];function renderFichaTabela(e){const t=document.querySelector("#fpTbl tbody");if(!t)return;const n=DB.ficha[e]||[];t.innerHTML=n.length?n.map((e,t)=>`<tr>\n        <td>${t+1}</td>\n        <td>${findInsumo(e.insumo_id)?.nome||""}</td>\n        <td>${e.quantidade}</td>\n        <td>${e.unidade}</td>\n      </tr>`).join(""):'<tr><td colspan="4" class="muted">(vazio)</td></tr>'}function renderFichaLinhasTemp(){const e=document.querySelector("#fpTblLinhas tbody");e&&(e.innerHTML=_fichaTemp.length?_fichaTemp.map((e,t)=>`\n      <tr>\n        <td>${t+1}</td>\n        <td>${findInsumo(+e.insumo_id)?.nome||""}</td>\n        <td>${e.quantidade}</td>\n        <td>${e.unidade}</td>\n        <td><button class="secondary" data-remove-line="${t}">Remover</button></td>\n      </tr>`).join(""):'<tr><td colspan="5" class="muted">(vazio)</td></tr>',document.querySelectorAll("[data-remove-line]").forEach(e=>{e.addEventListener("click",()=>{const t=+e.getAttribute("data-remove-line");_fichaTemp.splice(t,1),renderFichaLinhasTemp()})}))}function ensureEstoque(e){return DB.estoque||={},DB.estoque[e]||={saldo:0,custoMedio:0}}function nextMovId(){return DB.movs&&DB.movs.length?Math.max(...DB.movs.map(e=>+e.id||0))+1:1}function addMov(e){const t={id:nextMovId(),dataISO:e.dataISO||(new Date).toISOString(),insumo_id:+e.insumo_id,insumo_nome:String(e.insumo_nome||""),quantidade:+e.quantidade,unidade:String(e.unidade||""),custo_total:+e.custo_total||0,origem:String(e.origem||""),tipo:String(e.tipo||"")};return DB.movs.push(t),t}document.getElementById("btnAddInsumo")?.addEventListener("click",()=>{const e=document.getElementById("iNome")?.value.trim(),t=document.getElementById("iUni")?.value.trim(),n=document.getElementById("iVend")?.checked||!1,o=document.getElementById("msgInsumo");e&&t?(addInsumo(e,t,n),setMsg(o,"Insumo salvo!",!0),document.getElementById("iNome").value="",document.getElementById("iUni").value="",document.getElementById("iVend").checked=!1,renderInsumos(),refreshInsumoSelects()):setMsg(o,"Preencha nome e unidade.",!1)}),document.getElementById("btnListInsumo")?.addEventListener("click",renderInsumos),document.getElementById("btnAddProd")?.addEventListener("click",()=>{const e=document.getElementById("pNome")?.value.trim(),t=document.getElementById("pPrep")?.value,n=document.getElementById("msgProd");if(!e||"true"!==t&&"false"!==t)return void setMsg(n,"Preencha nome e se é preparado.",!1);const o=addProduto(e,"true"===t);setMsg(n,o.preparado?"Produto salvo! Defina a ficha técnica na aba ao lado.":"Produto salvo!",!0);const d=document.getElementById("inline-ficha");d&&d.classList.toggle("hide","true"!==t),document.getElementById("pNome").value="",document.getElementById("pPrep").value="",renderProdutos()}),document.getElementById("btnListProd")?.addEventListener("click",renderProdutos),document.getElementById("fpBtnVer")?.addEventListener("click",()=>{const e=parseInt(document.getElementById("fpProd")?.value||"0",10);e?(renderFichaTabela(e),setMsg(document.getElementById("fpMsg"),"",!0)):setMsg(document.getElementById("fpMsg"),"Selecione um produto.",!1)}),document.getElementById("fpBtnAddLinha")?.addEventListener("click",()=>{const e=document.querySelector(".fpLinhaIns"),t=document.querySelector(".fpLinhaQtd"),n=document.querySelector(".fpLinhaUn"),o=parseInt(e?.value||"0",10),d=parseFloat(t?.value||"0"),a=(n?.value||"").trim();o&&d>0&&a?(_fichaTemp.push({insumo_id:o,quantidade:+d,unidade:a}),renderFichaLinhasTemp(),t&&(t.value=""),n&&(n.value=""),setMsg(document.getElementById("fpMsg"),"Linha adicionada (temporária).",!0)):setMsg(document.getElementById("fpMsg"),"Preencha insumo, quantidade > 0 e unidade.",!1)}),document.getElementById("fpBtnSalvar")?.addEventListener("click",()=>{const e=parseInt(document.getElementById("fpProd")?.value||"0",10);e?(DB.ficha[e]=(_fichaTemp||[]).map(e=>({...e,insumo_id:+e.insumo_id,quantidade:+e.quantidade})),_fichaTemp=[],renderFichaLinhasTemp(),renderFichaTabela(e),setMsg(document.getElementById("fpMsg"),"Ficha técnica salva!",!0)):setMsg(document.getElementById("fpMsg"),"Selecione um produto.",!1)}),document.addEventListener("DOMContentLoaded",()=>{0===(DB.insumos||[]).length&&0===(DB.produtos||[]).length&&(addInsumo("Queijo Mussarela","kg",!1),addInsumo("Refrigerante Lata","un",!0),addProduto("X-Burger",!0)),renderInsumos(),renderProdutos(),refreshInsumoSelects()});const BUILTIN_FACTORS={"kg|g":1e3,"g|kg":.001,"l|ml":1e3,"ml|l":.001};function normUnit(e){return String(e||"").trim().toLowerCase()}function getConvFactor(e,t,n){const o=normUnit(t),d=normUnit(n);if(!o||!d)return null;if(o===d)return 1;const a=(DB._convs?.[e]||[]).find(e=>normUnit(e.de_unidade)===o&&normUnit(e.para_unidade)===d);return a&&+a.fator>0?+a.fator:BUILTIN_FACTORS[`${o}|${d}`]??null}function toBaseQty(e,t,n){const o=normUnit(e?.unidade),d=normUnit(n);if(!o)return null;if(o===d)return+t;const a=getConvFactor(e.id,d,o);return null==a?null:+t*+a}function listConversoes(){const e=parseInt(document.getElementById("convIns")?.value||"0",10),t=document.querySelector("#tblConv tbody");if(!t)return;if(!e)return void(t.innerHTML='<tr><td colspan="3" class="muted">Selecione um insumo.</td></tr>');const n=DB._convs[e]||[];t.innerHTML=n.length?n.map(e=>`<tr><td>${e.de_unidade}</td><td>${e.para_unidade}</td><td>${brQty3.format(+e.fator)}</td></tr>`).join(""):'<tr><td colspan="3" class="muted">(vazio)</td></tr>'}function saveConversao(){const e=parseInt(document.getElementById("convIns")?.value||"0",10),t=(document.getElementById("convFrom")?.value||"").trim(),n=(document.getElementById("convTo")?.value||"").trim(),o=parseFloat(document.getElementById("convFactor")?.value||"0"),d=document.getElementById("msgConv");if(!(e&&t&&n&&o>0))return void setMsg(d,"Preencha insumo, de, para e fator > 0.",!1);const a=DB._convs[e]||=[],i=a.findIndex(e=>normUnit(e.de_unidade)===normUnit(t)&&normUnit(e.para_unidade)===normUnit(n));i>=0?a[i].fator=+o:a.push({de_unidade:t,para_unidade:n,fator:+o}),setMsg(d,"Conversão salva!",!0);const r=document.getElementById("convFactor");r&&(r.value=""),listConversoes()}function entradaMedia({insumo_id:e,quantidade:t,custo_total:n}){const o=ensureEstoque(e),d=+t,a=+n,i=o.saldo*o.custoMedio;o.saldo+=d,o.custoMedio=o.saldo>0?(i+a)/o.saldo:0;const r=findInsumo(e);addMov({dataISO:(new Date).toISOString(),insumo_id:e,insumo_nome:r?.nome||"",quantidade:+d,unidade:r?.unidade||"",custo_total:+a,origem:"entrada",tipo:"entrada-media"})}function ajusteMedia({insumo_id:e,quantidade:t,motivo:n,custo_unitario:o}){const d=ensureEstoque(e),a=+t,i=findInsumo(e),r=i?.unidade||"",s=String(n||"").toLowerCase(),c=a<0&&(s.includes("perd")||s.includes("quebr")||s.includes("venci"));let u="ajuste",m=0;if(Number.isNaN(+o)||null==o||""===String(o))c?(u="perda",d.saldo=Math.max(d.saldo+a,0),d.saldo<=0&&(d.custoMedio=0)):(u="ajuste",d.saldo=Math.max(d.saldo+a,0),d.saldo<=0&&(d.custoMedio=0));else{const e=+o;if(Math.abs(a)<1e-12)u="reprecificacao",d.saldo>0?d.custoMedio=e:d.custoMedio=0;else if(a>0){u="ajuste";const t=d.saldo*d.custoMedio,n=e*a,o=d.saldo+a;d.custoMedio=o>0?(t+n)/o:0,d.saldo=o,m=n}else d.saldo=Math.max(d.saldo+a,0),d.saldo<=0&&(d.custoMedio=0)}addMov({dataISO:(new Date).toISOString(),insumo_id:e,insumo_nome:i?.nome||"",quantidade:+a,unidade:r,custo_total:+m,origem:u,tipo:"reprecificacao"===u?"reprecificacao":"ajuste-media"})}function saldosMedia(){return(DB.insumos||[]).map(e=>{const t=DB.estoque[e.id]||{saldo:0,custoMedio:0};return{insumo_id:e.id,insumo_nome:e.nome,unidade:e.unidade,saldo:+t.saldo,custo_medio:+t.custoMedio}})}function loadSaldos(){const e=saldosMedia(),t=document.querySelector("#tblSaldos tbody")||document.querySelector("#tblRelEst tbody");t&&(t.innerHTML=e.length?e.map(e=>`\n      <tr>\n        <td>${e.insumo_nome}</td>\n        <td>${e.unidade}</td>\n        <td>${brQty3.format(+e.saldo)}</td>\n        <td>${brMoney.format(+(e.custo_medio||0))}</td>\n      </tr>\n    `).join(""):'<tr><td colspan="4" class="muted">(vazio)</td></tr>')}function exportEstoqueBR(){const e=saldosMedia(),t=[["insumo","unidade","saldo","custo_medio"].join(";")].concat(e.map(e=>[`"${(e.insumo_nome||"").replace(/"/g,'""')}"`,`"${e.unidade||""}"`,String(e.saldo).replace(".",","),brMoney.format(+e.custo_medio||0).replace(/\s/g,"")].join(";"))).join("\r\n"),n=new Blob([t],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(n),d=document.createElement("a");d.href=o,d.download="estoque.csv",document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(o)}function nextVendaId(){return DB.vendas&&DB.vendas.length?Math.max(...DB.vendas.map(e=>+e.venda_id||0))+1:1}function _pushVenda(e){DB.vendas||=[];const t={venda_id:e.venda_id??nextVendaId(),data:e.data||(new Date).toISOString(),produto_id:e.produto_id??null,produto_nome:e.produto_nome??null,insumo_id:e.insumo_id??null,insumo_nome:e.insumo_nome??null,preco_venda:+e.preco_venda||0,quantidade:+e.quantidade||1,tipo:e.tipo||"normal",comentario:e.comentario||"",forma_pagamento:e.forma_pagamento||"",cancelada:!!e.cancelada,consumos:Array.isArray(e.consumos)?e.consumos.slice():[],avisos:Array.isArray(e.avisos)?e.avisos.slice():[]};return DB.vendas.push(t),t}function registraVenda(e){const t=+(e.produto_id||0),n=+(e.insumo_id||0),o=+(e.quantidade||0),d=+(e.preco_venda||0),a=(e.tipo||"normal").trim(),i=(e.comentario||"").trim(),r=(e.forma_pagamento||"").trim()||"";if(t<=0==n<=0)throw new Error("Informe exatamente UM: produto_id OU insumo_id.");if(!(o>0))throw new Error("Campo 'quantidade' deve ser > 0.");if(d<0)throw new Error("Preço inválido.");if(!["normal","cortesia","consumo"].includes(a))throw new Error("Tipo inválido.");if(["cortesia","consumo"].includes(a)&&!i)throw new Error("Comentário obrigatório em cortesia/consumo.");const s=[],c=[];if(n>0){const e=findInsumo(n);if(!e)throw new Error("Insumo não encontrado.");if(!e.vendivel)throw new Error("Este insumo não está marcado como vendível direto.");const t=ensureEstoque(n);let u=o;return t.saldo<u-1e-9&&(s.push(`Estoque insuficiente de ${e.nome}: faltaram ${brQty3.format(u-t.saldo)} ${e.unidade}`),u=Math.max(Math.min(t.saldo,u),0)),t.saldo=Math.max(t.saldo-u,0),t.saldo<=1e-12&&(t.custoMedio=0),addMov({insumo_id:e.id,insumo_nome:e.nome,quantidade:-u,unidade:e.unidade,origem:"venda",tipo:"venda"}),c.push({insumo_id:e.id,insumo_nome:e.nome,consumo_base:+u,unidade_base:e.unidade}),_pushVenda({produto_id:null,produto_nome:null,insumo_id:e.id,insumo_nome:e.nome,preco_venda:"normal"===a?d:0,quantidade:o,tipo:a,comentario:i,forma_pagamento:r,consumos:c,avisos:s})}const u=findProduto(t);if(!u)throw new Error("Produto não encontrado.");if(!u.preparado)throw new Error("Produto não é 'preparado'. Para itens simples, venda pelo insumo.");const m=DB.ficha[t]||[];if(!m.length)throw new Error("Produto preparado sem ficha técnica.");return m.forEach(e=>{const t=findInsumo(e.insumo_id);if(!t)return void s.push(`Insumo ${e.insumo_id} não encontrado na ficha`);const n=toBaseQty(t,(+e.quantidade||0)*o,e.unidade);if(null==n)return void s.push(`Sem conversão cadastrada de '${e.unidade}' para '${t.unidade}' para o insumo '${t.nome}'.`);const d=ensureEstoque(t.id);let a=+n;d.saldo<a-1e-9&&(s.push(`Estoque insuficiente de ${t.nome}: faltaram ${brQty3.format(a-d.saldo)} ${t.unidade}`),a=Math.max(Math.min(d.saldo,a),0)),d.saldo=Math.max(d.saldo-a,0),d.saldo<=1e-12&&(d.custoMedio=0),addMov({insumo_id:t.id,insumo_nome:t.nome,quantidade:-a,unidade:t.unidade,origem:"venda",tipo:"venda"}),c.push({insumo_id:t.id,insumo_nome:t.nome,consumo_base:+a,unidade_base:t.unidade})}),_pushVenda({produto_id:t,produto_nome:u.nome,insumo_id:null,insumo_nome:null,preco_venda:"normal"===a?d:0,quantidade:o,tipo:a,comentario:i,forma_pagamento:r,consumos:c,avisos:s})}function cancelarVenda(e,t=""){const n=(DB.vendas||[]).find(t=>+t.venda_id===+e);if(!n)throw new Error("Venda não encontrada.");if(n.cancelada)throw new Error("Venda já cancelada.");return n.cancelada=!0,n.cancel_motivo=t||"cancelamento",n.cancel_data=(new Date).toISOString(),(n.consumos||[]).forEach(e=>{const t=findInsumo(e.insumo_id),n=ensureEstoque(e.insumo_id);n.saldo+=+e.consumo_base||0,n.saldo<=1e-12&&(n.custoMedio=0),addMov({insumo_id:e.insumo_id,insumo_nome:t?.nome||"",quantidade:+(e.consumo_base||0),unidade:t?.unidade||"",origem:"cancelamento",tipo:"cancelamento"})}),{ok:!0,venda_id:n.venda_id,cancelada:!0,motivo:n.cancel_motivo,data:n.cancel_data}}function exportVendasBR(){const e=[];(DB.vendas||[]).forEach(t=>{t.consumos&&t.consumos.length?t.consumos.forEach(n=>{e.push({venda_id:t.venda_id,data:t.data,produto_nome:t.produto_nome||"",preco_venda:+t.preco_venda||0,quantidade:+(t.quantidade||0),tipo:t.tipo||"",comentario:t.comentario||"",forma_pagamento:t.forma_pagamento||"",cancelada:t.cancelada?"SIM":"NAO",insumo_nome:n.insumo_nome||"",consumo_base:+n.consumo_base||0,unidade_base:n.unidade_base||""})}):e.push({venda_id:t.venda_id,data:t.data,produto_nome:t.produto_nome||"",preco_venda:+t.preco_venda||0,quantidade:+(t.quantidade||0),tipo:t.tipo||"",comentario:t.comentario||"",forma_pagamento:t.forma_pagamento||"",cancelada:t.cancelada?"SIM":"NAO",insumo_nome:"",consumo_base:"",unidade_base:""})});const t=[["venda_id","data","produto","preco_venda","quantidade","tipo","comentario","forma_pagamento","cancelada","insumo_nome","consumo_base","unidade_base"].join(";")].concat(e.map(e=>[e.venda_id,`"${(e.data||"").toString().slice(0,10)}"`,`"${(e.produto_nome||"").replace(/"/g,'""')}"`,String((+e.preco_venda||0).toFixed(2)).replace(".",","),String(+e.quantidade||0).replace(".",","),`"${e.tipo||""}"`,`"${(e.comentario||"").replace(/"/g,'""')}"`,`"${e.forma_pagamento||""}"`,e.cancelada,`"${(e.insumo_nome||"").replace(/"/g,'""')}"`,String(""!==e.consumo_base?+e.consumo_base:"").replace(".",","),`"${e.unidade_base||""}"`].join(";"))).join("\r\n"),n=new Blob([t],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(n),d=document.createElement("a");d.href=o,d.download="vendas.csv",document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(o)}function addFornecedor(e,t){const n=nextId(DB.fornecedores);return DB.fornecedores.push({id:n,nome:String(e||"").trim(),documento:String(t||"").trim()}),n}function renderFornecedores(){const e=document.querySelector("#tblForns tbody");if(!e)return;const t=DB.fornecedores;e.innerHTML=t.length?t.map(e=>`<tr><td>${e.id}</td><td>${e.nome}</td><td>${e.documento||""}</td></tr>`).join(""):'<tr><td colspan="3" class="muted">(vazio)</td></tr>'}function addTipoDespesa(e){const t=nextId(DB.tipos);return DB.tipos.push({id:t,nome:String(e||"").trim()}),t}function renderTipos(){const e=document.querySelector("#tblTipos tbody");if(!e)return;const t=DB.tipos;e.innerHTML=t.length?t.map(e=>`<tr><td>${e.id}</td><td>${e.nome}</td></tr>`).join(""):'<tr><td colspan="2" class="muted">(vazio)</td></tr>'}function addConta(e,t){const n=nextId(DB.contas);return DB.contas.push({id:n,nome:String(e||"").trim(),tipo:String(t||"caixa").trim()}),n}function renderContas(){const e=document.querySelector("#tblContas tbody");if(!e)return;const t=DB.contas;e.innerHTML=t.length?t.map(e=>`<tr><td>${e.id}</td><td>${e.nome}</td><td>${e.tipo}</td></tr>`).join(""):'<tr><td colspan="3" class="muted">(vazio)</td></tr>'}function finPopulateSelectors(){const e=document.getElementById("pForn"),t=document.getElementById("pTipo"),n=document.getElementById("pConta");e&&(e.innerHTML='<option value="">Selecione…</option>'+DB.fornecedores.map(e=>`<option value="${e.id}">${e.id} - ${e.nome}</option>`).join("")),t&&(t.innerHTML='<option value="">Selecione…</option>'+DB.tipos.map(e=>`<option value="${e.id}">${e.id} - ${e.nome}</option>`).join("")),n&&(n.innerHTML='<option value="">Selecione…</option>'+DB.contas.map(e=>`<option value="${e.id}">${e.id} - ${e.nome} (${e.tipo})</option>`).join(""))}function addPagamento({fornecedor_id:e,tipo_id:t,conta_id:n,valor:o,dataBR:d,observacao:a}){const i=+e,r=+t,s=+n;if(!(i>0&&r>0&&s>0))throw new Error("Fornecedor/Tipo/Conta obrigatórios.");const c=+o;if(!(c>0))throw new Error("Valor deve ser > 0.");const u=brToIso(String(d||"").trim())||(new Date).toISOString().slice(0,10),m=nextId(DB.pagamentos);return DB.pagamentos.push({id:m,dataISO:u,fornecedor_id:i,tipo_id:r,conta_id:s,valor:c,observacao:String(a||"").trim()}),m}function renderPagamentos(){const e=document.querySelector("#tblPgto tbody");if(!e)return;if(!DB.pagamentos.length)return void(e.innerHTML='<tr><td colspan="7" class="muted">(vazio)</td></tr>');const t=(e,t)=>(e||[]).find(e=>+e.id===+t)||null;e.innerHTML=DB.pagamentos.map(e=>{const n=t(DB.fornecedores,e.fornecedor_id),o=t(DB.tipos,e.tipo_id),d=t(DB.contas,e.conta_id);return`\n      <tr>\n        <td>${e.id}</td>\n        <td>${isoToBr(e.dataISO)}</td>\n        <td>${n?.nome||""}</td>\n        <td>${o?.nome||""}</td>\n        <td>${d?.nome||""}</td>\n        <td>${brMoney.format(+e.valor||0)}</td>\n        <td>${e.observacao||""}</td>\n      </tr>\n    `}).join("")}function exportPagamentosBR(){const e=[["id","data","fornecedor","tipo","conta","valor","observacao"].join(";")],t=(e,t)=>(e||[]).find(e=>+e.id===+t)||null;DB.pagamentos.forEach(n=>{const o=t(DB.fornecedores,n.fornecedor_id),d=t(DB.tipos,n.tipo_id),a=t(DB.contas,n.conta_id),i=[n.id,`"${isoToBr(n.dataISO)}"`,`"${(o?.nome||"").replace(/"/g,'""')}"`,`"${(d?.nome||"").replace(/"/g,'""')}"`,`"${(a?.nome||"").replace(/"/g,'""')}"`,String((+n.valor||0).toFixed(2)).replace(".",","),`"${(n.observacao||"").replace(/"/g,'""')}"`].join(";");e.push(i)});const n=e.join("\r\n"),o=new Blob([n],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(o),a=document.createElement("a");a.href=d,a.download="pagamentos.csv",document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(d)}function relEstRows(){return(DB.insumos||[]).map(e=>{const t=DB.estoque[e.id]||{saldo:0,custoMedio:0};return{insumo_nome:e.nome,unidade:e.unidade,saldo:+t.saldo,custo_medio:+t.custoMedio}})}function renderRelEstoque(){const e=document.querySelector("#tblRelEst tbody");if(!e)return;const t=relEstRows();e.innerHTML=t.length?t.map(e=>`\n      <tr>\n        <td>${e.insumo_nome}</td>\n        <td>${e.unidade}</td>\n        <td>${brQty3.format(+e.saldo)}</td>\n        <td>${brMoney.format(+e.custo_medio||0)}</td>\n      </tr>\n    `).join(""):'<tr><td colspan="4" class="muted">(vazio)</td></tr>'}function relVendasRows({iniISO:e,fimISO:t}){const n=e?new Date(e+"T00:00:00"):null,o=t?new Date(t+"T23:59:59"):null,d=[];for(const e of DB.vendas||[]){const t=new Date(e.data);if(!(n&&t<n)&&!(o&&t>o))if(e.consumos&&e.consumos.length)for(const t of e.consumos)d.push({venda_id:e.venda_id,data:e.data,produto_nome:e.produto_nome,preco_venda:e.preco_venda,quantidade:e.quantidade,tipo:e.tipo,comentario:e.comentario,forma_pagamento:e.forma_pagamento,cancelada:e.cancelada,insumo_nome:t.insumo_nome,consumo_base:t.consumo_base,unidade_base:t.unidade_base});else d.push({venda_id:e.venda_id,data:e.data,produto_nome:e.produto_nome,preco_venda:e.preco_venda,quantidade:e.quantidade,tipo:e.tipo,comentario:e.comentario,forma_pagamento:e.forma_pagamento,cancelada:e.cancelada,insumo_nome:"",consumo_base:"",unidade_base:""})}return d}function renderRelVendas(){const e=(document.getElementById("rvIni")?.value||"").trim(),t=(document.getElementById("rvFim")?.value||"").trim(),n=relVendasRows({iniISO:brToIso(e)||void 0,fimISO:brToIso(t)||void 0}),o=document.querySelector("#tblVendas tbody");o&&(o.innerHTML=n.length?n.map(e=>`\n      <tr>\n        <td>${e.venda_id}</td>\n        <td>${isoToBr((e.data||"").toString().slice(0,10))}</td>\n        <td>${e.produto_nome||""}</td>\n        <td>${brMoney.format(+e.preco_venda||0)}</td>\n        <td>${e.quantidade??""}</td>\n        <td>${e.tipo||""}</td>\n        <td>${e.comentario||""}</td>\n        <td>${e.forma_pagamento||""}</td>\n        <td>${e.cancelada?"SIM":"NÃO"}</td>\n        <td>${[e.insumo_nome,e.consumo_base,e.unidade_base].filter(Boolean).join(" ")}</td>\n      </tr>\n    `).join(""):'<tr><td colspan="10" class="muted">(vazio)</td></tr>')}function relMovLocal({start:e,end:t}={}){const n=e?new Date(e+"T00:00:00"):null,o=t?new Date(t+"T23:59:59"):null;return(DB.movs||[]).filter(e=>{const t=new Date(e.dataISO);return(!n||t>=n)&&(!o||t<=o)})}function renderRelMov(){const e=(document.getElementById("rmi")?.value||"").trim(),t=(document.getElementById("rmf")?.value||"").trim(),n=relMovLocal({start:brToIso(e)||void 0,end:brToIso(t)||void 0}),o=document.querySelector("#tblRelMov tbody");o&&(o.innerHTML=n.length?n.map(e=>`\n      <tr>\n        <td>${e.id}</td>\n        <td>${isoToBr((e.dataISO||"").toString().slice(0,10))}</td>\n        <td>${e.insumo_nome||""}</td>\n        <td>${e.quantidade??""}</td>\n        <td>${e.unidade||""}</td>\n        <td>${brMoney.format(+e.custo_total||0)}</td>\n        <td>${e.origem||""}</td>\n        <td>${e.tipo||""}</td>\n      </tr>\n    `).join(""):'<tr><td colspan="8" class="muted">(vazio)</td></tr>')}document.getElementById("btnConvAdd")?.addEventListener("click",saveConversao),document.getElementById("btnConvList")?.addEventListener("click",listConversoes),document.getElementById("btnEntrada")?.addEventListener("click",()=>{const e=parseInt(document.getElementById("eIns")?.value||"0",10),t=parseFloat(document.getElementById("eQtd")?.value||"0"),n=parseFloat(document.getElementById("eCusto")?.value||"0");e&&t>0&&n>=0?(entradaMedia({insumo_id:e,quantidade:t,custo_total:n}),setMsg(document.getElementById("msgEnt"),"Entrada registrada!",!0),document.getElementById("eQtd").value="",document.getElementById("eCusto").value="",loadSaldos()):setMsg(document.getElementById("msgEnt"),"Preencha insumo, quantidade > 0 e custo.",!1)}),document.getElementById("btnAjuste")?.addEventListener("click",()=>{const e=parseInt(document.getElementById("aIns")?.value||"0",10),t=parseFloat(document.getElementById("aQtd")?.value||"0"),n=(document.getElementById("aMot")?.value||"").trim(),o=parseFloat(document.getElementById("aCusto")?.value||"");e&&t?(ajusteMedia({insumo_id:e,quantidade:t,motivo:n,custo_unitario:Number.isNaN(o)?void 0:o}),setMsg(document.getElementById("msgAj"),"Ajuste aplicado!",!0),document.getElementById("aQtd").value="",document.getElementById("aMot").value="",document.getElementById("aCusto").value="",loadSaldos()):setMsg(document.getElementById("msgAj"),"Preencha insumo e quantidade (pode ser negativa).",!1)}),document.getElementById("btnSaldos")?.addEventListener("click",loadSaldos),document.getElementById("btnEstoqueMediaCSV")?.addEventListener("click",exportEstoqueBR),document.addEventListener("DOMContentLoaded",()=>{loadSaldos()}),document.getElementById("btnAddForn")?.addEventListener("click",()=>{const e=document.getElementById("fForNome")?.value.trim(),t=document.getElementById("fForDoc")?.value.trim(),n=document.getElementById("msgForn");e?(addFornecedor(e,t),setMsg(n,"Fornecedor salvo!",!0),document.getElementById("fForNome").value="",document.getElementById("fForDoc").value="",renderFornecedores(),finPopulateSelectors()):setMsg(n,"Informe o nome.",!1)}),document.getElementById("btnListForn")?.addEventListener("click",renderFornecedores),document.getElementById("btnAddTipo")?.addEventListener("click",()=>{const e=document.getElementById("fTipoNome")?.value.trim(),t=document.getElementById("msgTipo");e?(addTipoDespesa(e),setMsg(t,"Tipo salvo!",!0),document.getElementById("fTipoNome").value="",renderTipos(),finPopulateSelectors()):setMsg(t,"Informe o nome.",!1)}),document.getElementById("btnListTipo")?.addEventListener("click",renderTipos),document.getElementById("btnAddConta")?.addEventListener("click",()=>{const e=document.getElementById("fContaNome")?.value.trim(),t=document.getElementById("fContaTipo")?.value.trim()||"caixa",n=document.getElementById("msgConta");e?(addConta(e,t),setMsg(n,"Conta salva!",!0),document.getElementById("fContaNome").value="",renderContas(),finPopulateSelectors()):setMsg(n,"Informe o nome.",!1)}),document.getElementById("btnListConta")?.addEventListener("click",renderContas),document.getElementById("btnAddPgto")?.addEventListener("click",()=>{const e=parseInt(document.getElementById("pForn")?.value||"0",10),t=parseInt(document.getElementById("pTipo")?.value||"0",10),n=parseInt(document.getElementById("pConta")?.value||"0",10),o=parseFloat(document.getElementById("pValor")?.value||"0"),d=(document.getElementById("pData")?.value||"").trim(),a=(document.getElementById("pObs")?.value||"").trim(),i=document.getElementById("msgPgto");try{addPagamento({fornecedor_id:e,tipo_id:t,conta_id:n,valor:o,dataBR:d,observacao:a}),setMsg(i,"Pagamento salvo!",!0),document.getElementById("pValor").value="",document.getElementById("pData").value="",document.getElementById("pObs").value="",renderPagamentos()}catch(e){setMsg(i,String(e?.message||e||"Erro ao salvar pagamento."),!1)}}),document.getElementById("btnListPgto")?.addEventListener("click",renderPagamentos),document.getElementById("btnPagamentosCSV")?.addEventListener("click",exportPagamentosBR),document.addEventListener("DOMContentLoaded",()=>{renderFornecedores(),renderTipos(),renderContas(),renderPagamentos(),DB.fornecedores.length||addFornecedor("Supermercado Central","12.345.678/0001-90"),DB.tipos.length||addTipoDespesa("Energia elétrica"),DB.contas.length||addConta("Caixa Principal","caixa"),finPopulateSelectors()}),"function"!=typeof window.exportVendasBR&&(window.exportVendasBR=function(){const e=relVendasRows({}),t=[["venda_id","data","produto","preco_venda","quantidade","tipo","comentario","forma_pagamento","cancelada","insumo_nome","consumo_base","unidade_base"].join(";")].concat(e.map(e=>[e.venda_id,`"${(e.data||"").toString().slice(0,10)}"`,`"${(e.produto_nome||"").replace(/"/g,'""')}"`,String((+e.preco_venda||0).toFixed(2)).replace(".",","),String(+e.quantidade||0).replace(".",","),`"${e.tipo||""}"`,`"${(e.comentario||"").replace(/"/g,'""')}"`,`"${e.forma_pagamento||""}"`,e.cancelada?"SIM":"NAO",`"${(e.insumo_nome||"").replace(/"/g,'""')}"`,""===e.consumo_base?"":String(+e.consumo_base).replace(".",","),`"${e.unidade_base||""}"`].join(";"))).join("\r\n"),n=new Blob([t],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(n),d=document.createElement("a");d.href=o,d.download="vendas.csv",document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(o)}),document.getElementById("btnRelEst")?.addEventListener("click",renderRelEstoque),document.getElementById("btnRelV")?.addEventListener("click",renderRelVendas),document.getElementById("btnRelMov")?.addEventListener("click",renderRelMov),document.getElementById("btnRelEstoqueCSV")?.addEventListener("click",exportEstoqueBR),document.getElementById("btnVendasCSVBR")?.addEventListener("click",window.exportVendasBR),document.addEventListener("DOMContentLoaded",()=>{renderRelEstoque(),renderRelVendas(),renderRelMov()}),function(){const e=document.getElementById("vendas");function t(){const e=document.getElementById("vProd");if(!e)return;const t=(DB.produtos||[]).filter(e=>e.preparado);e.innerHTML='<option value="">Selecione…</option>'+t.map(e=>`<option value="${e.id}">${e.id} - ${e.nome}</option>`).join("")}function n(){const e=document.getElementById("vIns");if(!e)return;const t=(DB.insumos||[]).filter(e=>e.vendivel);e.innerHTML='<option value="">Selecione…</option>'+t.map(e=>`<option value="${e.id}">${e.id} - ${e.nome} (${e.unidade})</option>`).join("")}function o(){const e=document.querySelector("#tblVendasLive tbody");if(!e)return;const t=DB.vendas||[];t.length?(e.innerHTML=t.map(e=>{const t=e.produto_nome||e.insumo_nome||"",n=(e.avisos||[]).length?e.avisos.join(" | "):"";return`\n        <tr>\n          <td>${e.venda_id}</td>\n          <td>${isoToBr((e.data||"").toString().slice(0,10))}</td>\n          <td>${t}</td>\n          <td>${e.quantidade??""}</td>\n          <td>${brMoney.format(+e.preco_venda||0)}</td>\n          <td>${e.tipo||""}</td>\n          <td>${e.forma_pagamento||""}</td>\n          <td>${e.cancelada?"SIM":"NÃO"}</td>\n          <td>${n}</td>\n          <td>\n            ${e.cancelada?"":`<button class="warning" data-cancel="${e.venda_id}">Cancelar</button>`}\n          </td>\n        </tr>\n      `}).join(""),document.querySelectorAll("[data-cancel]").forEach(e=>{e.addEventListener("click",()=>{const t=+e.getAttribute("data-cancel"),n=prompt("Motivo do cancelamento:","cliente desistiu");try{const e=window.cancelarVenda?cancelarVenda(t,n||""):{ok:!1};e&&e.ok?(o(),setMsg(document.getElementById("msgVenda"),`Venda ${t} cancelada.`,!0)):setMsg(document.getElementById("msgVenda"),`Não foi possível cancelar a venda ${t}.`,!1)}catch(e){setMsg(document.getElementById("msgVenda"),String(e?.message||e),!1)}})})):e.innerHTML='<tr><td colspan="10" class="muted">(vazio)</td></tr>'}function d(){const e=document.querySelector('input[name="vModo"]:checked')?.value||"produto";document.getElementById("boxProduto")?.classList.toggle("hide","produto"!==e),document.getElementById("boxInsumo")?.classList.toggle("hide","insumo"!==e)}e&&(e.innerHTML='\n    <h2>Vendas</h2>\n\n    <div class="card">\n      <h3>Registrar Venda</h3>\n\n      <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end;">\n        <div>\n          <label>Modo:</label>\n          <div style="display:flex; gap:10px; margin-top:4px;">\n            <label style="font-weight:600;"><input type="radio" name="vModo" value="produto" checked /> Produto preparado</label>\n            <label style="font-weight:600;"><input type="radio" name="vModo" value="insumo" /> Insumo direto</label>\n          </div>\n        </div>\n\n        <div id="boxProduto">\n          <label>Produto preparado:\n            <select id="vProd"></select>\n          </label>\n        </div>\n\n        <div id="boxInsumo" class="hide">\n          <label>Insumo (vendível):\n            <select id="vIns"></select>\n          </label>\n        </div>\n\n        <div>\n          <label>Quantidade:\n            <input id="vQtd" type="number" step="0.01" value="1" />\n          </label>\n        </div>\n\n        <div>\n          <label>Preço de venda:\n            <input id="vPreco" type="number" step="0.01" placeholder="Ex: 25.00" />\n          </label>\n        </div>\n\n        <div>\n          <label>Tipo:\n            <select id="vTipo">\n              <option value="normal">Normal</option>\n              <option value="cortesia">Cortesia</option>\n              <option value="consumo">Consumo</option>\n            </select>\n          </label>\n        </div>\n\n        <div>\n          <label>Forma de pagamento:\n            <input id="vPgto" placeholder="Ex: dinheiro, cartão" />\n          </label>\n        </div>\n\n        <div style="min-width:100%;"></div>\n\n        <div style="flex:1; min-width:320px;">\n          <label>Comentário:\n            <input id="vComent" placeholder="Obrigatório em cortesia/consumo" />\n          </label>\n        </div>\n\n        <div>\n          <button id="btnRegistrarVenda">Registrar</button>\n          <button id="btnListarVendas" class="secondary">Listar</button>\n        </div>\n      </div>\n\n      <div id="msgVenda" class="msg"></div>\n    </div>\n\n    <div class="card">\n      <h3>Vendas (Sessão atual)</h3>\n      <table id="tblVendasLive">\n        <thead>\n          <tr>\n            <th>ID</th><th>Data</th><th>Item</th><th>Qtd</th>\n            <th>Preço</th><th>Tipo</th><th>Pgto</th>\n            <th>Cancelada</th><th>Avisos</th><th>Ações</th>\n          </tr>\n        </thead>\n        <tbody>\n          <tr><td colspan="10" class="muted">(vazio)</td></tr>\n        </tbody>\n      </table>\n    </div>\n  ',document.querySelectorAll('input[name="vModo"]').forEach(e=>{e.addEventListener("change",d)}),document.getElementById("btnRegistrarVenda")?.addEventListener("click",()=>{const e=document.querySelector('input[name="vModo"]:checked')?.value||"produto",t=parseInt(document.getElementById("vProd")?.value||"0",10),n=parseInt(document.getElementById("vIns")?.value||"0",10),d=parseFloat(document.getElementById("vQtd")?.value||"0"),a=parseFloat(document.getElementById("vPreco")?.value||"0"),i=(document.getElementById("vTipo")?.value||"normal").trim(),r=(document.getElementById("vPgto")?.value||"").trim(),s=(document.getElementById("vComent")?.value||"").trim(),c=document.getElementById("msgVenda");try{if("produto"===e){if(!t)return void setMsg(c,"Selecione um produto preparado.",!1);window.registraVenda({produto_id:t,quantidade:d,preco_venda:a,tipo:i,comentario:s,forma_pagamento:r})}else{if(!n)return void setMsg(c,"Selecione um insumo vendível.",!1);window.registraVenda({insumo_id:n,quantidade:d,preco_venda:a,tipo:i,comentario:s,forma_pagamento:r})}setMsg(c,"Venda registrada!",!0),document.getElementById("vQtd").value="1",document.getElementById("vPreco").value="",document.getElementById("vComent").value="",o()}catch(e){setMsg(c,String(e?.message||e||"Erro ao registrar venda."),!1)}}),document.getElementById("btnListarVendas")?.addEventListener("click",o),document.addEventListener("DOMContentLoaded",()=>{t(),n(),d(),o();document.querySelectorAll("nav button[data-tab]").forEach(e=>{e.addEventListener("click",()=>{"vendas"===e.getAttribute("data-tab")&&(t(),n(),o())})})}))}()</script></body></html>